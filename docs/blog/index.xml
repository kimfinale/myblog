<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Disease modeling for public health</title>
<link>https://www.jonghoonk.com/blog/index.html</link>
<atom:link href="https://www.jonghoonk.com/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>Disease modeling for public health</description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Sun, 12 Oct 2025 15:00:00 GMT</lastBuildDate>
<item>
  <title>Outbreak Simulation [in progress]</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index.html</link>
  <description><![CDATA[ 



<p>We:</p>
<ol type="1">
<li><strong>Generate fake historical outbreaks</strong> (~1,000 rows) with columns <code>year</code>, <code>region</code>, <code>country</code>, <code>N_pop</code>, <code>t_peak_weeks</code>, <code>duration_weeks</code>, <code>i_peak_per_person</code>.</li>
<li>Build <strong>design matrices</strong> (splines + interactions).</li>
<li>Fit a <strong>Stan model</strong> with four linked regressions (on transformed scales) and <strong>correlated region/country random effects</strong> (multivariate for the 4 outcomes).</li>
<li><strong>Validate</strong> with posterior predictive checks.</li>
<li><strong>Simulate new outbreaks</strong> forward in order (<img src="https://latex.codecogs.com/png.latex?%5Clog%20N"> to <img src="https://latex.codecogs.com/png.latex?%5Clog%20t"> to <img src="https://latex.codecogs.com/png.latex?%5Clog%20D"> to <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Blogit%7D(i_%5Ctext%7Bpeak%7D)">).</li>
<li>Turn summaries into <strong>weekly curves</strong> (exponential or triangular) and counts using NegBin2; compare distributions to the historical-like data.</li>
</ol>
<section id="setup" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Setup</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bayesplot)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(GGally)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(splines)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># theme_set(bayesplot::theme_default())</span></span>
<span id="cb1-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_set</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>())</span>
<span id="cb1-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14">rmse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x,y) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb1-15">mae  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x,y) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y))</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NegBin2 sampler with mean mu and overdispersion phi (size = 1/phi)</span></span>
<span id="cb1-18">rnbinom_mu_phi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(n, mu, phi) {</span>
<span id="cb1-19">  size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>phi</span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> size)</span>
<span id="cb1-21">}</span></code></pre></div>
</details>
</div>
</section>
<section id="generate-fake-historical-outbreaks" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Generate Fake Historical Outbreaks</h1>
<p>Observed meta-parameters per outbreak <img src="https://latex.codecogs.com/png.latex?n%20=%201,..,%20N"></p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?N_n">: population size</li>
<li><img src="https://latex.codecogs.com/png.latex?t_n">: time to peak (weeks)</li>
<li><img src="https://latex.codecogs.com/png.latex?D_n">: duration (weeks)</li>
<li><img src="https://latex.codecogs.com/png.latex?i_n">: peak weekly incidence per person in <img src="https://latex.codecogs.com/png.latex?(0,1)"></li>
<li><img src="https://latex.codecogs.com/png.latex?y_n">: year</li>
<li><img src="https://latex.codecogs.com/png.latex?r_n%20%5Cin%20%7B1,...,R%7D">: region</li>
<li><img src="https://latex.codecogs.com/png.latex?c_n%20%5Cin%20%7B1,...,C%7D">: country (nested in region)</li>
</ul>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of regions</span></span>
<span id="cb2-2">C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># total number of countries (across all regions)</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OPTION A: Balanced (â‰ˆ C/R countries per region)</span></span>
<span id="cb2-5">build_map_balanced <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R, C) {</span>
<span id="cb2-6">  regs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(R))</span>
<span id="cb2-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split C countries across R regions as evenly as possible</span></span>
<span id="cb2-8">  sizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>(C <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> R), R)</span>
<span id="cb2-9">  sizes[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(C <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> R)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sizes[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(C <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> R)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(C)),</span>
<span id="cb2-12">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(regs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sizes)</span>
<span id="cb2-13">  )</span>
<span id="cb2-14">}</span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># OPTION B: Unbalanced (random allocation using Dirichlet weights)</span></span>
<span id="cb2-17">build_map_unbalanced <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(R, C, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">conc =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb2-18">  regs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(R))</span>
<span id="cb2-19">  w    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(R, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> conc, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) </span>
<span id="cb2-20">  w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(w)</span>
<span id="cb2-21">  sizes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> C))</span>
<span id="cb2-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fix rounding so sizes sum to C</span></span>
<span id="cb2-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sizes) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> C) {</span>
<span id="cb2-24">    i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(R), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-25">    sizes[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sizes[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sign</span>(C <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(sizes))</span>
<span id="cb2-26">  }</span>
<span id="cb2-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb2-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(C)),</span>
<span id="cb2-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(regs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> sizes)</span>
<span id="cb2-30">  )</span>
<span id="cb2-31">}</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Choose one:</span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># country_region_map &lt;- build_map_unbalanced(R, C, conc = 0.7)</span></span>
<span id="cb2-35">country_region_map <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_map_balanced</span>(R, C)</span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sanity checks</span></span>
<span id="cb2-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(</span>
<span id="cb2-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(country_region_map) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> C,</span>
<span id="cb2-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">duplicated</span>(country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country))</span>
<span id="cb2-40">)</span>
<span id="cb2-41"></span>
<span id="cb2-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count(country_region_map, region, name="countries")</span></span></code></pre></div>
</details>
</div>
<p>Modeling scales (logs and logit)</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctilde%7BN%7D_n=%5Clog%20N_n,%5Cqquad%0A%5Ctilde%7Bt%7D_n=%5Clog%20t_n,%5Cqquad%0A%5Ctilde%7BD%7D_n=%5Clog%20D_n,%5Cqquad%0A%5Ctilde%7Bi%7D_n=%5Coperatorname%7Blogit%7D(i_n)=%5Clog%5C!%5Cfrac%7Bi_n%7D%7B1-i_n%7D.%0A"></p>
<p>Sample countries and years for outbreaks</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>)</span>
<span id="cb3-2"></span>
<span id="cb3-3">n_outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb3-4">years <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2020</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample countries for each outbreak, then derive region from the map</span></span>
<span id="cb3-7">country <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(</span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country, n_outbreaks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb3-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country</span>
<span id="cb3-10">)</span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># look up region by country (nested)</span></span>
<span id="cb3-12">region <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(</span>
<span id="cb3-13">  country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region[ <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match</span>(country, country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country) ],</span>
<span id="cb3-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(country_region_map<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region)</span>
<span id="cb3-15">)</span>
<span id="cb3-16"></span>
<span id="cb3-17">year <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(years, n_outbreaks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</details>
</div>
<p>The 4-dimensional random effects at region and country levels are shared and generated using the Cholesky factor: <img src="https://latex.codecogs.com/png.latex?%0A%5CSigma_%7B%5Ctext%7Bre%7D%7D%5Cin%5Cmathbb%7BR%7D%5E%7B4%5Ctimes%204%7D,%5Cquad%20%5CSigma_%7B%5Ctext%7Bre%7D%7D%5Csucc%200,%5Cquad%0A%5CSigma_%7B%5Ctext%7Bre%7D%7D%20=%20L%20L%5E%5Ctop,%5C%20%5C%20L=%5Coperatorname%7Bchol%7D(%5CSigma_%7B%5Ctext%7Bre%7D%7D).%0A"></p>
<p>If <img src="https://latex.codecogs.com/png.latex?z%20%5Csim%20%5Cmathcal%7BN%7D(%5Cmathbf%7B0%7D,%20I_4),"> <img src="https://latex.codecogs.com/png.latex?%0Au%20=%20Lz%20%5C;%5Csim%5C;%20%5Cmathcal%7BN%7D(%5Cmathbf%7B0%7D,%20%5CSigma).%0A"></p>
<p>Why?</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Coperatorname%7BCov%7D(u)%20=%20%5Coperatorname%7BCov%7D(Lz)%20=%20L,%20%5Coperatorname%7BCov%7D(z)%5C,%20L%5E%5Ctop%20=%20L%20I_4%20L%5E%5Ctop%20=%20L%20L%5E%5Ctop%20=%20%5CSigma.%0A"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># covariance matrix for random effects across outcomes (logN, logt, logD, logit_i) </span></span>
<span id="cb4-2">Sigma_re <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb4-3">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>,</span>
<span id="cb4-4">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span>,</span>
<span id="cb4-5">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.06</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb4-6">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.04</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span></span>
<span id="cb4-7">), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb4-8"></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># verifies Sigma_re is positive definite (all eigenvalues &gt; 0), otherwise stops.</span></span>
<span id="cb4-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">eigen</span>(Sigma_re, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">symmetric =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">only.values =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>values <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cholesky decomposition</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Note that upper triangular matrix is returned from chol function, hence transpose</span></span>
<span id="cb4-13">Lre <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(Sigma_re))</span>
<span id="cb4-14"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all.equal</span>(Lre <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(Lre), Sigma_re)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(region)</span>
<span id="cb6-2">C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(country)</span>
<span id="cb6-3"></span>
<span id="cb6-4">re_region  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, R)</span>
<span id="cb6-5">re_country <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA_real_</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, C)</span>
<span id="cb6-6"></span>
<span id="cb6-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># correlated random effets via Cholesky factor</span></span>
<span id="cb6-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (r <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>R) re_region[, r] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop</span>(Lre <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb6-9"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (c <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>C) re_country[, c] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop</span>(Lre <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
</details>
</div>
<p>Year effect</p>
<p><img src="https://latex.codecogs.com/png.latex?f_%7B%5Ctext%7Byear%7D%7D(y)%5C;=%5C;0.2%5C,%5Csin%5C!%5Cleft(%5Ctfrac%7B2%5Cpi%7D%7B20%7D%5C,(y-2000)%5Cright)"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">f_year <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(y) <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sin</span>((y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>pi)</span></code></pre></div>
</details>
</div>
<p>Correlated random effect draws (simulation via Cholesky) <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbf%7Bu%7D%5E%7B(%5Cmathrm%7Breg%7D)%7D_r%20%5Csim%20%5Cmathcal%7BN%7D(%5Cmathbf%7B0%7D,%5CSigma_%7B%5Cmathrm%7Bre%7D%7D),%5Cquad%20r=1,%5Cdots,R,%0A%5Cqquad%0A%5Cmathbf%7Bu%7D%5E%7B(%5Cmathrm%7Bcty%7D)%7D_c%20%5Csim%20%5Cmathcal%7BN%7D(%5Cmathbf%7B0%7D,%5CSigma_%7B%5Cmathrm%7Bre%7D%7D),%5Cquad%20c=1,%5Cdots,C.%0A"></p>
<p>Components per outcome (ordered as: <img src="https://latex.codecogs.com/png.latex?%5Ctilde%20N,%20%5Ctilde%20t,%20%5Ctilde%20D,%20%5Ctilde%20i">) <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbf%7Bu%7D%5E%7B(%5Cmathrm%7Breg%7D)%7D_r=%5Cbegin%7Bbmatrix%7D%0Au%5E%7B(N)%7D_%7B%5Cmathrm%7Breg%7D,r%7D%5C%5C%20u%5E%7B(t)%7D_%7B%5Cmathrm%7Breg%7D,r%7D%5C%5C%20u%5E%7B(D)%7D_%7B%5Cmathrm%7Breg%7D,r%7D%5C%5C%20u%5E%7B(i)%7D_%7B%5Cmathrm%7Breg%7D,r%7D%0A%5Cend%7Bbmatrix%7D,%5Cqquad%0A%5Cmathbf%7Bu%7D%5E%7B(%5Cmathrm%7Bcty%7D)%7D_c=%5Cbegin%7Bbmatrix%7D%0Au%5E%7B(N)%7D_%7B%5Cmathrm%7Bcty%7D,c%7D%5C%5C%20u%5E%7B(t)%7D_%7B%5Cmathrm%7Bcty%7D,c%7D%5C%5C%20u%5E%7B(D)%7D_%7B%5Cmathrm%7Bcty%7D,c%7D%5C%5C%20u%5E%7B(i)%7D_%7B%5Cmathrm%7Bcty%7D,c%7D%0A%5Cend%7Bbmatrix%7D.%0A"></p>
</section>
<section id="ordered-generative-mechanism-tilde-n-to-tilde-t-to-tilde-d-to-tilde-i" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Ordered generative mechanism: <img src="https://latex.codecogs.com/png.latex?%5Ctilde%20N%20%5Cto%20%5Ctilde%20t%20%5Cto%20%5Ctilde%20D%20%5Cto%20%5Ctilde%20i"></h1>
<p>Population size, <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7BN%7D_n"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctilde%7BN%7D_n%20%5C;=%5C;%20%5Cmu_N(y_n)%5C;+%5C;u%5E%7B(N)%7D_%7B%5Cmathrm%7Breg%7D,r_n%7D%5C;+%5C;u%5E%7B(N)%7D_%7B%5Cmathrm%7Bcty%7D,c_n%7D%5C;+%5C;%5Cvarepsilon%5E%7B(N)%7D_n,%0A%5Cqquad%20%5Cvarepsilon%5E%7B(N)%7D_n%5Csim%5Cmathcal%7BN%7D(0,0.35%5E2),%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_N(y)%5C;=%5C;12%5C;+%5C;0.8%5C,f_%7B%5Ctext%7Byear%7D%7D(y).%0A"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># integer indices for fast lookup</span></span>
<span id="cb8-2">r_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(region)</span>
<span id="cb8-3">c_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(country)</span>
<span id="cb8-4"></span>
<span id="cb8-5">logN_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_year</span>(year)</span>
<span id="cb8-6">logN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> logN_mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_region[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, r_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_country[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n_outbreaks, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>)</span></code></pre></div>
</details>
</div>
<p>Time to peak (weeks), <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7Bt%7D_n"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctilde%7Bt%7D_n%20%5C;=%5C;%20%5Cmu_t(y_n,%5Ctilde%7BN%7D_n)%5C;+%5C;u%5E%7B(t)%7D_%7B%5Cmathrm%7Breg%7D,r_n%7D%5C;+%5C;u%5E%7B(t)%7D_%7B%5Cmathrm%7Bcty%7D,c_n%7D%5C;+%5C;%5Cvarepsilon%5E%7B(t)%7D_n,%0A%5Cqquad%20%5Cvarepsilon%5E%7B(t)%7D_n%5Csim%5Cmathcal%7BN%7D(0,0.25%5E2),%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_t(y,%5Ctilde%20N)%5C;=%5C;1.7%20%5C;+%5C;%200.15%5C,(%5Ctilde%20N-%5Cbar%7B%5Ctilde%20N%7D)%20%5C;+%5C;%200.6%5C,f_%7B%5Ctext%7Byear%7D%7D(y).%0A"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">logt_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logN <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logN)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_year</span>(year)</span>
<span id="cb9-2">logt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> logt_mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_region[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, r_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_country[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n_outbreaks, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span></code></pre></div>
</details>
</div>
<p>Outbreak duration (weeks), <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7BD%7D_n"> <img src="https://latex.codecogs.com/png.latex?%0A%5Ctilde%7BD%7D_n%20%5C;=%5C;%20%5Cmu_D(y_n,%5Ctilde%7BN%7D_n,%5Ctilde%7Bt%7D_n)%5C;+%5C;u%5E%7B(D)%7D_%7B%5Cmathrm%7Breg%7D,r_n%7D%5C;+%5C;u%5E%7B(D)%7D_%7B%5Cmathrm%7Bcty%7D,c_n%7D%5C;+%5C;%5Cvarepsilon%5E%7B(D)%7D_n,%0A%5Cqquad%20%5Cvarepsilon%5E%7B(D)%7D_n%5Csim%5Cmathcal%7BN%7D(0,0.25%5E2),%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_D(y,%5Ctilde%20N,%5Ctilde%20t)%5C;=%5C;2.0%20%5C;+%5C;%200.10%5C,(%5Ctilde%20N-%5Cbar%7B%5Ctilde%20N%7D)%20%5C;+%5C;%200.40%5C,(%5Ctilde%20t-%5Cbar%7B%5Ctilde%20t%7D)%20%5C;+%5C;%200.5%5C,f_%7B%5Ctext%7Byear%7D%7D(y).%0A"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">logD_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logN <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logN)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.40</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logt)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_year</span>(year)</span>
<span id="cb10-2">logD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> logD_mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_region[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, r_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_country[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, c_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n_outbreaks, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span></code></pre></div>
</details>
</div>
<p>Peak weekly incidence per person, <img src="https://latex.codecogs.com/png.latex?%5Ctilde%7Bi%7D_n"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctilde%7Bi%7D_n%20%5C;=%5C;%20%5Cmu_I(y_n,%5Ctilde%7BN%7D_n,%5Ctilde%7Bt%7D_n,%5Ctilde%7BD%7D_n)%5C;+%5C;u%5E%7B(i)%7D_%7B%5Cmathrm%7Breg%7D,r_n%7D%5C;+%5C;u%5E%7B(i)%7D_%7B%5Cmathrm%7Bcty%7D,c_n%7D%5C;+%5C;%5Cvarepsilon%5E%7B(i)%7D_n,%0A%5Cqquad%20%5Cvarepsilon%5E%7B(i)%7D_n%5Csim%5Cmathcal%7BN%7D(0,0.35%5E2),%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmu_I(y,%5Ctilde%20N,%5Ctilde%20t,%5Ctilde%20D)=%0A-6.0%20%5C;-%5C;%200.20%5C,(%5Ctilde%20N-%5Cbar%7B%5Ctilde%20N%7D)%20%5C;+%5C;%200.25%5C,(%5Ctilde%20t-%5Cbar%7B%5Ctilde%20t%7D)%20%5C;-%5C;%200.10%5C,(%5Ctilde%20D-%5Cbar%7B%5Ctilde%20D%7D)%0A%5C;+%5C;%200.4%5C,f_%7B%5Ctext%7Byear%7D%7D(y)%20%5C;+%5C;%200.12%5C,(%5Ctilde%20t-%5Cbar%7B%5Ctilde%20t%7D)%5C,(%5Ctilde%20D-%5Cbar%7B%5Ctilde%20D%7D).%0A"></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">logit_i_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">6.0</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span></span>
<span id="cb11-2">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.20</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logN <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logN)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-3">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logt)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span></span>
<span id="cb11-4">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logD <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logD)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-5">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">f_year</span>(year) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb11-6">  <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.12</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logt <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logt)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (logD <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(logD))</span>
<span id="cb11-7">logit_i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> logit_i_mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_region[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, r_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> re_country[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, c_id] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb11-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n_outbreaks, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>)</span></code></pre></div>
</details>
</div>
<p>Compact vector form $$</p>
_n=
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bbmatrix%7D%5Ctilde%20N_n%5C%5C%20%5Ctilde%20t_n%5C%5C%20%5Ctilde%20D_n%5C%5C%20%5Ctilde%20i_n%5Cend%7Bbmatrix%7D">
=
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bbmatrix%7D%0A%5Cmu_N(y_n)%5C%5C%0A%5Cmu_t(y_n,%5Ctilde%20N_n)%5C%5C%0A%5Cmu_D(y_n,%5Ctilde%20N_n,%5Ctilde%20t_n)%5C%5C%0A%5Cmu_I(y_n,%5Ctilde%20N_n,%5Ctilde%20t_n,%5Ctilde%20D_n)%0A%5Cend%7Bbmatrix%7D">
<p>^{()}_{r_n}</p>
<p>^{()}_{c_n}</p>
<p>_n, _n!(,&nbsp;(0.35<sup>2,0.25</sup>2,0.25<sup>2,0.35</sup>2)). $$</p>
<p>Back-transform</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">N_pop             <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e3</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logN)))</span>
<span id="cb12-2">t_peak_weeks      <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logt)))</span>
<span id="cb12-3">duration_weeks    <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(t_peak_weeks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logD)))</span>
<span id="cb12-4">i_peak_per_person <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(logit_i)</span>
<span id="cb12-5"></span>
<span id="cb12-6">outbk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(year, region, country, N_pop, t_peak_weeks, </span>
<span id="cb12-7">                duration_weeks, i_peak_per_person)</span>
<span id="cb12-8"></span>
<span id="cb12-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># verify nesting: every country maps to exactly one region</span></span>
<span id="cb12-10">outbk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">distinct</span>(country, region) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb12-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">count</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 Ã— 1
  `all(n == 1)`
  &lt;lgl&gt;        
1 TRUE         </code></pre>
</div>
</div>
<p>Quick sanity checks</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># basic marginals</span></span>
<span id="cb14-2">outbk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(N_pop, t_peak_weeks, duration_weeks, i_peak_per_person)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb14-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb14-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bins =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"grey70"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Marginals (nested generator)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transformed pairwise structure (clamp i âˆˆ (0,1) before qlogis)</span></span>
<span id="cb15-2">GGally<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggpairs</span>(</span>
<span id="cb15-3">  outbk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb15-4">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb15-5">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(N_pop),</span>
<span id="cb15-6">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(t_peak_weeks),</span>
<span id="cb15-7">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(duration_weeks),</span>
<span id="cb15-8">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logit_i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qlogis</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(i_peak_per_person, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>))</span>
<span id="cb15-9">    ),</span>
<span id="cb15-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transformed pairwise (nested)"</span></span>
<span id="cb15-11">)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected directionality (quick numerical checks)</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(outbk, {</span>
<span id="cb16-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cor(logN, logt)       ="</span>, </span>
<span id="cb16-4">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(N_pop), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(t_peak_weeks)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb16-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cor(logN, logD)       ="</span>, </span>
<span id="cb16-6">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(N_pop), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(duration_weeks)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb16-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cor(logN, logit(i))   ="</span>, </span>
<span id="cb16-8">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(N_pop), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qlogis</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(i_peak_per_person,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>),<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1e-6</span>))), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb16-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cor(logt, logD)       ="</span>, </span>
<span id="cb16-10">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(t_peak_weeks), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(duration_weeks)), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb16-11">})</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>cor(logN, logt)       = 0.3450293 
cor(logN, logD)       = 0.5685984 
cor(logN, logit(i))   = 0.07914388 
cor(logt, logD)       = 0.7627904 </code></pre>
</div>
</div>
<p>Back-transformations and logical bounds used in code</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AN%5E%7B%5Cmathrm%7Bsim%7D%7D_n%20%5C;=%5C;%20%5Cmax%5C!%5Cbig%5C%7B5000,%5C%20%5Clfloor%20e%5E%7B%5Ctilde%20N_n%7D%5Crceil%20%5Cbig%5C%7D,%5Cqquad%0At%5E%7B%5Cmathrm%7Bsim%7D%7D_n%20%5C;=%5C;%20%5Cmax%5C!%5Cbig%5C%7B1,%5C%20%5Clfloor%20e%5E%7B%5Ctilde%20t_n%7D%5Crceil%20%5Cbig%5C%7D,%0A"> # Estimating parameters based on the simulated data # Design Matrices (splines + interactions)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ---------- Safe helpers ----------</span></span>
<span id="cb18-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pick df safely given the number of unique x values</span></span>
<span id="cb18-3">safe_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, target_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb18-4">  nu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb18-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(min_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(target_df, nu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb18-6">}</span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># B-spline basis WITHOUT intercept, df chosen safely</span></span>
<span id="cb18-9">bs_noi_safe <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, target_df) {</span>
<span id="cb18-10">  df_use <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_df</span>(x, target_df)</span>
<span id="cb18-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> df_use, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span>
<span id="cb18-12">}</span>
<span id="cb18-13"></span>
<span id="cb18-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Safe column-wise standardization: never returns NaN (0-sd -&gt; 1)</span></span>
<span id="cb18-15">safe_scale <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M) {</span>
<span id="cb18-16">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M)</span>
<span id="cb18-17">  mu  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(M))</span>
<span id="cb18-18">  sdv <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd))</span>
<span id="cb18-19">  sdv[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(sdv) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> sdv <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb18-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(M, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sdv, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">FUN =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb18-21">}</span>
<span id="cb18-22"></span>
<span id="cb18-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Khatriâ€“Rao (column-wise Kronecker) tensor product of two bases</span></span>
<span id="cb18-24">tensor_kr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(B1, B2) {</span>
<span id="cb18-25">  B1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B1); B2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B2)</span>
<span id="cb18-26">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(B1))</span>
<span id="cb18-27">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(B1))) out[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> B2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B1[, i]</span>
<span id="cb18-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(cbind, out)</span>
<span id="cb18-29">}</span>
<span id="cb18-30"></span>
<span id="cb18-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Drop columns that are constant or have any non-finite values</span></span>
<span id="cb18-32">drop_bad_cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M) {</span>
<span id="cb18-33">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M)</span>
<span id="cb18-34">  keep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(col) {</span>
<span id="cb18-35">    ok <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(col))</span>
<span id="cb18-36">    v  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(col)</span>
<span id="cb18-37">    ok <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(v) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb18-38">  })</span>
<span id="cb18-39">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(keep)) </span>
<span id="cb18-40">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"All columns were dropped as 'bad' in a design matrix. Reduce df or check inputs."</span>)</span>
<span id="cb18-41">  M[, keep, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb18-42">}</span>
<span id="cb18-43"></span>
<span id="cb18-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Zero-variance checker that treats NA as 0-variance (to be safe)</span></span>
<span id="cb18-45">has_zero_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M) {</span>
<span id="cb18-46">  s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd))</span>
<span id="cb18-47">  s[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(s)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb18-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb18-49">}</span>
<span id="cb18-50"></span>
<span id="cb18-51">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> outbk <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb18-52">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(</span>
<span id="cb18-53">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year    =</span> year,</span>
<span id="cb18-54">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region  =</span> region, </span>
<span id="cb18-55">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> country,</span>
<span id="cb18-56">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN    =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(N_pop),</span>
<span id="cb18-57">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt    =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(t_peak_weeks),</span>
<span id="cb18-58">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD    =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(duration_weeks),</span>
<span id="cb18-59">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logit_i =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qlogis</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(i_peak_per_person, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>))</span>
<span id="cb18-60">  )</span>
<span id="cb18-61"></span>
<span id="cb18-62"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Expect df tibble is already defined from your fake data step:</span></span>
<span id="cb18-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># df has: year (numeric), region (factor), country (factor),</span></span>
<span id="cb18-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         logN, logt, logD, logit_i (numeric)</span></span>
<span id="cb18-65"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"year"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"region"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"country"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logN"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logt"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logD"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit_i"</span>) </span>
<span id="cb18-66">              <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(df)))</span>
<span id="cb18-67"></span>
<span id="cb18-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Center/scale the continuous predictors used as raw columns</span></span>
<span id="cb18-69">x_logN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN))</span>
<span id="cb18-70">x_logt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt))</span>
<span id="cb18-71">x_logD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD))</span>
<span id="cb18-72"></span>
<span id="cb18-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- p(logN) : splines of year only ---</span></span>
<span id="cb18-74">B_year_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb18-75">B_year_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_year_N)</span>
<span id="cb18-76">XN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_scale</span>(B_year_N))</span>
<span id="cb18-77"></span>
<span id="cb18-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- p(logt | logN, year) ---</span></span>
<span id="cb18-79">B_year_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb18-80">B_year_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_year_t)</span>
<span id="cb18-81">Xt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_scale</span>(B_year_t), x_logN)</span>
<span id="cb18-82"></span>
<span id="cb18-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- p(logD | logN, logt, year) ---</span></span>
<span id="cb18-84">B_year_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb18-85">B_year_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_year_D)</span>
<span id="cb18-86">XD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_scale</span>(B_year_D), x_logN, x_logt)</span>
<span id="cb18-87"></span>
<span id="cb18-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- p(logit(i) | logN, logt, logD, year) + tensor(logt, logD) ---</span></span>
<span id="cb18-89">B_year_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb18-90">B_logt   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb18-91">B_logD   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_noi_safe</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">target_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb18-92"></span>
<span id="cb18-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clean bases before tensor/scaling</span></span>
<span id="cb18-94">B_year_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_year_I)</span>
<span id="cb18-95">B_logt   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_logt)</span>
<span id="cb18-96">B_logD   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(B_logD)</span>
<span id="cb18-97"></span>
<span id="cb18-98">tensor_tD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensor_kr</span>(B_logt, B_logD)</span>
<span id="cb18-99">tensor_tD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">drop_bad_cols</span>(tensor_tD)</span>
<span id="cb18-100"></span>
<span id="cb18-101">XI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(</span>
<span id="cb18-102">  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb18-103">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_scale</span>(B_year_I),</span>
<span id="cb18-104">  x_logN,</span>
<span id="cb18-105">  x_logt,</span>
<span id="cb18-106">  x_logD,                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vector (scaled logD)</span></span>
<span id="cb18-107">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_scale</span>(tensor_tD)</span>
<span id="cb18-108">)</span>
<span id="cb18-109"></span>
<span id="cb18-110"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ---------- Diagnostics before Stan ----------</span></span>
<span id="cb18-111"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Design matrix dimensions:</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Design matrix dimensions:</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  XN:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(XN), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  XN: 1000 9 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  Xt:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(Xt), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  Xt: 1000 10 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  XD:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(XD), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  XD: 1000 11 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"  XI:"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dim</span>(XI), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  XI: 1000 47 </code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(</span>
<span id="cb28-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(XN)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(Xt)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(XD)), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(XI)),</span>
<span id="cb28-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(XN) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(Xt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(XD) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(XI) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df)</span>
<span id="cb28-4">)</span>
<span id="cb28-5"></span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace the old helper with this:</span></span>
<span id="cb28-8">has_zero_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb28-9">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M)</span>
<span id="cb28-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb28-11">  cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (intercept <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M)</span>
<span id="cb28-12">  s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M[, cols, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd))</span>
<span id="cb28-13">  s[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(s)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb28-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb28-15">}</span>
<span id="cb28-16"></span>
<span id="cb28-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optional: a verbose variant to see which columns (excluding intercept) are constant</span></span>
<span id="cb28-18">report_zero_var <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">name =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb28-19">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M)</span>
<span id="cb28-20">  cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (intercept <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(M)</span>
<span id="cb28-21">  s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">suppressWarnings</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M[, cols, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd))</span>
<span id="cb28-22">  s[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(s)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb28-23">  bad <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which</span>(s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb28-24">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(bad)) {</span>
<span id="cb28-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%s zero-variance (excluding intercept): %s"</span>, name,</span>
<span id="cb28-26">                    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste</span>(cols[bad], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">collapse =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", "</span>)))</span>
<span id="cb28-27">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb28-28">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">message</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%s: no zero-variance columns (excluding intercept)."</span>, name))</span>
<span id="cb28-29">  }</span>
<span id="cb28-30">}</span>
<span id="cb28-31"></span>
<span id="cb28-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Re-run the checks (these should pass now if only the intercept was constant)</span></span>
<span id="cb28-33"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">has_zero_var</span>(XN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) </span>
<span id="cb28-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XN has zero-variance columns (excluding intercept)."</span>)</span>
<span id="cb28-35"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">has_zero_var</span>(Xt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) </span>
<span id="cb28-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Xt has zero-variance columns (excluding intercept)."</span>)</span>
<span id="cb28-37"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">has_zero_var</span>(XD, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) </span>
<span id="cb28-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XD has zero-variance columns (excluding intercept)."</span>)</span>
<span id="cb28-39"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">has_zero_var</span>(XI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)) </span>
<span id="cb28-40">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XI has zero-variance columns (excluding intercept)."</span>)</span>
<span id="cb28-41"></span>
<span id="cb28-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (Optional) print details</span></span>
<span id="cb28-43"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">report_zero_var</span>(XN, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XN"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb28-44"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">report_zero_var</span>(Xt, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Xt"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb28-45"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">report_zero_var</span>(XD, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XD"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb28-46"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">report_zero_var</span>(XI, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"XI"</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb28-47"></span>
<span id="cb28-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># IDs &amp; sizes</span></span>
<span id="cb28-49">N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df)</span>
<span id="cb28-50">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region)</span>
<span id="cb28-51">C <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country)</span>
<span id="cb28-52">region_id  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region)</span>
<span id="cb28-53">country_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country)</span>
<span id="cb28-54"></span>
<span id="cb28-55">pN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(XN); pt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(Xt); pD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(XD); pI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(XI)</span>
<span id="cb28-56"></span>
<span id="cb28-57">stan_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb28-58">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> N, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R =</span> R, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">C =</span> C,</span>
<span id="cb28-59">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region_id =</span> region_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country_id =</span> country_id,</span>
<span id="cb28-60">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_logN =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_logt =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_logD =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_logiti =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logit_i,</span>
<span id="cb28-61">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pN =</span> pN, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XN =</span> XN,</span>
<span id="cb28-62">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pt =</span> pt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Xt =</span> Xt,</span>
<span id="cb28-63">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pD =</span> pD, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XD =</span> XD,</span>
<span id="cb28-64">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pI =</span> pI, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XI =</span> XI</span>
<span id="cb28-65">)</span>
<span id="cb28-66"></span>
<span id="cb28-67"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(XN))),</span>
<span id="cb28-68">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(Xt))),</span>
<span id="cb28-69">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(XD))),</span>
<span id="cb28-70">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(XI))))</span>
<span id="cb28-71"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)), </span>
<span id="cb28-72">          <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD)), <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.na</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logit_i)))</span>
<span id="cb28-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># no zero-variance columns</span></span>
<span id="cb28-74"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XN=</span>XN,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Xt=</span>Xt,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XD=</span>XD,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">XI=</span>XI), \(M) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">any</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,sd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  XN   Xt   XD   XI 
TRUE TRUE TRUE TRUE </code></pre>
</div>
</div>
</section>
<section id="stan-model-and-fit" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Stan model and fit</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ---------- Fit the simpler diagonal-RE Stan model ----------</span></span>
<span id="cb30-2">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb30-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb30-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; N;</span></span>
<span id="cb30-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; R;</span></span>
<span id="cb30-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; C;</span></span>
<span id="cb30-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1, upper=R&gt; region_id[N];</span></span>
<span id="cb30-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1, upper=C&gt; country_id[N];</span></span>
<span id="cb30-9"></span>
<span id="cb30-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logN;</span></span>
<span id="cb30-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logt;</span></span>
<span id="cb30-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logD;</span></span>
<span id="cb30-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logiti;</span></span>
<span id="cb30-14"></span>
<span id="cb30-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; pN; matrix[N, pN] XN;</span></span>
<span id="cb30-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; pt; matrix[N, pt] Xt;</span></span>
<span id="cb30-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; pD; matrix[N, pD] XD;</span></span>
<span id="cb30-18"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; pI; matrix[N, pI] XI;</span></span>
<span id="cb30-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb30-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[pN] beta_N;</span></span>
<span id="cb30-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[pt] beta_t;</span></span>
<span id="cb30-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[pD] beta_D;</span></span>
<span id="cb30-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[pI] beta_I;</span></span>
<span id="cb30-25"></span>
<span id="cb30-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_N;</span></span>
<span id="cb30-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_t;</span></span>
<span id="cb30-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_D;</span></span>
<span id="cb30-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_I;</span></span>
<span id="cb30-30"></span>
<span id="cb30-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[4] tau_reg;</span></span>
<span id="cb30-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  cholesky_factor_corr[4] Lcorr_reg;</span></span>
<span id="cb30-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4, R] z_reg;</span></span>
<span id="cb30-34"></span>
<span id="cb30-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[4] tau_cty;</span></span>
<span id="cb30-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  cholesky_factor_corr[4] Lcorr_cty;</span></span>
<span id="cb30-37"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4, C] z_cty;</span></span>
<span id="cb30-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb30-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4, R] u_reg;</span></span>
<span id="cb30-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4, C] u_cty;</span></span>
<span id="cb30-42"></span>
<span id="cb30-43"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4,4] L_reg = diag_pre_multiply(tau_reg, Lcorr_reg);</span></span>
<span id="cb30-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  matrix[4,4] L_cty = diag_pre_multiply(tau_cty, Lcorr_cty);</span></span>
<span id="cb30-45"></span>
<span id="cb30-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  u_reg = L_reg * z_reg;</span></span>
<span id="cb30-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  u_cty = L_cty * z_cty;</span></span>
<span id="cb30-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb30-50"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta_N ~ normal(0, 1.5);</span></span>
<span id="cb30-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta_t ~ normal(0, 1.5);</span></span>
<span id="cb30-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta_D ~ normal(0, 1.5);</span></span>
<span id="cb30-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  beta_I ~ normal(0, 1.5);</span></span>
<span id="cb30-54"></span>
<span id="cb30-55"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_N ~ normal(0, 1);</span></span>
<span id="cb30-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_t ~ normal(0, 1);</span></span>
<span id="cb30-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_D ~ normal(0, 1);</span></span>
<span id="cb30-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_I ~ normal(0, 1);</span></span>
<span id="cb30-59"></span>
<span id="cb30-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  tau_reg ~ normal(0, 1);</span></span>
<span id="cb30-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  tau_cty ~ normal(0, 1);</span></span>
<span id="cb30-62"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  Lcorr_reg ~ lkj_corr_cholesky(2);</span></span>
<span id="cb30-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  Lcorr_cty ~ lkj_corr_cholesky(2);</span></span>
<span id="cb30-64"></span>
<span id="cb30-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  to_vector(z_reg) ~ normal(0, 1);</span></span>
<span id="cb30-66"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  to_vector(z_cty) ~ normal(0, 1);</span></span>
<span id="cb30-67"></span>
<span id="cb30-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (n in 1:N) {</span></span>
<span id="cb30-69"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = region_id[n];</span></span>
<span id="cb30-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = country_id[n];</span></span>
<span id="cb30-71"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aN = u_reg[1, r] + u_cty[1, c];</span></span>
<span id="cb30-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real at = u_reg[2, r] + u_cty[2, c];</span></span>
<span id="cb30-73"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aD = u_reg[3, r] + u_cty[3, c];</span></span>
<span id="cb30-74"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aI = u_reg[4, r] + u_cty[4, c];</span></span>
<span id="cb30-75"></span>
<span id="cb30-76"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logN[n]   ~ normal( XN[n] * beta_N + aN, sigma_N );</span></span>
<span id="cb30-77"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logt[n]   ~ normal( Xt[n] * beta_t + at, sigma_t );</span></span>
<span id="cb30-78"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logD[n]   ~ normal( XD[n] * beta_D + aD, sigma_D );</span></span>
<span id="cb30-79"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logiti[n] ~ normal( XI[n] * beta_I + aI, sigma_I );</span></span>
<span id="cb30-80"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb30-81"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-82"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">generated quantities {</span></span>
<span id="cb30-83"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logN_rep;</span></span>
<span id="cb30-84"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logt_rep;</span></span>
<span id="cb30-85"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logD_rep;</span></span>
<span id="cb30-86"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[N] y_logiti_rep;</span></span>
<span id="cb30-87"></span>
<span id="cb30-88"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  corr_matrix[4] Omega_reg = multiply_lower_tri_self_transpose(Lcorr_reg);</span></span>
<span id="cb30-89"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  corr_matrix[4] Omega_cty = multiply_lower_tri_self_transpose(Lcorr_cty);</span></span>
<span id="cb30-90"></span>
<span id="cb30-91"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (n in 1:N) {</span></span>
<span id="cb30-92"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int r = region_id[n];</span></span>
<span id="cb30-93"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int c = country_id[n];</span></span>
<span id="cb30-94"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aN = u_reg[1, r] + u_cty[1, c];</span></span>
<span id="cb30-95"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real at = u_reg[2, r] + u_cty[2, c];</span></span>
<span id="cb30-96"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aD = u_reg[3, r] + u_cty[3, c];</span></span>
<span id="cb30-97"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real aI = u_reg[4, r] + u_cty[4, c];</span></span>
<span id="cb30-98"></span>
<span id="cb30-99"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logN_rep[n]   = normal_rng( XN[n] * beta_N + aN, sigma_N );</span></span>
<span id="cb30-100"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logt_rep[n]   = normal_rng( Xt[n] * beta_t + at, sigma_t );</span></span>
<span id="cb30-101"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logD_rep[n]   = normal_rng( XD[n] * beta_D + aD, sigma_D );</span></span>
<span id="cb30-102"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    y_logiti_rep[n] = normal_rng( XI[n] * beta_I + aI, sigma_I );</span></span>
<span id="cb30-103"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb30-104"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb30-105"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb30-106"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeLines</span>(stan_code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ordered_conditional_plain_diagRE.stan"</span>)</span>
<span id="cb30-107"></span>
<span id="cb30-108"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">file.exists</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ordered_conditional_plain_diagRE.stan"</span>))</span>
<span id="cb30-109"></span>
<span id="cb30-110"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb30-111"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb30-112"></span>
<span id="cb30-113"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>)</span>
<span id="cb30-114">mod_diag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ordered_conditional_plain_diagRE.stan"</span>)</span>
<span id="cb30-115">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(</span>
<span id="cb30-116">  mod_diag, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stan_data,</span>
<span id="cb30-117">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1500</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">thin =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">init =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb30-118">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_treedepth =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">stepsize =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),</span>
<span id="cb30-119">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">refresh =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb30-120">)</span>
<span id="cb30-121"></span>
<span id="cb30-122"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma_N"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma_t"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma_D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma_I"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tau_reg"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tau_cty"</span>))</span>
<span id="cb30-123">rstan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">check_hmc_diagnostics</span>(fit)</span>
<span id="cb30-124"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit_20251013.rds"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="posterior-predictive-checks" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Posterior Predictive Checks</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- VISUALIZING MODEL PREDICTED VS DATA (PPCs &amp; CALIBRATION) ---</span></span>
<span id="cb31-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">read_rds</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C:/Users/jonghoon.kim/Workspace/myblog/fit_20251013.rds"</span>)</span>
<span id="cb31-3"></span>
<span id="cb31-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0) sanity: fit exists and has samples?</span></span>
<span id="cb31-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"stanfit"</span>))</span>
<span id="cb31-6">draws_mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit)</span>
<span id="cb31-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(draws_mat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb31-8"></span>
<span id="cb31-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) robust y_rep extractors (works whether rstan::extract or as.matrix route is needed)</span></span>
<span id="cb31-10">grab_yrep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(fit, base, Nobs) {</span>
<span id="cb31-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># try extract first</span></span>
<span id="cb31-12">  ex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">try</span>(rstan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> base, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">permuted =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">silent =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb31-13">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inherits</span>(ex, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"try-error"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.list</span>(ex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(ex) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> 1L) {</span>
<span id="cb31-14">    Y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb31-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(Y)) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(Y)</span>
<span id="cb31-16">  }</span>
<span id="cb31-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fallback to as.matrix() column pattern</span></span>
<span id="cb31-18">  dm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit)</span>
<span id="cb31-19">  cols <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^"</span>, base, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">["</span>), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colnames</span>(dm), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb31-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(cols) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> Nobs)</span>
<span id="cb31-21">  dm[, cols, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb31-22">}</span>
<span id="cb31-23"></span>
<span id="cb31-24">Nobs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df)</span>
<span id="cb31-25">yrep_logN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grab_yrep</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_logN_rep"</span>,   Nobs)</span>
<span id="cb31-26">yrep_logt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grab_yrep</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_logt_rep"</span>,   Nobs)</span>
<span id="cb31-27">yrep_logD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grab_yrep</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_logD_rep"</span>,   Nobs)</span>
<span id="cb31-28">yrep_logi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grab_yrep</span>(fit, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y_logiti_rep"</span>, Nobs)</span>
<span id="cb31-29"></span>
<span id="cb31-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># thin draws for plots (keep matrix shape)</span></span>
<span id="cb31-31">thin_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(yrep_logN)))</span>
<span id="cb31-32">Yreps <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-33">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN   =</span> yrep_logN[thin_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>],</span>
<span id="cb31-34">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt   =</span> yrep_logt[thin_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>],</span>
<span id="cb31-35">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD   =</span> yrep_logD[thin_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>],</span>
<span id="cb31-36">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logiti =</span> yrep_logi[thin_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb31-37">)</span>
<span id="cb31-38"></span>
<span id="cb31-39">Yobs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb31-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN   =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,</span>
<span id="cb31-41">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt   =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,</span>
<span id="cb31-42">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD   =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,</span>
<span id="cb31-43">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logiti =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logit_i</span>
<span id="cb31-44">)</span>
<span id="cb31-45"></span>
<span id="cb31-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) classic PPC overlays (model scales)</span></span>
<span id="cb31-47"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb31-48">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: logN (density)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb32-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: log t_peak (density)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb33-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: log duration (density)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-3.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb34-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: logit i_peak (density)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-4.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_ecdf_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb35-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: logN (ECDF)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-5.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_ecdf_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb36-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: log t_peak (ECDF)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-6.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_ecdf_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb37-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: log duration (ECDF)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-7.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_ecdf_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb38-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"PPC: logit i_peak (ECDF)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-8.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) observed vs posterior predictive mean + 95% PI (model scales)</span></span>
<span id="cb39-2">summ_one <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(yrep, yobs, label) {</span>
<span id="cb39-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb39-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(yobs),</span>
<span id="cb39-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(yrep),</span>
<span id="cb39-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lo =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(yrep, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>),</span>
<span id="cb39-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hi =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(yrep, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>),</span>
<span id="cb39-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> label,</span>
<span id="cb39-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">idx =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(yobs)</span>
<span id="cb39-10">  )</span>
<span id="cb39-11">}</span>
<span id="cb39-12"></span>
<span id="cb39-13">summ_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb39-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summ_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logN"</span>),</span>
<span id="cb39-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summ_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logt"</span>),</span>
<span id="cb39-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summ_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logD"</span>),</span>
<span id="cb39-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summ_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit_i"</span>)</span>
<span id="cb39-18">)</span>
<span id="cb39-19"></span>
<span id="cb39-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(summ_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> obs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> hi), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-23">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-24">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed vs Posterior Predictive Mean (95% PI) â€” model scales"</span>,</span>
<span id="cb39-26">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior predictive mean"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb39-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-9.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4) coverage / calibration (model scales)</span></span>
<span id="cb40-2">coverage_one <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(yrep, yobs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)) {</span>
<span id="cb40-3">  qs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(yrep, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs =</span> probs))</span>
<span id="cb40-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb40-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p10 =</span> qs[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p50 =</span> qs[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p90 =</span> qs[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>],</span>
<span id="cb40-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> yobs</span>
<span id="cb40-7">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb40-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb40-9">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cover80 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(obs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> p10 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> obs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> p90),</span>
<span id="cb40-10">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rmse =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((obs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p50)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)),</span>
<span id="cb40-11">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mae  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(obs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p50))</span>
<span id="cb40-12">    )</span>
<span id="cb40-13">}</span>
<span id="cb40-14">calib_tbl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb40-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coverage_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logN"</span>),</span>
<span id="cb40-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coverage_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logt"</span>),</span>
<span id="cb40-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coverage_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logD"</span>),</span>
<span id="cb40-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coverage_one</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"logit_i"</span>)</span>
<span id="cb40-19">)</span>
<span id="cb40-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(calib_tbl)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 Ã— 4
  cover80  rmse   mae var    
    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
1   0.818 0.332 0.262 logN   
2   0.809 0.256 0.203 logt   
3   0.812 0.197 0.149 logD   
4   0.832 0.355 0.284 logit_i</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expect cover80 â‰ˆ 0.8 if intervals are well-calibrated</span></span>
<span id="cb42-2"></span>
<span id="cb42-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5) natural-scale comparisons (histograms/densities)</span></span>
<span id="cb42-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># transform reps to natural scales</span></span>
<span id="cb42-5">inv_logit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x))</span>
<span id="cb42-6"></span>
<span id="cb42-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pick a small set of draws to avoid memory blow-ups when back-transforming</span></span>
<span id="cb42-8">bt_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(yrep_logN)))</span>
<span id="cb42-9"></span>
<span id="cb42-10">bt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb42-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(yrep_logN[bt_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb42-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(yrep_logt[bt_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb42-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(yrep_logD[bt_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb42-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv_logit</span>(yrep_logi[bt_idx, , <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>])</span>
<span id="cb42-15">)</span>
<span id="cb42-16"></span>
<span id="cb42-17">obs_nat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb42-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN),</span>
<span id="cb42-19">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt),</span>
<span id="cb42-20">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD),</span>
<span id="cb42-21">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inv_logit</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logit_i)</span>
<span id="cb42-22">)</span>
<span id="cb42-23"></span>
<span id="cb42-24">dens_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(mat, label) {</span>
<span id="cb42-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(mat)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">draw =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(mat)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">each =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(mat))) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb42-26">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"simulated"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> label)</span>
<span id="cb42-27">}</span>
<span id="cb42-28"></span>
<span id="cb42-29">obs_long  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(vec, label) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value =</span> vec, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"observed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">var =</span> label)</span>
<span id="cb42-30"></span>
<span id="cb42-31">nat_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb42-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dens_long</span>(bt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N_pop,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N_pop"</span>),</span>
<span id="cb42-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dens_long</span>(bt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_weeks, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t_peak_weeks"</span>),</span>
<span id="cb42-34">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dens_long</span>(bt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D_weeks, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_weeks"</span>),</span>
<span id="cb42-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dens_long</span>(bt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_peak,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i_peak_per_person"</span>),</span>
<span id="cb42-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_long</span>(obs_nat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N_pop,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N_pop"</span>),</span>
<span id="cb42-37">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_long</span>(obs_nat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_weeks, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t_peak_weeks"</span>),</span>
<span id="cb42-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_long</span>(obs_nat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D_weeks, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_weeks"</span>),</span>
<span id="cb42-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">obs_long</span>(obs_nat<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_peak,  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i_peak_per_person"</span>)</span>
<span id="cb42-40">)</span>
<span id="cb42-41"></span>
<span id="cb42-42"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(nat_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> source)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb42-43">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb42-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb42-45">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed vs Posterior Predictive â€” natural scales"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb42-46">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-10.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 6) grouped PPCs (optional): by region or by coarse year bins</span></span>
<span id="cb43-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># useful to spot misfit in subgroups</span></span>
<span id="cb43-3">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year_bin <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cut</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">breaks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2005</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2010</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2015</span>, <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">Inf</span>),</span>
<span id="cb43-4">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"â‰¤2005"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2006â€“2010"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2011â€“2015"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"â‰¥2016"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">right =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb43-5"></span>
<span id="cb43-6">ppc_by_group <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(yrep, yobs, group, title) {</span>
<span id="cb43-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute groupwise observed vs predictive mean with intervals</span></span>
<span id="cb43-8">  pred_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(yrep)</span>
<span id="cb43-9">  pred_lo   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(yrep, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb43-10">  pred_hi   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(yrep, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, quantile, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb43-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs =</span> yobs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> pred_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lo =</span> pred_lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hi =</span> pred_hi, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grp =</span> group) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb43-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(grp) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb43-13">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb43-14">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">obs_mean  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(obs),</span>
<span id="cb43-15">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred_mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(mean),</span>
<span id="cb43-16">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred_lo   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(lo),</span>
<span id="cb43-17">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pred_hi   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(hi),</span>
<span id="cb43-18">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span></span>
<span id="cb43-19">    ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb43-20">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> obs_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> pred_mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-21">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">slope =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-22">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_errorbar</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> pred_lo, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> pred_hi), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">width =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-23">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-24">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> title, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed group mean"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted group mean"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb43-25">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span>
<span id="cb43-26">}</span>
<span id="cb43-27"></span>
<span id="cb43-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   </span>
<span id="cb43-29">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: logN by region"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-11.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   </span>
<span id="cb44-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: log t by region"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-12.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   </span>
<span id="cb45-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: log duration by region"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-13.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, </span>
<span id="cb46-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region,   <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: logit i by region"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-14.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN,   </span>
<span id="cb47-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year_bin, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: logN by year bin"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-15.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt,   </span>
<span id="cb48-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year_bin, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: log t by year bin"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-16.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD,   </span>
<span id="cb49-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year_bin, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: log duration by year bin"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-17.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_by_group</span>(Yreps<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, Yobs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logiti, </span>
<span id="cb50-2">             df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year_bin, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Group PPC: logit i by year bin"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-14-18.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="forward-simulation-in-your-modeling-order" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Forward Simulation in Your Modeling Order</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- store training specs to reproduce design rows at prediction time ----</span></span>
<span id="cb51-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper: capture basis attributes + column means/sds used for scaling</span></span>
<span id="cb51-3">capture_bs_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(B_train) {</span>
<span id="cb51-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb51-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">degree         =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(B_train, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"degree"</span>),</span>
<span id="cb51-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">knots          =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(B_train, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"knots"</span>),</span>
<span id="cb51-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Boundary.knots =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(B_train, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Boundary.knots"</span>),</span>
<span id="cb51-8">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B_train)),</span>
<span id="cb51-9">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B_train), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd)</span>
<span id="cb51-10">  )</span>
<span id="cb51-11">}</span>
<span id="cb51-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># safe scaling using training mu/sd (0-sd -&gt; 1)</span></span>
<span id="cb51-13">scale_with <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M, mu, sd) {</span>
<span id="cb51-14">  sd2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sd; sd2[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(sd2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> sd2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb51-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mu, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb51-16">}</span>
<span id="cb51-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rebuild a bs basis using training attributes</span></span>
<span id="cb51-18">bs_from_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x_new, spec) {</span>
<span id="cb51-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(splines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs</span>(x_new,</span>
<span id="cb51-20">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">degree =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>degree,</span>
<span id="cb51-21">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">knots =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>knots,</span>
<span id="cb51-22">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Boundary.knots =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Boundary.knots,</span>
<span id="cb51-23">                        <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>))</span>
<span id="cb51-24">}</span>
<span id="cb51-25"></span>
<span id="cb51-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># capture specs for the bases used in each equation (POST-cleaning, PRE-scaling)</span></span>
<span id="cb51-27">spec_year_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_N)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in XN (after drop_bad, before scaling)</span></span>
<span id="cb51-28">spec_year_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_t)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in Xt</span></span>
<span id="cb51-29">spec_year_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_D)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in XD</span></span>
<span id="cb51-30">spec_year_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_I)   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in XI (year block)</span></span>
<span id="cb51-31"></span>
<span id="cb51-32">spec_logt   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_logt)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in XI tensor</span></span>
<span id="cb51-33">spec_logD   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_logD)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used in XI tensor</span></span>
<span id="cb51-34"></span>
<span id="cb51-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tensor spec: store column means/sds AFTER building tensor on training</span></span>
<span id="cb51-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (weâ€™ll rebuild the tensor from the two bases at prediction time, then scale with these)</span></span>
<span id="cb51-37">tensor_train   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensor_kr</span>(B_logt, B_logD)</span>
<span id="cb51-38">spec_tensor_tD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb51-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(tensor_train),</span>
<span id="cb51-40">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(tensor_train, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd)</span>
<span id="cb51-41">)</span>
<span id="cb51-42"></span>
<span id="cb51-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># training means/sds for the centered â€œrawâ€ covariates you used (x_logN, x_logt, x_logD)</span></span>
<span id="cb51-44">center_sd_cont <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb51-45">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)),</span>
<span id="cb51-46">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)),</span>
<span id="cb51-47">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD))</span>
<span id="cb51-48">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- extract posterior draws (arrays) ----</span></span>
<span id="cb52-2">ex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rstan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">permuted =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb52-3"></span>
<span id="cb52-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fixed effects</span></span>
<span id="cb52-5">beta_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta_N  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draws Ã— pN</span></span>
<span id="cb52-6">beta_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta_t  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draws Ã— pt</span></span>
<span id="cb52-7">beta_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta_D  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draws Ã— pD</span></span>
<span id="cb52-8">beta_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>beta_I  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draws Ã— pI</span></span>
<span id="cb52-9"></span>
<span id="cb52-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># residual SDs</span></span>
<span id="cb52-11">sigma_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_N  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draws</span></span>
<span id="cb52-12">sigma_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_t</span>
<span id="cb52-13">sigma_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_D</span>
<span id="cb52-14">sigma_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_I</span>
<span id="cb52-15"></span>
<span id="cb52-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># random effects (from transformed parameters)</span></span>
<span id="cb52-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># u_reg: draws Ã— 4 Ã— R; u_cty: draws Ã— 4 Ã— C</span></span>
<span id="cb52-18">u_reg <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>u_reg</span>
<span id="cb52-19">u_cty <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ex<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>u_cty</span>
<span id="cb52-20"></span>
<span id="cb52-21">n_draws <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(beta_N)</span>
<span id="cb52-22"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(n_draws <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- utilities for capturing &amp; rebuilding spline/tensor blocks ---</span></span>
<span id="cb53-2"></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># which columns to keep (finite &amp; non-constant)</span></span>
<span id="cb53-4">keep_idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M) {</span>
<span id="cb53-5">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M)</span>
<span id="cb53-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(col) {</span>
<span id="cb53-7">    ok <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(col)); v <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(col)</span>
<span id="cb53-8">    ok <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(v) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> v <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb53-9">  })</span>
<span id="cb53-10">}</span>
<span id="cb53-11"></span>
<span id="cb53-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># build raw bs (with attributes intact) using *safe* df</span></span>
<span id="cb53-13">safe_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, target_df, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">min_df =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb53-14">  nu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unique</span>(x))</span>
<span id="cb53-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(min_df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(target_df, nu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb53-16">}</span>
<span id="cb53-17"></span>
<span id="cb53-18">build_bs_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, target_df) {</span>
<span id="cb53-19">  df_use <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">safe_df</span>(x, target_df)</span>
<span id="cb53-20">  splines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">df =</span> df_use, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># returns a "bs" object with attrs</span></span>
<span id="cb53-21">}</span>
<span id="cb53-22"></span>
<span id="cb53-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># capture *full* spec: attrs + kept columns + scaling stats</span></span>
<span id="cb53-24">capture_bs_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(bs_obj) {</span>
<span id="cb53-25">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(bs_obj)</span>
<span id="cb53-26">  keep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">keep_idx</span>(M)</span>
<span id="cb53-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb53-28">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">degree         =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(bs_obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"degree"</span>),</span>
<span id="cb53-29">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">knots          =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(bs_obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"knots"</span>),</span>
<span id="cb53-30">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Boundary.knots =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">attr</span>(bs_obj, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Boundary.knots"</span>),</span>
<span id="cb53-31">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keep           =</span> keep,</span>
<span id="cb53-32">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(M[, keep, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb53-33">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(M[, keep, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd)</span>
<span id="cb53-34">  )</span>
<span id="cb53-35">}</span>
<span id="cb53-36"></span>
<span id="cb53-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rebuild a *raw* kept-column bs matrix for new x using the stored attrs</span></span>
<span id="cb53-38">bs_raw_from_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x_new, spec) {</span>
<span id="cb53-39">  B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> splines<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs</span>(x_new,</span>
<span id="cb53-40">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">degree         =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>degree,</span>
<span id="cb53-41">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">knots          =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>knots,</span>
<span id="cb53-42">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Boundary.knots =</span> spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Boundary.knots,</span>
<span id="cb53-43">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">intercept =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb53-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B)[, spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>keep, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb53-45">}</span>
<span id="cb53-46"></span>
<span id="cb53-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale with stored training mu/sd (guard sd=0)</span></span>
<span id="cb53-48">scale_with <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(M, mu, sd) {</span>
<span id="cb53-49">  sd2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sd; sd2[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(sd2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|</span> sd2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb53-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sweep</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(M), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, mu, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"-"</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"/"</span>)</span>
<span id="cb53-51">}</span>
<span id="cb53-52"></span>
<span id="cb53-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column-wise Khatriâ€“Rao product</span></span>
<span id="cb53-54">tensor_kr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(B1, B2) {</span>
<span id="cb53-55">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(B1))</span>
<span id="cb53-56">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(B1))) out[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> B2 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> B1[, i]</span>
<span id="cb53-57">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">do.call</span>(cbind, out)</span>
<span id="cb53-58">}</span>
<span id="cb53-59"></span>
<span id="cb53-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># capture tensor spec from two *raw* kept bases (unscaled)</span></span>
<span id="cb53-61">capture_tensor_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(B1_raw, B2_raw) {</span>
<span id="cb53-62">  Traw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensor_kr</span>(B1_raw, B2_raw)</span>
<span id="cb53-63">  keep <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">keep_idx</span>(Traw)</span>
<span id="cb53-64">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb53-65">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">keep =</span> keep,</span>
<span id="cb53-66">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">colMeans</span>(Traw[, keep, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]),</span>
<span id="cb53-67">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd   =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(Traw[, keep, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">drop =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, sd)</span>
<span id="cb53-68">  )</span>
<span id="cb53-69">}</span>
<span id="cb53-70"></span>
<span id="cb53-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rebuild &amp; scale tensor for new (B1_raw_new, B2_raw_new)</span></span>
<span id="cb53-72">tensor_from_spec <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(B1_raw_new, B2_raw_new, tens_spec) {</span>
<span id="cb53-73">  Traw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensor_kr</span>(B1_raw_new, B2_raw_new)</span>
<span id="cb53-74">  Traw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Traw[, tens_spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>keep, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb53-75">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_with</span>(Traw, tens_spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, tens_spec<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sd)</span>
<span id="cb53-76">}</span>
<span id="cb53-77"></span>
<span id="cb53-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- (RE)CAPTURE SPECS FROM YOUR TRAINING DATA ----</span></span>
<span id="cb53-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build RAW bases (with attrs) *before* dropping cols/scaling</span></span>
<span id="cb53-80">B_year_N_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb53-81">B_year_t_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb53-82">B_year_D_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb53-83">B_year_I_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb53-84">B_logt_raw   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb53-85">B_logD_raw   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">build_bs_raw</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb53-86"></span>
<span id="cb53-87"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># capture bs specs</span></span>
<span id="cb53-88">spec_year_N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_N_raw)</span>
<span id="cb53-89">spec_year_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_t_raw)</span>
<span id="cb53-90">spec_year_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_D_raw)</span>
<span id="cb53-91">spec_year_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_year_I_raw)</span>
<span id="cb53-92">spec_logt   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_logt_raw)</span>
<span id="cb53-93">spec_logD   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_bs_spec</span>(B_logD_raw)</span>
<span id="cb53-94"></span>
<span id="cb53-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># capture tensor spec (built from *raw kept* bases)</span></span>
<span id="cb53-96">B_logt_keep_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B_logt_raw)[, spec_logt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>keep, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb53-97">B_logD_keep_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(B_logD_raw)[, spec_logD<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>keep, drop <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>]</span>
<span id="cb53-98">spec_tensor_tD  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">capture_tensor_spec</span>(B_logt_keep_raw, B_logD_keep_raw)</span>
<span id="cb53-99"></span>
<span id="cb53-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># store training means/sds for raw covariates used as standardized scalars</span></span>
<span id="cb53-101">center_sd_cont <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb53-102">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logN =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN)),</span>
<span id="cb53-103">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt)),</span>
<span id="cb53-104">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">logD =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD))</span>
<span id="cb53-105">)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1">simulate_forward <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_sims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>,</span>
<span id="cb54-2">                             year,</span>
<span id="cb54-3">                             region,</span>
<span id="cb54-4">                             country,</span>
<span id="cb54-5">                             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">use_same_draw_per_sim =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) {</span>
<span id="cb54-6"></span>
<span id="cb54-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(year)   <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) year   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(year,   n_sims)</span>
<span id="cb54-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(region) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) region <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(region, n_sims)</span>
<span id="cb54-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(country)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) country<span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(country,n_sims)</span>
<span id="cb54-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(year) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> n_sims, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(region) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> n_sims,</span>
<span id="cb54-11">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> n_sims)</span>
<span id="cb54-12"></span>
<span id="cb54-13">  region  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(region,  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region))</span>
<span id="cb54-14">  country <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(country, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">levels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">levels</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country))</span>
<span id="cb54-15">  r_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(region); c_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(country)</span>
<span id="cb54-16"></span>
<span id="cb54-17">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># posterior draws (already extracted earlier)</span></span>
<span id="cb54-18">  n_draws <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(beta_N); <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(n_draws <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb54-19"></span>
<span id="cb54-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (use_same_draw_per_sim) {</span>
<span id="cb54-21">    draw_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_draws), n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb54-22">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb54-23">    draw_id <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(</span>
<span id="cb54-24">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_draws), n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb54-25">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_draws), n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb54-26">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_draws), n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>),</span>
<span id="cb54-27">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Ip =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_draws), n_sims, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb54-28">    )</span>
<span id="cb54-29">  }</span>
<span id="cb54-30"></span>
<span id="cb54-31">  logN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(n_sims); logt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(n_sims)</span>
<span id="cb54-32">  logD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(n_sims); logi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">numeric</span>(n_sims)</span>
<span id="cb54-33"></span>
<span id="cb54-34">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_sims)) {</span>
<span id="cb54-35">    di_N  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(draw_id)) draw_id[i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N"</span>]  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> draw_id[i]</span>
<span id="cb54-36">    di_t  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(draw_id)) draw_id[i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t"</span>]  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> draw_id[i]</span>
<span id="cb54-37">    di_D  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(draw_id)) draw_id[i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"D"</span>]  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> draw_id[i]</span>
<span id="cb54-38">    di_I  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.matrix</span>(draw_id)) draw_id[i, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ip"</span>] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> draw_id[i]</span>
<span id="cb54-39"></span>
<span id="cb54-40">    aN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> u_reg[di_N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, r_id[i]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u_cty[di_N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, c_id[i]]</span>
<span id="cb54-41">    at <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> u_reg[di_t, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, r_id[i]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u_cty[di_t, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, c_id[i]]</span>
<span id="cb54-42">    aD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> u_reg[di_D, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, r_id[i]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u_cty[di_D, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, c_id[i]]</span>
<span id="cb54-43">    aI <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> u_reg[di_I, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, r_id[i]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> u_cty[di_I, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, c_id[i]]</span>
<span id="cb54-44"></span>
<span id="cb54-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- X_N(row): year spline only ----</span></span>
<span id="cb54-46">    B_yN_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(year[i], spec_year_N)</span>
<span id="cb54-47">    XN_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_with</span>(B_yN_raw, spec_year_N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, spec_year_N<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sd))</span>
<span id="cb54-48">    etaN <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(XN_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta_N[di_N, ]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> aN</span>
<span id="cb54-49">    logN[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, etaN, sigma_N[di_N])</span>
<span id="cb54-50"></span>
<span id="cb54-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- X_t(row): year spline + std logN ----</span></span>
<span id="cb54-52">    B_yt_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(year[i], spec_year_t)</span>
<span id="cb54-53">    Xt_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb54-54">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_with</span>(B_yt_raw, spec_year_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, spec_year_t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sd),</span>
<span id="cb54-55">                (logN[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>])</span>
<span id="cb54-56">    etat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(Xt_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta_t[di_t, ]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> at</span>
<span id="cb54-57">    logt[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, etat, sigma_t[di_t])</span>
<span id="cb54-58"></span>
<span id="cb54-59">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- X_D(row): year spline + std logN, logt ----</span></span>
<span id="cb54-60">    B_yD_raw <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(year[i], spec_year_D)</span>
<span id="cb54-61">    XD_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb54-62">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_with</span>(B_yD_raw, spec_year_D<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, spec_year_D<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sd),</span>
<span id="cb54-63">                (logN[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>],</span>
<span id="cb54-64">                (logt[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>])</span>
<span id="cb54-65">    etaD <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(XD_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta_D[di_D, ]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> aD</span>
<span id="cb54-66">    logD[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, etaD, sigma_D[di_D])</span>
<span id="cb54-67"></span>
<span id="cb54-68">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- X_I(row): year spline + std logN,logt,logD + tensor(logt,logD) ----</span></span>
<span id="cb54-69">    B_yI_raw   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(year[i], spec_year_I)</span>
<span id="cb54-70">    B_logt_raw_new <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(logt[i], spec_logt)</span>
<span id="cb54-71">    B_logD_raw_new <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bs_raw_from_spec</span>(logD[i], spec_logD)</span>
<span id="cb54-72">    T_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tensor_from_spec</span>(B_logt_raw_new, B_logD_raw_new, spec_tensor_tD)</span>
<span id="cb54-73"></span>
<span id="cb54-74">    XI_row <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb54-75">                <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_with</span>(B_yI_raw, spec_year_I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, spec_year_I<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sd),</span>
<span id="cb54-76">                (logN[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logN[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>],</span>
<span id="cb54-77">                (logt[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logt[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>],</span>
<span id="cb54-78">                (logD[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu"</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> center_sd_cont<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logD[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sd"</span>],</span>
<span id="cb54-79">                T_scaled)</span>
<span id="cb54-80">    etai <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(XI_row <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> beta_I[di_I, ]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> aI</span>
<span id="cb54-81">    logi[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, etai, sigma_I[di_I])</span>
<span id="cb54-82">  }</span>
<span id="cb54-83"></span>
<span id="cb54-84">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb54-85">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(n_sims),</span>
<span id="cb54-86">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year    =</span> year,</span>
<span id="cb54-87">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(region),</span>
<span id="cb54-88">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(country),</span>
<span id="cb54-89">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop             =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logN)),</span>
<span id="cb54-90">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak_weeks      =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logt)),</span>
<span id="cb54-91">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration_weeks    =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logD)),</span>
<span id="cb54-92">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak_per_person =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(logi)))</span>
<span id="cb54-93">  ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb54-94">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(duration_weeks, t_peak_weeks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb54-95">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 400 simulations for one stratum</span></span>
<span id="cb55-2">sim1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_forward</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_sims =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2015</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R2"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"C5"</span>)</span>
<span id="cb55-3"></span>
<span id="cb55-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># simulate with the empirical mix of (year, region, country) from your data</span></span>
<span id="cb55-5">keys <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">select</span>(year, region, country) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slice_sample</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb55-6">sim_meta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_forward</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">n_sims =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(keys),</span>
<span id="cb55-7">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">year =</span> keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>year,</span>
<span id="cb55-8">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">region =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>region),</span>
<span id="cb55-9">                            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">country =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.character</span>(keys<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>country))</span></code></pre></div>
</details>
</div>
<p>Quick visual check</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1">hist_summ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb56-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># filter(year == 2015, region =="R2", country == "C5") %&gt;% </span></span>
<span id="cb56-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transmute</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"historical"</span>,</span>
<span id="cb56-4">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logN),</span>
<span id="cb56-5">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logt),</span>
<span id="cb56-6">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">duration_weeks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(logD),</span>
<span id="cb56-7">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak_per_person =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plogis</span>(logit_i))</span>
<span id="cb56-8"></span>
<span id="cb56-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sim_summ &lt;- sim1 %&gt;% mutate(source = "simulated")</span></span>
<span id="cb56-10">sim_summ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">source =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"simulated"</span>)</span>
<span id="cb56-11"></span>
<span id="cb56-12"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(hist_summ, sim_summ) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb56-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(N_pop, t_peak_weeks, duration_weeks, i_peak_per_person),</span>
<span id="cb56-14">               <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"var"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb56-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> source)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb56-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb56-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>var, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb56-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Historical vs Forward Simulated (matched stratum)"</span>,</span>
<span id="cb56-19">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="weekly-incidence-counts" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Weekly Incidence &amp; Counts</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1">inc_curve_exp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, r, d){</span>
<span id="cb57-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb57-3">    week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak,</span>
<span id="cb57-4">    i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>( r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)),</span>
<span id="cb57-5">    i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak))</span>
<span id="cb57-6">  )</span>
<span id="cb57-7">}</span>
<span id="cb57-8">rd_from_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>){ L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>eps); r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> D; <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r=</span>r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d=</span>d) }</span>
<span id="cb57-9">inc_curve_tri <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D){</span>
<span id="cb57-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb57-11">    week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak, i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> t_peak),</span>
<span id="cb57-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> t_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> D, i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(D <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb57-13">  )</span>
<span id="cb57-14">}</span>
<span id="cb57-15">simulate_weekly_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mix=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi_nb=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>){</span>
<span id="cb57-16">  weeks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Tmax; Sims <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta))</span>
<span id="cb57-17">  shape_flag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob=</span>shape_mix)</span>
<span id="cb57-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta))){</span>
<span id="cb57-19">    N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N_pop[i]; tpk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_peak_weeks[i]</span>
<span id="cb57-20">    D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration_weeks[i]; ipk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_peak_per_person[i]</span>
<span id="cb57-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (shape_flag[i]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>){ rd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rd_from_D</span>(D, eps); inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_exp</span>(weeks, tpk, ipk, rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>], rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'d'</span>]); shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span></span>
<span id="cb57-22">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> { inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_tri</span>(weeks, tpk, ipk, D); shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tri"</span> }</span>
<span id="cb57-23">    mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>); y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom_mu_phi</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(weeks), mu, phi_nb)</span>
<span id="cb57-24">    Sims[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id=</span>i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">week=</span>weeks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape=</span>shape, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N=</span>N, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak=</span>tpk, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D=</span>D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak=</span>ipk)</span>
<span id="cb57-25">  }</span>
<span id="cb57-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(Sims)</span>
<span id="cb57-27">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1">sim_weekly <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_weekly_counts</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mix=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi_nb=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>)</span>
<span id="cb58-2">sim_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_weekly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(week) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_mean=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_q05=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(y,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_q95=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(y,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>)</span>
<span id="cb58-3"></span>
<span id="cb58-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(sim_sum, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(week, y_mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>y_q05, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>y_q95), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb58-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simulated weekly counts (mean Â± 90% envelope)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cases"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- helpers ----</span></span>
<span id="cb59-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NB2 sampler parameterized by mean 'mu' and overdispersion 'phi' (Var = mu + phi * mu^2)</span></span>
<span id="cb59-3">rnbinom_mu_phi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(n, mu, phi) {</span>
<span id="cb59-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size = 1/phi; allow vector 'mu'</span></span>
<span id="cb59-5">  size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-12</span>, phi)</span>
<span id="cb59-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rnbinom recycles 'size' if length 1; replicate if you want elementwise</span></span>
<span id="cb59-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(mu) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rnbinom_mu_phi: length(mu) must equal n"</span>)</span>
<span id="cb59-8">  stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, mu))</span>
<span id="cb59-9">}</span>
<span id="cb59-10"></span>
<span id="cb59-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Map total duration D (full width) to symmetric rise/decay rates (r, d)</span></span>
<span id="cb59-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interpretation: at distance D/2 from the peak, the exponential curve is 'eps' of the peak.</span></span>
<span id="cb59-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># So exp(-r * (D/2)) = eps and exp(-d * (D/2)) = eps  =&gt; r = d = 2*log(1/eps)/D</span></span>
<span id="cb59-14">rd_from_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb59-15">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(eps, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>))</span>
<span id="cb59-16">  rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(D, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb59-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r =</span> rate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d =</span> rate)</span>
<span id="cb59-18">}</span>
<span id="cb59-19"></span>
<span id="cb59-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exponential rise/decay incidence curve (per person per week)</span></span>
<span id="cb59-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Peaks at 'i_peak' when week == t_peak; otherwise decays exponentially.</span></span>
<span id="cb59-22">inc_curve_exp <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, r, d) {</span>
<span id="cb59-23">  inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(</span>
<span id="cb59-24">    week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak,</span>
<span id="cb59-25">    i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)),</span>
<span id="cb59-26">    i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak))</span>
<span id="cb59-27">  )</span>
<span id="cb59-28">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep in [0, 1-eps] to avoid impossible per-person probabilities</span></span>
<span id="cb59-29">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb59-30">}</span>
<span id="cb59-31"></span>
<span id="cb59-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Triangular (piecewise linear) incidence curve</span></span>
<span id="cb59-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rises linearly 0 -&gt; i_peak up to t_peak, then declines to 0 by week == D.</span></span>
<span id="cb59-34">inc_curve_tri <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D) {</span>
<span id="cb59-35">  up   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(t_peak, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb59-36">  down <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(D <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>))</span>
<span id="cb59-37">  inc  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak, up,</span>
<span id="cb59-38">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> D, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(down, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb59-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb59-40">}</span>
<span id="cb59-41"></span>
<span id="cb59-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- main simulator ----</span></span>
<span id="cb59-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sim_meta must have columns: N_pop, t_peak_weeks, duration_weeks, i_peak_per_person</span></span>
<span id="cb59-44">simulate_weekly_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sim_meta,</span>
<span id="cb59-45">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weeks =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,      <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># e.g., 1:Tmax or a custom integer vector</span></span>
<span id="cb59-46">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax  =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used only if 'weeks' is NULL</span></span>
<span id="cb59-47">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mix =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pr(exponential); 1-shape_mix = triangular</span></span>
<span id="cb59-48">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi_nb =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NB2 overdispersion (common across weeks)</span></span>
<span id="cb59-49">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps    =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exp tail fraction at +/- D/2</span></span>
<span id="cb59-50">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N_pop"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t_peak_weeks"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_weeks"</span>,</span>
<span id="cb59-51">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i_peak_per_person"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(sim_meta)))</span>
<span id="cb59-52">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(weeks)) weeks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(Tmax)</span>
<span id="cb59-53">  weeks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(weeks)</span>
<span id="cb59-54"></span>
<span id="cb59-55">  nS <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta)</span>
<span id="cb59-56">  shape_flag <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbinom</span>(nS, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> shape_mix)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1=exp, 0=tri</span></span>
<span id="cb59-57"></span>
<span id="cb59-58">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, nS)</span>
<span id="cb59-59"></span>
<span id="cb59-60">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(nS)) {</span>
<span id="cb59-61">    N   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N_pop[i]</span>
<span id="cb59-62">    tpk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_peak_weeks[i]</span>
<span id="cb59-63">    D   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration_weeks[i]</span>
<span id="cb59-64">    ipk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_peak_per_person[i]</span>
<span id="cb59-65"></span>
<span id="cb59-66">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (shape_flag[i] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb59-67">      rd  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rd_from_D</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps)               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># symmetric rates from duration</span></span>
<span id="cb59-68">      inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_exp</span>(weeks, tpk, ipk, rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>], rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d"</span>])</span>
<span id="cb59-69">      shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp"</span></span>
<span id="cb59-70">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb59-71">      inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_tri</span>(weeks, tpk, ipk, D)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># zero beyond week D</span></span>
<span id="cb59-72">      shape <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tri"</span></span>
<span id="cb59-73">    }</span>
<span id="cb59-74"></span>
<span id="cb59-75">    mu_week <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> inc)                    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># expected weekly cases</span></span>
<span id="cb59-76">    y_week  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom_mu_phi</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(weeks), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> mu_week, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi =</span> phi_nb)</span>
<span id="cb59-77"></span>
<span id="cb59-78">    out[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb59-79">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id   =</span> i,</span>
<span id="cb59-80">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">week     =</span> weeks,</span>
<span id="cb59-81">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape    =</span> shape,</span>
<span id="cb59-82">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop    =</span> N,</span>
<span id="cb59-83">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak   =</span> tpk,</span>
<span id="cb59-84">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D        =</span> D,</span>
<span id="cb59-85">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak   =</span> ipk,</span>
<span id="cb59-86">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu       =</span> mu_week,</span>
<span id="cb59-87">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases    =</span> y_week</span>
<span id="cb59-88">    )</span>
<span id="cb59-89">  }</span>
<span id="cb59-90"></span>
<span id="cb59-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(out)</span>
<span id="cb59-92">}</span>
<span id="cb59-93"></span>
<span id="cb59-94"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ---- example usage ----</span></span>
<span id="cb59-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using 'sim_meta' from your forward simulator:</span></span>
<span id="cb59-96"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (A) fixed horizon 1..50</span></span>
<span id="cb59-97">sim_weekly <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_weekly_counts</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, </span>
<span id="cb59-98">                                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mix =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi_nb =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>)</span>
<span id="cb59-99"></span>
<span id="cb59-100"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B) custom calendar weeks (e.g., -10..60 relative to outbreak start)</span></span>
<span id="cb59-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sim_weekly &lt;- simulate_weekly_counts(sim_meta, weeks = -10:60)</span></span>
<span id="cb59-102"></span>
<span id="cb59-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summaries for plotting (pointwise across simulations)</span></span>
<span id="cb59-104">sim_sum <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_weekly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb59-105">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(week) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb59-106">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb59-107">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(cases),</span>
<span id="cb59-108">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_q05  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(cases, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb59-109">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_q95  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(cases, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>),</span>
<span id="cb59-110">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span></span>
<span id="cb59-111">  )</span>
<span id="cb59-112"></span>
<span id="cb59-113"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(sim_sum, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(week, cases_mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb59-114">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> cases_q05, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> cases_q95), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb59-115">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb59-116">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Simulated weekly cases (mean and 90% envelope)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"week"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cases"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb59-117">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1">sim_totals <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_weekly <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb60-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sim_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb60-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_cases =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(cases), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">total_mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(mu), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb60-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">left_join</span>(sim_meta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">row_number</span>()), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sim_id"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb60-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">attack_rate_obs =</span> total_cases <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N_pop,</span>
<span id="cb60-6">         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">attack_rate_mu  =</span> total_mu    <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> N_pop)</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ===========================</span></span>
<span id="cb61-2"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## Weekly curves: extra shapes</span></span>
<span id="cb61-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">## ===========================</span></span>
<span id="cb61-4"></span>
<span id="cb61-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NB2 sampler (unchanged)</span></span>
<span id="cb61-6">rnbinom_mu_phi <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(n, mu, phi) {</span>
<span id="cb61-7">  size <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-12</span>, phi)</span>
<span id="cb61-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(mu) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> n) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rnbinom_mu_phi: length(mu) must equal n"</span>)</span>
<span id="cb61-9">  stats<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> size, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, mu))</span>
<span id="cb61-10">}</span>
<span id="cb61-11"></span>
<span id="cb61-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Symmetric exp: map duration D to (r, d) with tail fraction eps at +/- D/2</span></span>
<span id="cb61-13">rd_from_D_sym <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb61-14">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(eps, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>))</span>
<span id="cb61-15">  rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(D, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb61-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r =</span> rate, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d =</span> rate)</span>
<span id="cb61-17">}</span>
<span id="cb61-18"></span>
<span id="cb61-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Asymmetric exp: split D into a*D before-peak and (1-a)*D after-peak</span></span>
<span id="cb61-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tail fraction eps at t_peak - aD and t_peak + (1-a)D</span></span>
<span id="cb61-21">rd_from_D_asym <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb61-22">  a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(a, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>)     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># keep a in (0,1)</span></span>
<span id="cb61-23">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(eps, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>))</span>
<span id="cb61-24">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> D,      <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># growth rate (left side)</span></span>
<span id="cb61-25">  d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> a) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> D, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)       <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># decay rate (right side)</span></span>
<span id="cb61-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r =</span> r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d =</span> d)</span>
<span id="cb61-27">}</span>
<span id="cb61-28"></span>
<span id="cb61-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exponential (symmetric) per-person incidence curve</span></span>
<span id="cb61-30">inc_curve_exp_sym <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb61-31">  rd  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rd_from_D_sym</span>(D, eps)</span>
<span id="cb61-32">  inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak,</span>
<span id="cb61-33">                i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)),</span>
<span id="cb61-34">                i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)))</span>
<span id="cb61-35">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb61-36">}</span>
<span id="cb61-37"></span>
<span id="cb61-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exponential (asymmetric) per-person incidence curve</span></span>
<span id="cb61-39">inc_curve_exp_asym <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb61-40">  rd  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rd_from_D_asym</span>(D, a, eps)</span>
<span id="cb61-41">  inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak,</span>
<span id="cb61-42">                i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)),</span>
<span id="cb61-43">                i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d"</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak)))</span>
<span id="cb61-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb61-45">}</span>
<span id="cb61-46"></span>
<span id="cb61-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Triangular per-person incidence curve (unchanged)</span></span>
<span id="cb61-48">inc_curve_tri <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D) {</span>
<span id="cb61-49">  up   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(t_peak, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb61-50">  down <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(D <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>))</span>
<span id="cb61-51">  inc  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak, up,</span>
<span id="cb61-52">                 <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(week <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> D, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(down, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span>
<span id="cb61-53">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(inc, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb61-54">}</span></code></pre></div>
</details>
</div>
<p>Gamma renewal curve</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gamma GT weights (stable, normalized)</span></span>
<span id="cb62-2">gt_weights <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_lag =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) {</span>
<span id="cb62-3">  mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(mean, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>); sd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(sd, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb62-4">  k <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; theta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> mean</span>
<span id="cb62-5">  lags <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>max_lag</span>
<span id="cb62-6">  dens <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(lags <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> k, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> theta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span></span>
<span id="cb62-7">          <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pgamma</span>(lags <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> k, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> theta)</span>
<span id="cb62-8">  dens[dens <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb62-9">  dens <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(dens) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) dens <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(dens) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(lags, k, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> theta) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dgamma</span>(lags, k, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scale =</span> theta))</span>
<span id="cb62-10">  dens</span>
<span id="cb62-11">}</span>
<span id="cb62-12"></span>
<span id="cb62-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Map instantaneous growth rate g(t) to Rt(t) for a Gamma GT</span></span>
<span id="cb62-14">Rt_from_g_gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(g, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R_cap =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>) {</span>
<span id="cb62-15">  k <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (mean <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sd)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>; theta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sd<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> mean</span>
<span id="cb62-16">  Rt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(g <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> g)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>k, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> theta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>g))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>k)</span>
<span id="cb62-17">  Rt[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(Rt)] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb62-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(Rt, R_cap), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb62-19">}</span>
<span id="cb62-20"></span>
<span id="cb62-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Derive r and d from duration D and asymmetry a (fraction of D before the peak)</span></span>
<span id="cb62-22">rates_from_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>) {</span>
<span id="cb62-23">  L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(eps, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>))</span>
<span id="cb62-24">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> D, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># pre-peak growth rate</span></span>
<span id="cb62-25">  d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> L <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> a) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> D, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># post-peak decay rate</span></span>
<span id="cb62-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r =</span> r, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">d =</span> d)</span>
<span id="cb62-27">}</span>
<span id="cb62-28"></span>
<span id="cb62-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Renewal incidence that *forces* a tent peaked at t_peak by using piecewise constant g(t)</span></span>
<span id="cb62-30">inc_curve_renewal_gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(week, t_peak, i_peak, D,</span>
<span id="cb62-31">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb62-32">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb62-33">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_lag =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pre_buffer =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R_cap =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>) {</span>
<span id="cb62-34">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ensure the window includes a bit before/after the peak</span></span>
<span id="cb62-35">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(week) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> t_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> pre_buffer <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(week) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> t_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) {</span>
<span id="cb62-36">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># extend internally but return only original weeks</span></span>
<span id="cb62-37">    w_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">floor</span>(t_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> pre_buffer), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ceiling</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(week), t_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> D)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb62-38">    restrict_back <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span></span>
<span id="cb62-39">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb62-40">    w_all <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> week</span>
<span id="cb62-41">    restrict_back <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span></span>
<span id="cb62-42">  }</span>
<span id="cb62-43"></span>
<span id="cb62-44">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># growth/decay rates from D, a</span></span>
<span id="cb62-45">  rd <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rates_from_D</span>(D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps)</span>
<span id="cb62-46">  r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r"</span>]; d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rd[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"d"</span>]</span>
<span id="cb62-47"></span>
<span id="cb62-48">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># piecewise instantaneous growth g(t)</span></span>
<span id="cb62-49">  g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(w_all <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> t_peak, r, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d)</span>
<span id="cb62-50"></span>
<span id="cb62-51">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Rt(t) from g(t)</span></span>
<span id="cb62-52">  Rt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Rt_from_g_gamma</span>(g, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> gt_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> gt_sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">R_cap =</span> R_cap)</span>
<span id="cb62-53"></span>
<span id="cb62-54">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gamma weights</span></span>
<span id="cb62-55">  w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">gt_weights</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_lag =</span> max_lag, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> gt_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> gt_sd)</span>
<span id="cb62-56"></span>
<span id="cb62-57">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># discrete renewal</span></span>
<span id="cb62-58">  Tn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(w_all)</span>
<span id="cb62-59">  i <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, Tn)</span>
<span id="cb62-60">  i[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-8</span></span>
<span id="cb62-61">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (t <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>Tn) {</span>
<span id="cb62-62">    lag_max <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(w))</span>
<span id="cb62-63">    lambda <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(i[t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lag_max)] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>lag_max])</span>
<span id="cb62-64">    i[t] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> Rt[t] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lambda</span>
<span id="cb62-65">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(i[t]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> i[t] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) i[t] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb62-66">  }</span>
<span id="cb62-67"></span>
<span id="cb62-68">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale to hit peak exactly at t_peak (nearest index)</span></span>
<span id="cb62-69">  t_idx_peak <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.min</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(w_all <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_peak))</span>
<span id="cb62-70">  peak_val <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i[t_idx_peak]</span>
<span id="cb62-71">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.finite</span>(peak_val) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">||</span> peak_val <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(week)))</span>
<span id="cb62-72">  s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_peak <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> peak_val</span>
<span id="cb62-73">  i_scaled <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmin</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(s <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>)</span>
<span id="cb62-74"></span>
<span id="cb62-75">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># optionally truncate tiny tails</span></span>
<span id="cb62-76">  i_scaled[i_scaled <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> eps <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> i_peak] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb62-77"></span>
<span id="cb62-78">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return on requested grid</span></span>
<span id="cb62-79">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (restrict_back) {</span>
<span id="cb62-80">    out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">approx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> w_all, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> i_scaled, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xout =</span> week, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"constant"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rule =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y</span>
<span id="cb62-81">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb62-82">    out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> i_scaled</span>
<span id="cb62-83">  }</span>
<span id="cb62-84">  out</span>
<span id="cb62-85">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ============================</span></span>
<span id="cb63-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate weekly case counts</span></span>
<span id="cb63-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ============================</span></span>
<span id="cb63-4">simulate_weekly_counts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(sim_meta,</span>
<span id="cb63-5">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weeks      =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># integer vector of week indices; default 1:Tmax</span></span>
<span id="cb63-6">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax       =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>,</span>
<span id="cb63-7">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mode =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mix"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp_sym"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp_asym"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tri"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"renewal_gamma"</span>),</span>
<span id="cb63-8">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_probs  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exp_sym =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tri =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># used only if shape_mode=="mix"</span></span>
<span id="cb63-9">                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># asymmetric exp parameters</span></span>
<span id="cb63-10">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asym_a     =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fraction of D before the peak (0&lt;a&lt;1)</span></span>
<span id="cb63-11">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps        =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tail height fraction for exp shapes &amp; truncation in renewal</span></span>
<span id="cb63-12">                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># NB2 dispersion</span></span>
<span id="cb63-13">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi_nb     =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.35</span>,</span>
<span id="cb63-14">                                   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># renewal parameters</span></span>
<span id="cb63-15">                                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_mean    =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_lag =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>) {</span>
<span id="cb63-16"></span>
<span id="cb63-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopifnot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">all</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"N_pop"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t_peak_weeks"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"duration_weeks"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"i_peak_per_person"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(sim_meta)))</span>
<span id="cb63-18">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(weeks)) weeks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(Tmax) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> weeks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(weeks)</span>
<span id="cb63-19"></span>
<span id="cb63-20">  shape_mode <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">match.arg</span>(shape_mode)</span>
<span id="cb63-21"></span>
<span id="cb63-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># if mixture: draw shape per simulation using 'mix_probs'</span></span>
<span id="cb63-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (shape_mode <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mix"</span>) {</span>
<span id="cb63-24">    mix_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mix_probs[ mix_probs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> ]</span>
<span id="cb63-25">    mix_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> mix_probs <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(mix_probs)</span>
<span id="cb63-26">    shapes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(mix_probs), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prob =</span> mix_probs)</span>
<span id="cb63-27">  } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb63-28">    shapes <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(shape_mode, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta))</span>
<span id="cb63-29">  }</span>
<span id="cb63-30"></span>
<span id="cb63-31">  out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta))</span>
<span id="cb63-32"></span>
<span id="cb63-33">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(sim_meta))) {</span>
<span id="cb63-34">    N   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>N_pop[i]</span>
<span id="cb63-35">    tpk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_peak_weeks[i]</span>
<span id="cb63-36">    D   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>duration_weeks[i]</span>
<span id="cb63-37">    ipk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_meta<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>i_peak_per_person[i]</span>
<span id="cb63-38"></span>
<span id="cb63-39">    inc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">switch</span>(shapes[i],</span>
<span id="cb63-40">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp_sym"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_exp_sym</span>(weeks, tpk, ipk, D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps),</span>
<span id="cb63-41">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp_asym"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_exp_asym</span>(weeks, tpk, ipk, D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> asym_a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps),</span>
<span id="cb63-42">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"tri"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_tri</span>(weeks, tpk, ipk, D),</span>
<span id="cb63-43">      <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"renewal_gamma"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inc_curve_renewal_gamma</span>(weeks, tpk, ipk, D,</span>
<span id="cb63-44">                                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> asym_a, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> eps,</span>
<span id="cb63-45">                                                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_mean =</span> gt_mean, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_sd =</span> gt_sd, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_lag =</span> max_lag),</span>
<span id="cb63-46">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Unknown shape: "</span>, shapes[i])</span>
<span id="cb63-47">    )</span>
<span id="cb63-48"></span>
<span id="cb63-49">    mu_week <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pmax</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> inc)</span>
<span id="cb63-50">    y_week  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom_mu_phi</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(weeks), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> mu_week, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">phi =</span> phi_nb)</span>
<span id="cb63-51"></span>
<span id="cb63-52">    out[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb63-53">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id =</span> i, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">week =</span> weeks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> shapes[i],</span>
<span id="cb63-54">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N_pop =</span> N, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak =</span> tpk, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D =</span> D, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i_peak =</span> ipk,</span>
<span id="cb63-55">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> mu_week, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases =</span> y_week</span>
<span id="cb63-56">    )</span>
<span id="cb63-57">  }</span>
<span id="cb63-58"></span>
<span id="cb63-59">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(out)</span>
<span id="cb63-60">}</span></code></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Using your forward-simulated meta-parameters 'sim_meta'</span></span>
<span id="cb64-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) Asymmetric exponential (e.g., faster rise, slower decay: a = 0.3 â‡’ longer right tail)</span></span>
<span id="cb64-3">sim_asym  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_weekly_counts</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, </span>
<span id="cb64-4">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"exp_asym"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">asym_a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb64-5"></span>
<span id="cb64-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2) Renewal with Gamma GT (mean 5d, sd 2d); use weeks as, say, 1..60</span></span>
<span id="cb64-7">sim_ren   <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_weekly_counts</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">weeks =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, </span>
<span id="cb64-8">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"renewal_gamma"</span>,</span>
<span id="cb64-9">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">gt_sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">eps =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span>
<span id="cb64-10"></span>
<span id="cb64-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3) Mixture across four shapes</span></span>
<span id="cb64-12">sim_mix4  <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_weekly_counts</span>(sim_meta, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tmax =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape_mode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mix"</span>,</span>
<span id="cb64-13">                                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mix_probs =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exp_sym =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, </span>
<span id="cb64-14">                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">exp_asym =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">tri =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, </span>
<span id="cb64-15">                                                  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">renewal_gamma =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>))</span>
<span id="cb64-16"></span>
<span id="cb64-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Summarize/plot (as before)</span></span>
<span id="cb64-18">summ <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> sim_ren <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb64-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(week) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb64-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(cases),</span>
<span id="cb64-21">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_q05  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(cases, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>),</span>
<span id="cb64-22">            <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cases_q95  =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(cases, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.groups =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"drop"</span>)</span>
<span id="cb64-23"></span>
<span id="cb64-24"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(summ, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(week, cases_mean)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb64-25">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_ribbon</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin =</span> cases_q05, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax =</span> cases_q95), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb64-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb64-27">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gammaâ€“renewal simulated weekly cases"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"week"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cases"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb64-28">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index_files/figure-html/unnamed-chunk-27-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="references" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> References</h1>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/outbreak_simulation2/index.html</guid>
  <pubDate>Sun, 12 Oct 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Simulating Correlated Outbreak Parameters Using Copulas</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/copula/index.html</link>
  <description><![CDATA[ 



<p>I wanted to simulate synthetic outbreaks based on realistic distributions for the following three parameters:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?t_%7B%5Ctext%7Bpeak%7D%7D">: Time to peak (weeks after outbreak start)</li>
<li><img src="https://latex.codecogs.com/png.latex?I_%7B%5Ctext%7Bpeak%7D%7D">: Peak weekly incidence (number of cases)</li>
<li><img src="https://latex.codecogs.com/png.latex?D">: Total outbreak duration (in weeks)</li>
</ul>
<p>These parameters are typically right-skewed, strictly positive, and correlated. A naive approach that samples each parameter independently fails to capture their interdependencies. Instead, we can use a copula-based approach to model their joint distribution realistically.</p>
<p>In this post, we will:</p>
<ol type="1">
<li>Explain copulas and how they help capture correlations between different distributions.</li>
<li>Simulate fake outbreak parameter data using a Gaussian copula.</li>
<li>Fit a hierarchical Bayesian copula model using rstan.</li>
</ol>
<section id="what-is-a-copula" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="what-is-a-copula"><span class="header-section-number">1</span> What is a Copula?</h2>
<p>A <strong>copula</strong> is a multivariate distribution that allows us to model <strong>dependence structures</strong> separately from <strong>marginal distributions</strong>. Given random variables <img src="https://latex.codecogs.com/png.latex?X_1,%20X_2,%20X_3"> with different marginal distributions (e.g., log-normal, negative binomial, gamma), a copula binds them together using their <strong>ranks (uniform CDF values)</strong>.</p>
<p>The Gaussian copula uses a multivariate normal distribution on the inverse CDF-transformed variables:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AZ_i%20=%20%5CPhi%5E%7B-1%7D(F_i(X_i))%0A"></p>
<p>Then the joint density is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AC(u_1,%20u_2,%20u_3)%20=%20%5CPhi_%5CSigma(%5CPhi%5E%7B-1%7D(u_1),%20%5CPhi%5E%7B-1%7D(u_2),%20%5CPhi%5E%7B-1%7D(u_3))%0A"></p>
<p>This allows us to flexibly model each margin while preserving their empirical correlation.</p>
</section>
<section id="step-1-simulate-fake-data" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="step-1-simulate-fake-data"><span class="header-section-number">2</span> Step 1: Simulate Fake Data</h2>
<p>We simulate fake outbreaks with sparse group-level data. Each group has its own mean parameters, and only a few observations per group.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(rstan)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rstan_options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_write =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">options</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mc.cores =</span> parallel<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>())</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Global parameters</span></span>
<span id="cb1-8">G <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb1-9">mu_t0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-10">mu_I0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span>
<span id="cb1-11">mu_D0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb1-12">sigma_mu_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb1-13">sigma_mu_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span></span>
<span id="cb1-14">sigma_mu_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span></span>
<span id="cb1-15">sigma_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb1-16">phi_I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb1-17">shape_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Copula correlation matrix</span></span>
<span id="cb1-20">R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-21">L <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">chol</span>(R)</span>
<span id="cb1-22"></span>
<span id="cb1-23">mu_t_g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(G, mu_t0, sigma_mu_t)</span>
<span id="cb1-24">mu_I_g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(G, mu_I0, sigma_mu_I)</span>
<span id="cb1-25">mu_D_g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(G, mu_D0, sigma_mu_D)</span>
<span id="cb1-26"></span>
<span id="cb1-27">out_list <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, G)</span>
<span id="cb1-28"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (g <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_len</span>(G)) {</span>
<span id="cb1-29">  n_g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-30">  dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>()</span>
<span id="cb1-31">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">while</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(dat) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n_g) {</span>
<span id="cb1-32">    z <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(L) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-33">    u <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(z)</span>
<span id="cb1-34">    t_pk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(1L, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qlnorm</span>(u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], mu_t_g[g], sigma_t)))</span>
<span id="cb1-35">    I_pk <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(1L, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qnbinom</span>(u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>phi_I, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(mu_I_g[g])))</span>
<span id="cb1-36">    rate_D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> shape_D <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(mu_D_g[g])</span>
<span id="cb1-37">    D <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(t_pk, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">qgamma</span>(u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], shape_D, rate_D)))</span>
<span id="cb1-38">    dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(dat, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grp =</span> g, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak =</span> t_pk, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I_peak =</span> I_pk, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D =</span> D))</span>
<span id="cb1-39">  }</span>
<span id="cb1-40">  out_list[[g]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> dat</span>
<span id="cb1-41">}</span>
<span id="cb1-42">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(out_list) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">grp =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">factor</span>(grp))</span>
<span id="cb1-43"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glimpse</span>(df)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 40
Columns: 4
$ grp    &lt;fct&gt; 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 6, â€¦
$ t_peak &lt;dbl&gt; 2, 6, 1, 2, 4, 4, 4, 4, 10, 5, 6, 12, 11, 2, 4, 3, 4, 4, 7, 6, â€¦
$ I_peak &lt;dbl&gt; 18, 42, 8, 35, 67, 15, 25, 43, 13, 26, 54, 46, 37, 19, 28, 16, â€¦
$ D      &lt;dbl&gt; 5, 12, 3, 10, 8, 14, 13, 15, 16, 16, 7, 16, 11, 5, 10, 7, 9, 5,â€¦</code></pre>
</div>
</div>
</section>
<section id="step-2-prepare-data-for-stan" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="step-2-prepare-data-for-stan"><span class="header-section-number">3</span> Step 2: Prepare Data for Stan</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">stan_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb3-2">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">N =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(df),</span>
<span id="cb3-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">G =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nlevels</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grp),</span>
<span id="cb3-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">g =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.integer</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grp),</span>
<span id="cb3-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_pk =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_peak,</span>
<span id="cb3-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I_pk =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>I_peak,</span>
<span id="cb3-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Dur =</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>D</span>
<span id="cb3-8">)</span></code></pre></div>
</details>
</div>
</section>
<section id="step-3-write-stan-model-to-file" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="step-3-write-stan-model-to-file"><span class="header-section-number">4</span> Step 3: Write Stan Model to File</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">stan_code <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-2"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">data {</span></span>
<span id="cb4-3"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; N;</span></span>
<span id="cb4-4"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; G;</span></span>
<span id="cb4-5"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1,upper=G&gt; g[N];</span></span>
<span id="cb4-6"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] t_pk;</span></span>
<span id="cb4-7"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  int&lt;lower=1&gt; I_pk[N];</span></span>
<span id="cb4-8"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector&lt;lower=0&gt;[N] Dur;</span></span>
<span id="cb4-9"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-10"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">parameters {</span></span>
<span id="cb4-11"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real mu_t0;         real mu_I0;          real mu_D0;</span></span>
<span id="cb4-12"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_mu_t;   real&lt;lower=0&gt; sigma_mu_I;  real&lt;lower=0&gt; sigma_mu_D;</span></span>
<span id="cb4-13"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[G] mu_t_raw; vector[G] mu_I_raw;  vector[G] mu_D_raw;</span></span>
<span id="cb4-14"></span>
<span id="cb4-15"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; sigma_t;</span></span>
<span id="cb4-16"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; phi_I;</span></span>
<span id="cb4-17"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  real&lt;lower=0&gt; shape_D;        real&lt;lower=0&gt; rate_D;</span></span>
<span id="cb4-18"></span>
<span id="cb4-19"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  cholesky_factor_corr[3] L_corr;</span></span>
<span id="cb4-20"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-21"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">transformed parameters {</span></span>
<span id="cb4-22"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[G] mu_t = mu_t0 + sigma_mu_t * mu_t_raw;</span></span>
<span id="cb4-23"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[G] mu_I = mu_I0 + sigma_mu_I * mu_I_raw;</span></span>
<span id="cb4-24"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  vector[G] mu_D = mu_D0 + sigma_mu_D * mu_D_raw;</span></span>
<span id="cb4-25"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-26"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">model {</span></span>
<span id="cb4-27"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  // Hyper-priors</span></span>
<span id="cb4-28"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_t0 ~ normal(log(5), 1.5);</span></span>
<span id="cb4-29"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_I0 ~ normal(log(20), 2);</span></span>
<span id="cb4-30"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_D0 ~ normal(log(15), 1.5);</span></span>
<span id="cb4-31"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_mu_t ~ exponential(1);</span></span>
<span id="cb4-32"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_mu_I ~ exponential(1);</span></span>
<span id="cb4-33"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_mu_D ~ exponential(1);</span></span>
<span id="cb4-34"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_t_raw ~ normal(0,1);</span></span>
<span id="cb4-35"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_I_raw ~ normal(0,1);</span></span>
<span id="cb4-36"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  mu_D_raw ~ normal(0,1);</span></span>
<span id="cb4-37"></span>
<span id="cb4-38"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  sigma_t  ~ exponential(1);</span></span>
<span id="cb4-39"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  phi_I    ~ exponential(1);</span></span>
<span id="cb4-40"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  shape_D  ~ gamma(2,0.1);</span></span>
<span id="cb4-41"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  rate_D   ~ gamma(2,0.1);</span></span>
<span id="cb4-42"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  L_corr   ~ lkj_corr_cholesky(2);</span></span>
<span id="cb4-43"></span>
<span id="cb4-44"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  // Likelihood with Gaussian copula</span></span>
<span id="cb4-45"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  for (n in 1:N) {</span></span>
<span id="cb4-46"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    int g_n = g[n];</span></span>
<span id="cb4-47"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real mu_tn = mu_t[g_n];</span></span>
<span id="cb4-48"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real mu_In = exp(mu_I[g_n]);</span></span>
<span id="cb4-49"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real mu_Dn = exp(mu_D[g_n]);</span></span>
<span id="cb4-50"></span>
<span id="cb4-51"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Marginal log-densities</span></span>
<span id="cb4-52"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += lognormal_lpdf(t_pk[n] | mu_tn, sigma_t);</span></span>
<span id="cb4-53"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += neg_binomial_2_lpmf(I_pk[n] | mu_In, 1/phi_I);</span></span>
<span id="cb4-54"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += gamma_lpdf(Dur[n] | shape_D, rate_D);</span></span>
<span id="cb4-55"></span>
<span id="cb4-56"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    // Copula part</span></span>
<span id="cb4-57"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real u1 = lognormal_cdf(t_pk[n], mu_tn, sigma_t);</span></span>
<span id="cb4-58"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real F_lo = neg_binomial_2_cdf(I_pk[n]-1, mu_In, 1/phi_I);</span></span>
<span id="cb4-59"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real F_hi = neg_binomial_2_cdf(I_pk[n], mu_In, 1/phi_I);</span></span>
<span id="cb4-60"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real u2 = 0.5*(F_lo + F_hi);             // mid-CDF for discrete NB</span></span>
<span id="cb4-61"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    real u3 = gamma_cdf(Dur[n], shape_D, rate_D);</span></span>
<span id="cb4-62"></span>
<span id="cb4-63"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    vector[3] z;</span></span>
<span id="cb4-64"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    z[1] = inv_Phi(u1);</span></span>
<span id="cb4-65"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    z[2] = inv_Phi(u2);</span></span>
<span id="cb4-66"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    z[3] = inv_Phi(u3);</span></span>
<span id="cb4-67"></span>
<span id="cb4-68"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    target += multi_normal_cholesky_lpdf(z | rep_vector(0,3), L_corr)</span></span>
<span id="cb4-69"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">              - normal_lpdf(z[1] | 0,1) - normal_lpdf(z[2] | 0,1)</span></span>
<span id="cb4-70"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">              - normal_lpdf(z[3] | 0,1);</span></span>
<span id="cb4-71"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">  }</span></span>
<span id="cb4-72"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">}</span></span>
<span id="cb4-73"><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span></span>
<span id="cb4-74"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">writeLines</span>(stan_code, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"copula_hier.stan"</span>)</span></code></pre></div>
</details>
</div>
</section>
<section id="step-4-compile-and-sample" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="step-4-compile-and-sample"><span class="header-section-number">5</span> Step 4: Compile and Sample</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">mod <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stan_model</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"copula_hier.stan"</span>)</span>
<span id="cb5-2">fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sampling</span>(mod, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> stan_data,</span>
<span id="cb5-3">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">chains =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1500</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">warmup =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">750</span>,</span>
<span id="cb5-4">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">seed =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2025</span>,</span>
<span id="cb5-5">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">control =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">adapt_delta =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>))</span>
<span id="cb5-6"></span>
<span id="cb5-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_t0"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_I0"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mu_D0"</span>,</span>
<span id="cb5-8">                    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"sigma_t"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"phi_I"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape_D"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rate_D"</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Inference for Stan model: anon_model.
4 chains, each with iter=1500; warmup=750; thin=1; 
post-warmup draws per chain=750, total post-warmup draws=3000.

        mean se_mean   sd  2.5%  25%  50%  75% 97.5% n_eff Rhat
mu_t0   1.52    0.00 0.17  1.19 1.41 1.52 1.63  1.88  1231    1
mu_I0   3.18    0.01 0.33  2.52 2.97 3.17 3.37  3.84   743    1
mu_D0   2.73    0.02 1.44 -0.03 1.74 2.72 3.71  5.47  5547    1
sigma_t 0.59    0.00 0.08  0.45 0.53 0.58 0.63  0.77  1470    1
phi_I   0.27    0.00 0.08  0.15 0.22 0.26 0.32  0.45  2711    1
shape_D 3.28    0.01 0.62  2.18 2.84 3.23 3.67  4.59  1970    1
rate_D  0.25    0.00 0.05  0.16 0.21 0.24 0.28  0.35  1966    1

Samples were drawn using NUTS(diag_e) at Fri Jul 25 16:08:17 2025.
For each parameter, n_eff is a crude measure of effective sample size,
and Rhat is the potential scale reduction factor on split chains (at 
convergence, Rhat=1).</code></pre>
</div>
</div>
<p>Using copulas allows us to flexibly simulate and estimate correlated epidemiological parameters without assuming a joint normal distribution. This approach can be extended to include additional outbreak features (e.g., start week, region, climate covariates) and can be combined with downstream simulations for vaccine impact or ORI strategies.</p>
</section>
<section id="step-5-compare-posterior-estimates-vs.-true-values" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="step-5-compare-posterior-estimates-vs.-true-values"><span class="header-section-number">6</span> Step 5: Compare Posterior Estimates vs.&nbsp;True Values</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">posterior <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> rstan<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">extract</span>(fit)</span>
<span id="cb7-2"></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare global means</span></span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(mu_t0, mu_I0, mu_D0),</span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">posterior_mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t0),</span>
<span id="cb7-7">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_I0),</span>
<span id="cb7-8">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_D0)), </span>
<span id="cb7-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">posterior_median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t0),</span>
<span id="cb7-10">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_I0),</span>
<span id="cb7-11">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_D0)), </span>
<span id="cb7-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">posterior_25 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)),</span>
<span id="cb7-13">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)),</span>
<span id="cb7-14">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_D0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>))), </span>
<span id="cb7-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">posterior_75 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)),</span>
<span id="cb7-16">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_I0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)),</span>
<span id="cb7-17">                     <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_D0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>        true posterior_mean posterior_median posterior_25 posterior_75
25% 1.609438       1.521474         1.520701     1.411450     1.625936
25% 2.995732       3.176480         3.166717     2.974919     3.366913
25% 2.708050       2.725390         2.716608     1.742690     3.712502</code></pre>
</div>
</div>
</section>
<section id="step-6-posterior-predictive-checks" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="step-6-posterior-predictive-checks"><span class="header-section-number">7</span> Step 6: Posterior Predictive Checks</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(bayesplot)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb9-4">draw_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_t), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb9-5">g <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># choose group</span></span>
<span id="cb9-6"></span>
<span id="cb9-7">obs_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t_peak[df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grp <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> g]</span>
<span id="cb9-8">n_obs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(obs_t)</span>
<span id="cb9-9"></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate 200 posterior predictive replicates for each obs</span></span>
<span id="cb9-11">yrep_t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(draw_ids), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> n_obs)</span>
<span id="cb9-12"></span>
<span id="cb9-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq_along</span>(draw_ids)) {</span>
<span id="cb9-14">  idx <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> draw_ids[i]</span>
<span id="cb9-15">  mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t[idx, g]</span>
<span id="cb9-16">  sigma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_t[idx]</span>
<span id="cb9-17">  yrep_t[i, ] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(n_obs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">meanlog =</span> mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sdlog =</span> sigma)</span>
<span id="cb9-18">}</span>
<span id="cb9-19"></span>
<span id="cb9-20"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ppc_dens_overlay</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> obs_t, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yrep =</span> yrep_t) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Predictive Check: t_peak (Group 1)"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/copula/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="step-7-generate-posterior-samples-for-t_peak-i_peak-and-d" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="step-7-generate-posterior-samples-for-t_peak-i_peak-and-d"><span class="header-section-number">8</span> Step 7: Generate Posterior Samples for t_peak, I_peak, and D</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Draw 1000 posterior predictive samples</span></span>
<span id="cb10-2">posterior_draws <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb10-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t_peak =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_t, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(mu) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rlnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, mu[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sigma_t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])),</span>
<span id="cb10-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">I_peak =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_I, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(mu) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(mu[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>phi_I[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])),</span>
<span id="cb10-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">D      =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply</span>(posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu_D, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(mu) <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rgamma</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">shape =</span> posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shape_D[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> posterior<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>rate_D[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]))</span>
<span id="cb10-6">)</span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Visualize</span></span>
<span id="cb10-9">posterior_draws <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>()) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span></span>
<span id="cb10-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(value)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"skyblue"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>name, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior Predictive Distributions"</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/copula/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/copula/index.html</guid>
  <pubDate>Thu, 24 Jul 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Outbreak Simulation: Pre-emptive vs.Â Reactive Vaccination</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/outbreak_simulation/index.html</link>
  <description><![CDATA[ 



<p>When managing infectious disease risks such as cholera, limited vaccine supply often forces decision-makers to choose between <strong>pre-emptive</strong> and <strong>reactive</strong> vaccination campaigns. This post explores a cost-benefit model comparing the two strategies using analytical expressions and numerical simulations.</p>
<p>We aim to answer: <strong>Under what conditions is it better to vaccinate before an outbreak occurs, and when is it more beneficial to wait and respond reactively?</strong></p>
<section id="defining-the-core-quantities" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="defining-the-core-quantities"><span class="header-section-number">1</span> Defining the Core Quantities</h2>
<p>Let:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?B">: The full benefit gained by averting an outbreak (e.g., DALYs or cases averted)</li>
<li><img src="https://latex.codecogs.com/png.latex?C">: The cost of deploying one vaccination campaign</li>
<li><img src="https://latex.codecogs.com/png.latex?p">: The probability of an outbreak in a given region</li>
<li><img src="https://latex.codecogs.com/png.latex?r">: The effectiveness of a reactive campaign relative to pre-emptive one (e.g., <img src="https://latex.codecogs.com/png.latex?r=0.6"> means 60% as effective)</li>
</ul>
<section id="pre-emptive-vaccination" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="pre-emptive-vaccination"><span class="header-section-number">1.1</span> Pre-emptive Vaccination</h3>
<p>If we vaccinate before any outbreak, the expected benefit is <img src="https://latex.codecogs.com/png.latex?B%20%5Ccdot%20p">. However, we always incur the campaign cost <img src="https://latex.codecogs.com/png.latex?C">, so the <strong>net expected benefit</strong> is:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cholera Outbreak Simulation Using Piecewise Linear Curves (Inspired by Middleton et al.)</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Parameters ---</span></span>
<span id="cb1-7">n_sim <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>                 <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of outbreaks</span></span>
<span id="cb1-8">days <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time horizon (days)</span></span>
<span id="cb1-9">preemptive_reduction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># percent reduction in peak and total for preemptive vaccine</span></span>
<span id="cb1-10">reactive_reduction <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># percent reduction in post-day-7 values for reactive vaccine</span></span>
<span id="cb1-11">reactive_delay <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to generate piecewise linear outbreak</span></span>
<span id="cb1-14">simulate_outbreak <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(start_day, peak_day, end_day, peak_height) {</span>
<span id="cb1-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">tibble</span>(</span>
<span id="cb1-16">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">day =</span> days,</span>
<span id="cb1-17">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">incidence =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">case_when</span>(</span>
<span id="cb1-18">      day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> start_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb1-19">      day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> start_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> peak_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (peak_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> peak_height,</span>
<span id="cb1-20">      day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> peak_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;</span> day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> end_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> (end_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (end_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> peak_day) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> peak_height,</span>
<span id="cb1-21">      <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-22">    )</span>
<span id="cb1-23">  )</span>
<span id="cb1-24">}</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to apply preemptive vaccination</span></span>
<span id="cb1-27">apply_preemptive <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(incidence, reduction) {</span>
<span id="cb1-28">  incidence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> reduction)</span>
<span id="cb1-29">}</span>
<span id="cb1-30"></span>
<span id="cb1-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to apply reactive vaccination</span></span>
<span id="cb1-32">apply_reactive <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df, reduction, delay) {</span>
<span id="cb1-33">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(</span>
<span id="cb1-34">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">incidence =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> delay, incidence <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> reduction), incidence)</span>
<span id="cb1-35">  )</span>
<span id="cb1-36">}</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Simulate all outbreaks ---</span></span>
<span id="cb1-39"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-40">outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">vector</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"list"</span>, n_sim)</span>
<span id="cb1-41"></span>
<span id="cb1-42"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_sim) {</span>
<span id="cb1-43">  start_day <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-44">  duration <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-45">  peak_offset <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(duration <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-46">  peak_day <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> start_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> peak_offset</span>
<span id="cb1-47">  end_day <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> start_day <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> duration</span>
<span id="cb1-48">  peak_height <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">runif</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb1-49"></span>
<span id="cb1-50">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">simulate_outbreak</span>(start_day, peak_day, end_day, peak_height)</span>
<span id="cb1-51">  df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sim_id =</span> i)</span>
<span id="cb1-52">  outbreaks[[i]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> df</span>
<span id="cb1-53">}</span>
<span id="cb1-54"></span>
<span id="cb1-55">all_outbreaks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(outbreaks)</span>
<span id="cb1-56"></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply strategies</span></span>
<span id="cb1-58">preemptive <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_outbreaks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sim_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">incidence =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply_preemptive</span>(incidence, preemptive_reduction))</span>
<span id="cb1-59">reactive <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_outbreaks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sim_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_modify</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">apply_reactive</span>(.x, reactive_reduction, reactive_delay))</span>
<span id="cb1-60"></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Summarize ---</span></span>
<span id="cb1-62">summarize_scenarios <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(df) {</span>
<span id="cb1-63">  df <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-64">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">group_by</span>(sim_id) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-65">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarise</span>(</span>
<span id="cb1-66">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cumulative_cases =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(incidence),</span>
<span id="cb1-67">      <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">peak_cases =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(incidence)</span>
<span id="cb1-68">    )</span>
<span id="cb1-69">}</span>
<span id="cb1-70"></span>
<span id="cb1-71">baseline_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_scenarios</span>(all_outbreaks)</span>
<span id="cb1-72">preemptive_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_scenarios</span>(preemptive)</span>
<span id="cb1-73">reactive_summary <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summarize_scenarios</span>(reactive)</span>
<span id="cb1-74"></span>
<span id="cb1-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine for comparison</span></span>
<span id="cb1-76">comparison <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bind_rows</span>(</span>
<span id="cb1-77">  baseline_summary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strategy =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Baseline"</span>),</span>
<span id="cb1-78">  preemptive_summary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strategy =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Preemptive"</span>),</span>
<span id="cb1-79">  reactive_summary <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mutate</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">strategy =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Reactive"</span>)</span>
<span id="cb1-80">)</span>
<span id="cb1-81"></span>
<span id="cb1-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># --- Visualization ---</span></span>
<span id="cb1-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot a few example outbreaks</span></span>
<span id="cb1-84">example_ids <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n_sim, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span>
<span id="cb1-85">example_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> all_outbreaks <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">filter</span>(sim_id <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%in%</span> example_ids)</span>
<span id="cb1-86"></span>
<span id="cb1-87">example_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> example_data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span> </span>
<span id="cb1-88">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> day, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> incidence)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-89">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-90">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> sim_id, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-91">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-92">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Example Simulated Cholera Outbreaks"</span>,</span>
<span id="cb1-93">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Day"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Daily Incidence"</span>)</span>
<span id="cb1-94"></span>
<span id="cb1-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Boxplots of cumulative cases and peak by strategy</span></span>
<span id="cb1-96">boxplot_plot <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> comparison <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-97">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(cumulative_cases, peak_cases), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"metric"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"value"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%&gt;%</span></span>
<span id="cb1-98">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> strategy, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> strategy)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-99">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_boxplot</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-100">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> metric, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-101">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-102">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Impact of Vaccination Strategies"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Strategy"</span>)</span>
<span id="cb1-103"></span>
<span id="cb1-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display plots</span></span>
<span id="cb1-105"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(example_plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(boxplot_plot)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/outbreak_simulation/index_files/figure-html/unnamed-chunk-1-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="references" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="references"><span class="header-section-number">2</span> References</h2>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/outbreak_simulation/index.html</guid>
  <pubDate>Fri, 27 Jun 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>ë‹¤ë‹ˆì—˜ ë² ë¥´ëˆ„ì´ì˜ ì²œì—°ë‘ ì—°êµ¬: ìµœì´ˆì˜ ê°ì—¼ë³‘ ìˆ˜ë¦¬ëª¨í˜•</title>
  <dc:creator>ì—°êµ¬ìž </dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/book_bernoulli_math_model_smallpox/index.html</link>
  <description><![CDATA[ 



<section id="ì„œë¡ -ê³„ëª½ì‹œëŒ€ì˜-ìˆ˜í•™ìžì™€-ì „ì—¼ë³‘" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="ì„œë¡ -ê³„ëª½ì‹œëŒ€ì˜-ìˆ˜í•™ìžì™€-ì „ì—¼ë³‘"><span class="header-section-number">1</span> ì„œë¡ : ê³„ëª½ì‹œëŒ€ì˜ ìˆ˜í•™ìžì™€ ì „ì—¼ë³‘</h2>
<p>18ì„¸ê¸° ìœ ëŸ½ì€ ì²œì—°ë‘(smallpox)ì˜ ê·¸ë¦¼ìž ì•„ëž˜ ì‚´ê³  ìžˆì—ˆë‹¤. ì´ ë¬´ì„œìš´ ì§ˆë³‘ì€ ë§¤ë…„ ìˆ˜ì‹­ë§Œ ëª…ì˜ ëª©ìˆ¨ì„ ì•—ì•„ê°”ìœ¼ë©°, ìƒì¡´ìžë“¤ì—ê²ŒëŠ” í‰ìƒ ì§€ìš¸ ìˆ˜ ì—†ëŠ” í‰í„°ë¥¼ ë‚¨ê²¼ë‹¤ <span class="citation" data-cites="razzell1977conquest">(Razzell, 1977)</span>. ì´ëŸ° ìƒí™©ì—ì„œ í•œ ìˆ˜í•™ìžê°€ ìˆ˜í•™ì  ì‚¬ê³ ë¥¼ í†µí•´ ì´ ì§ˆë³‘ì— ë§žì„œê³ ìž í–ˆë‹¤. ê·¸ì˜ ì´ë¦„ì€ ë‹¤ë‹ˆì—˜ ë² ë¥´ëˆ„ì´(Daniel Bernoulli, 1700-1782)ì˜€ë‹¤.</p>
<p>ë² ë¥´ëˆ„ì´ëŠ” ì €ëª…í•œ ìˆ˜í•™ìž ê°€ë¬¸ì˜ ì¼ì›ìœ¼ë¡œ, ìœ ì²´ì—­í•™, í™•ë¥ ë¡ , í†µê³„í•™ì— í° ì¡±ì ì„ ë‚¨ê¸´ í•™ìžì˜€ë‹¤ <span class="citation" data-cites="straub1970bernoulli">(Straub, 1970)</span>. ê·¸ëŸ¬ë‚˜ ê·¸ì˜ ê°€ìž¥ í˜ì‹ ì ì¸ ì—…ì  ì¤‘ í•˜ë‚˜ëŠ” ì˜í•™ ë¶„ì•¼ì—ì„œ ì´ë£¨ì–´ì¡Œë‹¤. 1760ë…„ ê·¸ëŠ” íŒŒë¦¬ ê³¼í•™ ì•„ì¹´ë°ë¯¸(AcadÃ©mie Royale des Sciences)ì—ì„œ ì²œì—°ë‘ ì‚¬ë§ë¥ ê³¼ ì ‘ì¢…ì˜ ì´ì ì— ê´€í•œ ìƒˆë¡œìš´ ë¶„ì„ ë°©ë²•ì— ëŒ€í•œ ë°œí‘œë¥¼ í–ˆë‹¤ <span class="citation" data-cites="bernoulli1766essai">(Bernoulli, 1766)</span>. ì´ ì—°êµ¬ëŠ” 1766ë…„ì— ì¶œíŒë˜ì—ˆìœ¼ë©°, ì¸ë¥˜ ì—­ì‚¬ìƒ ìµœì´ˆë¡œ ì „ì—¼ë³‘ì„ ìˆ˜í•™ì ìœ¼ë¡œ ëª¨ë¸ë§í•œ ì‹œë„ë¡œ í‰ê°€ë°›ëŠ”ë‹¤ <span class="citation" data-cites="dietz2002daniel">(Dietz &amp; Heesterbeek, 2002)</span>.</p>
</section>
<section id="ë² ë¥´ëˆ„ì´ì˜-ì›ë¬¸-ì—°êµ¬-essai-dune-nouvelle-analyse" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="ë² ë¥´ëˆ„ì´ì˜-ì›ë¬¸-ì—°êµ¬-essai-dune-nouvelle-analyse"><span class="header-section-number">2</span> ë² ë¥´ëˆ„ì´ì˜ ì›ë¬¸ ì—°êµ¬: â€œEssai dâ€™une nouvelle analyseâ€</h2>
<p>ë² ë¥´ëˆ„ì´ì˜ ë…¼ë¬¸ â€œEssai dâ€™une nouvelle analyse de la mortalitÃ© causÃ©e par la petite vÃ©role, et des avantages de lâ€™inoculation pour la prÃ©venirâ€(ì²œì—°ë‘ë¡œ ì¸í•œ ì‚¬ë§ë¥ ê³¼ ì´ë¥¼ ì˜ˆë°©í•˜ê¸° ìœ„í•œ ì ‘ì¢…ì˜ ì´ì ì— ê´€í•œ ìƒˆë¡œìš´ ë¶„ì„ ì‹œë„)ëŠ” ê°„ë‹¨í•œ ì œëª© ì†ì— í˜ëª…ì ì¸ ë‚´ìš©ì„ ë‹´ê³  ìžˆì—ˆë‹¤ <span class="citation" data-cites="bernoulli1766essai">(Bernoulli, 1766)</span>. ì´ ë…¼ë¬¸ì€ ìˆ˜í•™ì  ë°©ë²•ì„ ì‚¬ìš©í•˜ì—¬ ê³µì¤‘ë³´ê±´ ë¬¸ì œë¥¼ ë¶„ì„í•œ ìµœì´ˆì˜ ì‹œë„ ì¤‘ í•˜ë‚˜ì˜€ë‹¤.</p>
<p>ë² ë¥´ëˆ„ì´ëŠ” ë…¼ë¬¸ì˜ ì„œë‘ì— ìžì‹ ì˜ ì˜ë„ë¥¼ ëª…í™•ížˆ ë°í˜”ë‹¤. ê·¸ëŠ” â€œì¸ë¥˜ì˜ ë³µì§€ì— ë°€ì ‘í•œ ê´€ë ¨ì´ ìžˆëŠ” ë¬¸ì œì— ìžˆì–´ì„œ, ì•½ê°„ì˜ ë¶„ì„ê³¼ ê³„ì‚°ì´ ì œê³µí•  ìˆ˜ ìžˆëŠ” ëª¨ë“  ì§€ì‹ ì—†ì´ëŠ” ì–´ë–¤ ê²°ì •ë„ ë‚´ë ¤ì„œëŠ” ì•ˆ ëœë‹¤â€ê³  ì£¼ìž¥í–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>. ì´ëŠ” 200ì—¬ ë…„ í›„ í˜„ëŒ€ ì˜í•™ì´ ì¦ê±° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì„ ì§€í–¥í•˜ê²Œ ë  ê²ƒì„ ì˜ˆê²¬í•œ ì„ êµ¬ì  ë°œì–¸ì´ì—ˆë‹¤.</p>
<p>ë² ë¥´ëˆ„ì´ê°€ ì´ ì—°êµ¬ë¥¼ ì‹œìž‘í•œ ë°°ê²½ì—ëŠ” ë‹¹ì‹œ ìœ ëŸ½ì—ì„œ ì§„í–‰ë˜ê³  ìžˆë˜ ì¸ë‘ë²•(variolation)ì— ëŒ€í•œ ê²©ë ¬í•œ ë…¼ìŸì´ ìžˆì—ˆë‹¤. ì¸ë‘ë²•ì€ ì²œì—°ë‘ì— ê±¸ë¦° í™˜ìžì˜ ê³ ë¦„ì´ë‚˜ ë”±ì§€ë¥¼ ê±´ê°•í•œ ì‚¬ëžŒì—ê²Œ ì˜ë„ì ìœ¼ë¡œ ì ‘ì¢…í•˜ì—¬ ì•½í•œ í˜•íƒœì˜ ì§ˆë³‘ì„ ìœ ë°œí•˜ê³  ë©´ì—­ì„ íšë“í•˜ê²Œ í•˜ëŠ” ë°©ë²•ì´ì—ˆë‹¤ <span class="citation" data-cites="razzell1977conquest">(Razzell, 1977)</span>. ë™ì–‘ì—ì„œ ìœ ëž˜í•œ ì´ ë°©ë²•ì€ 18ì„¸ê¸° ì´ˆ ìœ ëŸ½ì— ë„ìž…ë˜ì—ˆìœ¼ë‚˜, ë•Œë•Œë¡œ ì¤‘ì¦ ì§ˆí™˜ì´ë‚˜ ì‚¬ë§ì„ ì´ˆëž˜í•  ìˆ˜ ìžˆì–´ ë…¼ëž€ì´ ë§Žì•˜ë‹¤ <span class="citation" data-cites="ioannidis2020how">(Ioannidis, 2020)</span>.</p>
<p>ë² ë¥´ëˆ„ì´ëŠ” ì´ ë…¼ìŸì— ê³¼í•™ì  ê´€ì ì—ì„œ ê°œìž…í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤. ê·¸ëŠ” ì²œì—°ë‘ì™€ ì¸ë‘ë²•ì˜ ìœ„í—˜ì„ ìˆ˜í•™ì ìœ¼ë¡œ ë¹„êµí•˜ì—¬, ì¸ë‘ë²•ì´ ì „ì²´ ì¸êµ¬ì˜ ê±´ê°•ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•˜ê³ ìž í–ˆë‹¤ <span class="citation" data-cites="dietz2000bernoulli">(Dietz &amp; Heesterbeek, 2000)</span>.</p>
</section>
<section id="ë² ë¥´ëˆ„ì´ì˜-ìˆ˜í•™ì -ì ‘ê·¼ë²•" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="ë² ë¥´ëˆ„ì´ì˜-ìˆ˜í•™ì -ì ‘ê·¼ë²•"><span class="header-section-number">3</span> ë² ë¥´ëˆ„ì´ì˜ ìˆ˜í•™ì  ì ‘ê·¼ë²•</h2>
<p>ë² ë¥´ëˆ„ì´ëŠ” ì²œì—°ë‘ì˜ ì—­í•™ì„ ì´í•´í•˜ê¸° ìœ„í•´ ë‘ ê°€ì§€ í•µì‹¬ ê°€ì •ì„ ì„¤ì •í–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>:</p>
<ol type="1">
<li><p>ì²œì—°ë‘ì— ê±¸ë¦¬ì§€ ì•Šì€ ì‚¬ëžŒë“¤ì´ ë§¤ë…„ ì§ˆë³‘ì— ê°ì—¼ë  ìœ„í—˜(ê°ì—¼ë¥ )ì€ ì—°ë ¹ì— ê´€ê³„ì—†ì´ ì¼ì •í•˜ë‹¤. ë² ë¥´ëˆ„ì´ëŠ” ì´ ê°’ì„ n = 8ë¡œ ì„¤ì •í–ˆë‹¤(ì¦‰, ë§¤ë…„ ê°ì—¼ë˜ì§€ ì•Šì€ ì‚¬ëžŒ ì¤‘ 1/8ì´ ê°ì—¼ëœë‹¤).</p></li>
<li><p>ì²œì—°ë‘ì— ê±¸ë¦° ì‚¬ëžŒì´ ì´ ì§ˆë³‘ìœ¼ë¡œ ì‚¬ë§í•  ìœ„í—˜(ì¹˜ëª…ë¥ )ë„ ì—°ë ¹ì— ê´€ê³„ì—†ì´ ì¼ì •í•˜ë‹¤. ë² ë¥´ëˆ„ì´ëŠ” ì´ ê°’ì„ m = 8ë¡œ ì„¤ì •í–ˆë‹¤(ì¦‰, ê°ì—¼ìžì˜ 1/8ì´ ì‚¬ë§í•œë‹¤).</p></li>
</ol>
<p>ì´ëŸ¬í•œ ê°€ì •ì„ ë°”íƒ•ìœ¼ë¡œ ë² ë¥´ëˆ„ì´ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë¯¸ë¶„ë°©ì •ì‹ì„ ë„ì¶œí–ˆë‹¤ <span class="citation" data-cites="dietz2002daniel">(Dietz &amp; Heesterbeek, 2002)</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7Bds%7D%7Bdt%7D%20=%20%5Cfrac%7Bs%7D%7Bn%7D%20-%20%5Cfrac%7Bsd%5Cpi%7D%7B%5Cpi%7D%20-%20%5Cfrac%7Bs%5E2dx%7D%7Bmn%5Cpi%7D%0A"></p>
<p>ì—¬ê¸°ì„œ: - <img src="https://latex.codecogs.com/png.latex?s">ëŠ” íŠ¹ì • ì—°ë ¹ì—ì„œ ì²œì—°ë‘ì— ê±¸ë¦¬ì§€ ì•Šì€ ì‚¬ëžŒì˜ ìˆ˜ - <img src="https://latex.codecogs.com/png.latex?%5Cpi">ëŠ” ë™ì¼ ì—°ë ¹ì—ì„œ ìƒì¡´ìž ì´ìˆ˜ - <img src="https://latex.codecogs.com/png.latex?t">ëŠ” ì—°ë ¹(ë…„) - <img src="https://latex.codecogs.com/png.latex?n">ê³¼ <img src="https://latex.codecogs.com/png.latex?m">ì€ ì•žì„œ ì •ì˜í•œ ê°ì—¼ë¥ ê³¼ ì¹˜ëª…ë¥  ê´€ë ¨ ë§¤ê°œë³€ìˆ˜</p>
<p>ë² ë¥´ëˆ„ì´ëŠ” ì´ ë¯¸ë¶„ë°©ì •ì‹ì„ ì ë¶„í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ í•´ë¥¼ êµ¬í–ˆë‹¤ <span class="citation" data-cites="dietz2002daniel">(Dietz &amp; Heesterbeek, 2002)</span>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0As%20=%20%5Cfrac%7Bm%5Cpi%7D%7B(m-1)e%5E%7Bt/n%7D%20+%201%7D%0A"></p>
<p>ì´ ë°©ì •ì‹ì„ í†µí•´ ë² ë¥´ëˆ„ì´ëŠ” ê° ì—°ë ¹ëŒ€ë³„ë¡œ ì²œì—°ë‘ì— ê°ì—¼ë˜ì§€ ì•Šì€ ì‚¬ëžŒë“¤ì˜ ë¹„ìœ¨ê³¼ ì²œì—°ë‘ë¡œ ì¸í•œ ì‚¬ë§ìž ìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ìžˆì—ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>.</p>
</section>
<section id="ë² ë¥´ëˆ„ì´ì˜-ì£¼ìš”-ë°œê²¬" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="ë² ë¥´ëˆ„ì´ì˜-ì£¼ìš”-ë°œê²¬"><span class="header-section-number">4</span> ë² ë¥´ëˆ„ì´ì˜ ì£¼ìš” ë°œê²¬</h2>
<p>ë² ë¥´ëˆ„ì´ëŠ” ì—ë“œë¨¼ë“œ í• ë¦¬(Edmund Halley)ì˜ ìƒëª…í‘œë¥¼ ë°”íƒ•ìœ¼ë¡œ, 1,300ëª…ì˜ ì‹ ìƒì•„ë¡œ ì‹œìž‘í•˜ëŠ” ì½”í˜¸íŠ¸ ë¶„ì„ì„ ì‹¤ì‹œí–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>. ê·¸ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” ê²°ê³¼ë¥¼ ë„ì¶œí–ˆë‹¤:</p>
<ol type="1">
<li><p><strong>ì²œì—°ë‘ ì œê±° íš¨ê³¼</strong>: ì²œì—°ë‘ê°€ ì™„ì „ížˆ ì œê±°ëœë‹¤ë©´, 25ì„¸ì— ë„ë‹¬í•˜ëŠ” ì‚¬ëžŒì˜ ìˆ˜ëŠ” 565ëª…ì—ì„œ 644ëª…ìœ¼ë¡œ ì¦ê°€í•  ê²ƒì´ë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>.</p></li>
<li><p><strong>ê¸°ëŒ€ìˆ˜ëª… ì¦ê°€</strong>: ì²œì—°ë‘ ì œê±°ëŠ” ì¶œìƒ ì‹œ ê¸°ëŒ€ìˆ˜ëª…ì„ 26ë…„ 7ê°œì›”ì—ì„œ 29ë…„ 9ê°œì›”ë¡œ, ì•½ 3ë…„ 2ê°œì›” ì¦ê°€ì‹œí‚¬ ê²ƒì´ë‹¤ <span class="citation" data-cites="dietz2002daniel">(Dietz &amp; Heesterbeek, 2002)</span>.</p></li>
<li><p><strong>ì¸ë‘ë²•ì˜ ìž„ê³„ê°’</strong>: ë² ë¥´ëˆ„ì´ëŠ” ì¸ë‘ë²•ìœ¼ë¡œ ì¸í•œ ì‚¬ë§ ìœ„í—˜ì´ 11% ë¯¸ë§Œì´ë¼ë©´, ì´ ë°©ë²•ì´ ì „ì²´ ì¸êµ¬ì— ì´ë“ì´ ë  ê²ƒì´ë¼ê³  ê³„ì‚°í–ˆë‹¤ <span class="citation" data-cites="bacaer2011smallpox">(BacaÃ«r, 2011)</span>. ë‹¹ì‹œ ì¸ë‘ë²•ì˜ ì¶”ì • ì‚¬ë§ë¥ ì€ 1-2%ì˜€ìœ¼ë¯€ë¡œ, ë² ë¥´ëˆ„ì´ëŠ” ì¸ë‘ë²•ì„ ì§€ì§€í•˜ëŠ” ê²°ë¡ ì— ë„ë‹¬í–ˆë‹¤.</p></li>
<li><p><strong>ìƒëŒ€ì  ì´ë“</strong>: ì—°ë ¹ì´ ì¦ê°€í•¨ì— ë”°ë¼ ì²œì—°ë‘ ì œê±°ì˜ ìƒëŒ€ì  ì´ë“ì´ ì¦ê°€í•˜ì—¬, 25ì„¸ì—ëŠ” ìƒì¡´ìž ìˆ˜ê°€ ìžì—° ìƒíƒœë³´ë‹¤ ì•½ 1/7 ë” ë§Žì•„ì§ˆ ê²ƒìœ¼ë¡œ ì˜ˆì¸¡í–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>.</p></li>
</ol>
<p>ë² ë¥´ëˆ„ì´ì˜ ë¶„ì„ì€ ì¸ë‘ë²•ì´ ê°œì¸ë¿ë§Œ ì•„ë‹ˆë¼ ì‚¬íšŒ ì „ì²´ì— ì´ìµì´ ëœë‹¤ëŠ” ê²ƒì„ ìˆ˜í•™ì ìœ¼ë¡œ ì¦ëª…í–ˆë‹¤. ê·¸ëŠ” â€œì‹œë¯¼ ìƒëª…â€(Civil Life)ì´ë¼ëŠ” ê°œë…ì„ ë„ìž…í•˜ì—¬, 17ì„¸ ì´í›„ë¶€í„° êµ­ê°€ì™€ ì‚¬íšŒì— ê¸°ì—¬í•  ìˆ˜ ìžˆëŠ” ì‹œê¸°ì— ì£¼ëª©í–ˆë‹¤ <span class="citation" data-cites="ioannidis2020how">(Ioannidis, 2020)</span>. ê·¸ì˜ ê³„ì‚°ì— ë”°ë¥´ë©´, ì¸ë‘ë²•ì˜ ë³´íŽ¸ì  ì‹œí–‰ìœ¼ë¡œ í”„ëž‘ìŠ¤ëŠ” ë§¤ë…„ 25,000ëª…ì˜ ì¶”ê°€ì ì¸ â€œìœ ìš©í•œ ì‹œë¯¼ ìƒëª…â€ì„ ì–»ì„ ìˆ˜ ìžˆì—ˆë‹¤.</p>
</section>
<section id="ë² ë¥´ëˆ„ì´ì™€-ë‹¬ëž‘ë² ë¥´ì˜-ë…¼ìŸ" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="ë² ë¥´ëˆ„ì´ì™€-ë‹¬ëž‘ë² ë¥´ì˜-ë…¼ìŸ"><span class="header-section-number">5</span> ë² ë¥´ëˆ„ì´ì™€ ë‹¬ëž‘ë² ë¥´ì˜ ë…¼ìŸ</h2>
<p>ë² ë¥´ëˆ„ì´ì˜ ì—°êµ¬ëŠ” ë‹¹ì‹œ ë˜ ë‹¤ë¥¸ ì €ëª…í•œ ìˆ˜í•™ìžì¸ ìž¥ ë¥´ ë¡± ë‹¬ëž‘ë² ë¥´(Jean le Rond dâ€™Alembert)ì™€ì˜ ë…¼ìŸì„ ë¶ˆëŸ¬ì¼ìœ¼ì¼°ë‹¤. ë‹¬ëž‘ë² ë¥´ëŠ” 1761ë…„ ì¸ë‘ë²•ì— ê´€í•œ ìžì‹ ì˜ ë¶„ì„ì„ ë°œí‘œí•˜ë©° ë² ë¥´ëˆ„ì´ì˜ ì ‘ê·¼ë²•ì„ ë¹„íŒí–ˆë‹¤ <span class="citation" data-cites="ioannidis2020how">(Ioannidis, 2020)</span>.</p>
<p>ë‹¬ëž‘ë² ë¥´ëŠ” ë² ë¥´ëˆ„ì´ì˜ ëª¨ë¸ì´ ë„ˆë¬´ ë‹¨ìˆœí•˜ë‹¤ê³  ì£¼ìž¥í–ˆë‹¤. ê·¸ëŠ” íŠ¹ížˆ ë‘ ê°€ì§€ ì¸¡ë©´ì—ì„œ ë¹„íŒì„ ì œê¸°í–ˆë‹¤ <span class="citation" data-cites="bacaer2011smallpox">(BacaÃ«r, 2011)</span>:</p>
<ol type="1">
<li><p><strong>ì¦‰ê°ì  ìœ„í—˜ê³¼ ë¯¸ëž˜ ì´ìµ</strong>: ë‹¬ëž‘ë² ë¥´ëŠ” ì¸ë‘ë²•ì˜ ì¦‰ê°ì ì¸ ì‚¬ë§ ìœ„í—˜ê³¼ ë¯¸ëž˜ì˜ ìž ìž¬ì  ì´ìµì„ ë‹¨ìˆœížˆ í‰ê· í™”í•˜ëŠ” ê²ƒì— ì˜ë¬¸ì„ ì œê¸°í–ˆë‹¤. ê·¸ëŠ” ë‹¹ìž¥ì˜ ì‚¬ë§ ìœ„í—˜ê³¼ ë¯¸ëž˜ì˜ ì´ìµì„ ë™ë“±í•˜ê²Œ ì·¨ê¸‰í•˜ëŠ” ê²ƒì´ ë…¼ë¦¬ì ì´ì§€ ì•Šë‹¤ê³  ìƒê°í–ˆë‹¤.</p></li>
<li><p><strong>ê°œì¸ê³¼ ì‚¬íšŒ</strong>: ë‹¬ëž‘ë² ë¥´ëŠ” ì‚¬íšŒ ì „ì²´ì— ëŒ€í•œ ì´ìµì´ ê°œì¸ì˜ ìœ„í—˜ì„ ì •ë‹¹í™”í•˜ì§€ ëª»í•  ìˆ˜ ìžˆë‹¤ê³  ì£¼ìž¥í–ˆë‹¤. ê·¸ì—ê²ŒëŠ” ì¸ë‘ë²•ìœ¼ë¡œ ì¸í•œ ì¦‰ê°ì  ì‚¬ë§ ìœ„í—˜ì„ ê°ìˆ˜í•´ì•¼ í•˜ëŠ” ê°œì¸ì˜ ê´€ì ì´ ì¤‘ìš”í–ˆë‹¤.</p></li>
</ol>
<p>ì´ ë…¼ìŸì€ ë‹¨ìˆœížˆ ìˆ˜í•™ì  ëª¨ë¸ì˜ ì •í™•ì„±ì— ê´€í•œ ê²ƒì´ ì•„ë‹ˆë¼, ì˜í•™ì  ê²°ì •ì—ì„œ ìœ„í—˜ê³¼ ì´ìµì„ í‰ê°€í•˜ëŠ” ë°©ë²•ê³¼ ê°œì¸ì˜ ìžìœ¨ì„± ëŒ€ ê³µì¤‘ë³´ê±´ì˜ ê´€ê³„ì— ê´€í•œ ê¹Šì€ ì² í•™ì  ì§ˆë¬¸ì„ ì œê¸°í–ˆë‹¤ <span class="citation" data-cites="ioannidis2020how">(Ioannidis, 2020)</span>. ì´ëŠ” ì˜¤ëŠ˜ë‚ ê¹Œì§€ë„ ì˜ˆë°©ì ‘ì¢… ì •ì±…ê³¼ ê³µì¤‘ë³´ê±´ ìœ¤ë¦¬ì—ì„œ ì¤‘ìš”í•œ ì£¼ì œë¡œ ë‚¨ì•„ìžˆë‹¤.</p>
</section>
<section id="ë² ë¥´ëˆ„ì´-ì—°êµ¬ì˜-ì—­ì‚¬ì -ì˜ì˜" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="ë² ë¥´ëˆ„ì´-ì—°êµ¬ì˜-ì—­ì‚¬ì -ì˜ì˜"><span class="header-section-number">6</span> ë² ë¥´ëˆ„ì´ ì—°êµ¬ì˜ ì—­ì‚¬ì  ì˜ì˜</h2>
<p>ë² ë¥´ëˆ„ì´ì˜ ì—°êµ¬ëŠ” ì—¬ëŸ¬ ì¸¡ë©´ì—ì„œ ì—­ì‚¬ì  ì˜ë¯¸ë¥¼ ê°–ëŠ”ë‹¤:</p>
<ol type="1">
<li><p><strong>ì—­í•™ì˜ ì‹œìž‘</strong>: ë² ë¥´ëˆ„ì´ì˜ ëª¨ë¸ì€ ì—­í•™(epidemiology)ì´ë¼ëŠ” í•™ë¬¸ ë¶„ì•¼ì˜ ìˆ˜í•™ì  ê¸°ì´ˆë¥¼ ë§ˆë ¨í–ˆë‹¤ <span class="citation" data-cites="dietz2000bernoulli">(Dietz &amp; Heesterbeek, 2000)</span>. ê·¸ëŠ” ì§ˆë³‘ì˜ ì „íŒŒì™€ ì¸êµ¬ ë™íƒœë¥¼ ìˆ˜í•™ì ìœ¼ë¡œ ë¶„ì„í•˜ëŠ” ë°©ë²•ì„ ê°œì²™í–ˆë‹¤.</p></li>
<li><p><strong>ì¦ê±° ê¸°ë°˜ ì˜í•™ì˜ ì„ êµ¬ìž</strong>: ë² ë¥´ëˆ„ì´ëŠ” ì˜í•™ì  ê°œìž…ì˜ íš¨ê³¼ë¥¼ ì‹¤ì¦ì  ë°ì´í„°ì™€ ìˆ˜í•™ì  ë¶„ì„ì„ í†µí•´ í‰ê°€í–ˆë‹¤ <span class="citation" data-cites="fine1975ross">(Fine, 1975)</span>. ì´ëŠ” í˜„ëŒ€ ì¦ê±° ê¸°ë°˜ ì˜í•™ì˜ í•µì‹¬ ì›ì¹™ì„ ì˜ˆê²¬í•œ ê²ƒì´ì—ˆë‹¤.</p></li>
<li><p><strong>ì˜ì‚¬ê²°ì • ì´ë¡ </strong>: ë² ë¥´ëˆ„ì´ì˜ ë¶„ì„ì€ ë¶ˆí™•ì‹¤ì„± í•˜ì—ì„œì˜ ì˜ì‚¬ê²°ì •, ìœ„í—˜-ì´ìµ í‰ê°€ ë“± í˜„ëŒ€ ì˜ì‚¬ê²°ì • ì´ë¡ ì˜ ì¤‘ìš”í•œ ê°œë…ë“¤ì„ ë„ìž…í–ˆë‹¤ <span class="citation" data-cites="ioannidis2020how">(Ioannidis, 2020)</span>.</p></li>
<li><p><strong>ê³µì¤‘ë³´ê±´ ì •ì±…</strong>: ë² ë¥´ëˆ„ì´ëŠ” ìˆ˜í•™ì  ëª¨ë¸ì„ í™œìš©í•˜ì—¬ ê³µì¤‘ë³´ê±´ ì •ì±…ì„ ì§€ì§€í•˜ëŠ” ìµœì´ˆì˜ ì‹œë„ë¥¼ í–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>. ê·¸ì˜ ì—°êµ¬ëŠ” í˜„ëŒ€ ê³µì¤‘ë³´ê±´ ì •ì±… ê²°ì •ì—ì„œ ëª¨ë¸ë§ì˜ ì¤‘ìš”í•œ ì—­í• ì„ ì˜ˆê²¬í–ˆë‹¤.</p></li>
</ol>
</section>
<section id="í˜„ëŒ€ì -ê´€ì ì—ì„œ-ë³¸-ë² ë¥´ëˆ„ì´ì˜-ì—°êµ¬" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="í˜„ëŒ€ì -ê´€ì ì—ì„œ-ë³¸-ë² ë¥´ëˆ„ì´ì˜-ì—°êµ¬"><span class="header-section-number">7</span> í˜„ëŒ€ì  ê´€ì ì—ì„œ ë³¸ ë² ë¥´ëˆ„ì´ì˜ ì—°êµ¬</h2>
<p>í˜„ëŒ€ ì—­í•™ìžë“¤ì€ ë² ë¥´ëˆ„ì´ì˜ ì—°êµ¬ë¥¼ ìž¬í‰ê°€í•˜ë©° ê·¸ ê°€ì¹˜ë¥¼ ìž¬í™•ì¸í–ˆë‹¤. ë””ì¸ ì™€ ížˆìŠ¤í„°ë²¡ì€ 2000ë…„ â€™Natureâ€™ì§€ì— â€œë² ë¥´ëˆ„ì´ëŠ” í˜„ëŒ€ ì—­í•™ë³´ë‹¤ ì•žì„œ ìžˆì—ˆë‹¤â€ëŠ” ì œëª©ì˜ ë…¼ë¬¸ì„ ë°œí‘œí–ˆë‹¤ <span class="citation" data-cites="dietz2000bernoulli">(Dietz &amp; Heesterbeek, 2000)</span>. ê·¸ë“¤ì€ ë² ë¥´ëˆ„ì´ê°€ ê°ì—¼ë³‘ì˜ ì—­í•™ì— ê´€í•œ í˜„ëŒ€ì  í†µì°°ì„ 200ë…„ ì´ìƒ ì•žì„œ ì œì‹œí–ˆìŒì„ ê°•ì¡°í–ˆë‹¤.</p>
<p>ë² ë¥´ëˆ„ì´ì˜ ëª¨ë¸ì€ ì˜¤ëŠ˜ë‚ ì˜ í‘œì¤€ì—ì„œ ë³¼ ë•Œ ë‹¨ìˆœí•˜ì§€ë§Œ, ê·¸ì˜ ì ‘ê·¼ ë°©ì‹ì˜ ë³¸ì§ˆì€ ì—¬ì „ížˆ ìœ íš¨í•˜ë‹¤. í˜„ëŒ€ ê°ì—¼ë³‘ ëª¨ë¸ë§ì€ ë² ë¥´ëˆ„ì´ì˜ ê¸°ë³¸ í‹€ì„ í™•ìž¥í•˜ì—¬ ë” ë³µìž¡í•œ ìš”ì†Œë“¤ì„ í¬í•¨í•˜ê³  ìžˆë‹¤ <span class="citation" data-cites="anderson1991infectious">(Anderson et al., 1991)</span>:</p>
<ol type="1">
<li>ì—°ë ¹ ì˜ì¡´ì  ê°ì—¼ë¥ ê³¼ ì¹˜ëª…ë¥ </li>
<li>ì¸êµ¬ ì´ì§ˆì„±ê³¼ ì‚¬íšŒì  ì ‘ì´‰ íŒ¨í„´</li>
<li>ì§ˆë³‘ì˜ ìž ë³µê¸°ì™€ ì „ì—¼ê¸°</li>
<li>ë©´ì—­ì˜ íšë“ê³¼ ì†Œì‹¤</li>
<li>ê³µê°„ì  í™•ì‚° íŒ¨í„´</li>
</ol>
<p>ì´ëŸ¬í•œ ë°œì „ì—ë„ ë¶ˆêµ¬í•˜ê³ , ë² ë¥´ëˆ„ì´ê°€ 18ì„¸ê¸°ì— ì œì‹œí•œ ê¸°ë³¸ì ì¸ í†µì°° - ì²œì—°ë‘ì™€ ê°™ì€ ì§ˆë³‘ì˜ ì „íŒŒ ì—­í•™ì„ ì´í•´í•˜ê³  ì˜ˆë°© ì ‘ì¢…ê³¼ ê°™ì€ ê°œìž…ì˜ íš¨ê³¼ë¥¼ í‰ê°€í•˜ê¸° ìœ„í•´ ìˆ˜í•™ì  ëª¨ë¸ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆë‹¤ëŠ” ìƒê° - ì€ í˜„ëŒ€ ê°ì—¼ë³‘ ì—­í•™ì˜ ê·¼ê°„ìœ¼ë¡œ ë‚¨ì•„ìžˆë‹¤ <span class="citation" data-cites="heesterbeek2015modeling">(Heesterbeek et al., 2015)</span>.</p>
</section>
<section id="ê²°ë¡ -ë² ë¥´ëˆ„ì´ì˜-ìœ ì‚°" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="ê²°ë¡ -ë² ë¥´ëˆ„ì´ì˜-ìœ ì‚°"><span class="header-section-number">8</span> ê²°ë¡ : ë² ë¥´ëˆ„ì´ì˜ ìœ ì‚°</h2>
<p>ë‹¤ë‹ˆì—˜ ë² ë¥´ëˆ„ì´ì˜ ì²œì—°ë‘ ì—°êµ¬ëŠ” ë‹¨ìˆœížˆ ì—­ì‚¬ì  í˜¸ê¸°ì‹¬ ì´ìƒì˜ ê°€ì¹˜ë¥¼ ì§€ë‹Œë‹¤. ê·¸ì˜ ì—°êµ¬ëŠ” ì¸ë¥˜ê°€ ì²˜ìŒìœ¼ë¡œ ì „ì—¼ë³‘ì— ëŒ€í•­í•˜ëŠ” ê³¼í•™ì  ë„êµ¬ë¡œì„œ ìˆ˜í•™ì„ í™œìš©í•œ ìˆœê°„ì„ ê¸°ë¡í•˜ê³  ìžˆë‹¤ <span class="citation" data-cites="dietz2002daniel">(Dietz &amp; Heesterbeek, 2002)</span>. ë² ë¥´ëˆ„ì´ì˜ ì—…ì ì€ ë‹¨ì§€ ê·¸ê°€ ë°œëª…í•œ ìˆ˜ì‹ì´ë‚˜ ëª¨ë¸ì— ìžˆì§€ ì•Šë‹¤. ê·¸ì˜ ì§„ì •í•œ ìœ ì‚°ì€ ë³µìž¡í•œ ê³µì¤‘ë³´ê±´ ë¬¸ì œì— ëŒ€í•œ í•´ë‹µì„ ì°¾ê¸° ìœ„í•´ ìˆ˜í•™ì  ì‚¬ê³ ë¥¼ ì ìš©í•  ìˆ˜ ìžˆë‹¤ëŠ” ì•„ì´ë””ì–´ì— ìžˆë‹¤.</p>
<p>ì˜¤ëŠ˜ë‚  ìš°ë¦¬ê°€ ì½”ë¡œë‚˜19ë¥¼ ë¹„ë¡¯í•œ ë‹¤ì–‘í•œ ì „ì—¼ë³‘ì— ëŒ€ì‘í•˜ëŠ” ë°©ì‹ì€ 250ë…„ ì „ ë² ë¥´ëˆ„ì´ê°€ ê°œì²™í•œ ì ‘ê·¼ë²•ì˜ ì§ê³„ í›„ì†ì´ë‹¤. ê·¸ëŠ” â€œì¸ë¥˜ì˜ ë³µì§€ì— ë°€ì ‘í•œ ê´€ë ¨ì´ ìžˆëŠ” ë¬¸ì œì— ìžˆì–´ì„œ, ì•½ê°„ì˜ ë¶„ì„ê³¼ ê³„ì‚°ì´ ì œê³µí•  ìˆ˜ ìžˆëŠ” ëª¨ë“  ì§€ì‹ ì—†ì´ëŠ” ì–´ë–¤ ê²°ì •ë„ ë‚´ë ¤ì„œëŠ” ì•ˆ ëœë‹¤â€ê³  ì£¼ìž¥í–ˆë‹¤ <span class="citation" data-cites="blower2004attempt">(Blower &amp; Bernoulli, 2004)</span>. ì´ ì›ì¹™ì€ í˜„ëŒ€ ê³µì¤‘ë³´ê±´ì˜ í•µì‹¬ ê°€ì¹˜ë¡œ ë‚¨ì•„ìžˆë‹¤.</p>
<p>ë² ë¥´ëˆ„ì´ì˜ ì—°êµ¬ëŠ” ìš°ë¦¬ì—ê²Œ ìˆ˜í•™ì€ ë‹¨ìˆœí•œ ì¶”ìƒì  í•™ë¬¸ì´ ì•„ë‹ˆë¼ ìƒëª…ì„ êµ¬í•˜ê³  ì‚¬íšŒë¥¼ ë³´í˜¸í•˜ëŠ” ê°•ë ¥í•œ ë„êµ¬ê°€ ë  ìˆ˜ ìžˆìŒì„ ìƒê¸°ì‹œí‚¨ë‹¤. ê·¸ì˜ ì„ êµ¬ì ì¸ ì—…ì ì€ ì˜¤ëŠ˜ë‚ ê¹Œì§€ë„ ìš°ë¦¬ì—ê²Œ ì˜ê°ì„ ì£¼ë©°, ë³´ì´ì§€ ì•ŠëŠ” ì ë“¤ê³¼ì˜ ì‹¸ì›€ì—ì„œ ì¸ë¥˜ì˜ ê°€ìž¥ ê°•ë ¥í•œ ë¬´ê¸° ì¤‘ í•˜ë‚˜ê°€ ë°”ë¡œ ìˆ˜í•™ìž„ì„ ë³´ì—¬ì¤€ë‹¤.</p>
</section>
<section id="ì°¸ê³ ë¬¸í—Œ" class="level2" data-number="9">

<!-- ```{=html} -->
<!-- <div id="refs"></div> -->
<!-- ``` -->



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">9 ì°¸ê³ ë¬¸í—Œ</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2">
<div id="ref-anderson1991infectious" class="csl-entry">
Anderson, R. M., May, R. M., &amp; Anderson, B. (1991). <em>Infectious diseases of humans: Dynamics and control</em>. Oxford university press.
</div>
<div id="ref-bacaer2011smallpox" class="csl-entry">
BacaÃ«r, N. (2011). Daniel bernoulli, dâ€™alembert and the inoculation of smallpox (1760). <em>A Short History of Mathematical Population Dynamics</em>, 21â€“30.
</div>
<div id="ref-bernoulli1766essai" class="csl-entry">
Bernoulli, D. (1766). Essai dâ€™une nouvelle analyse de la mortalit<span>Ã©</span> caus<span>Ã©</span>e par la petite v<span>Ã©</span>role et des avantages de lâ€™inoculation pour la pr<span>Ã©</span>venir. <em>M<span>Ã©</span>moires de Math<span>Ã©</span>matiques Et de Physique, Acad<span>Ã©</span>mie Royale Des Sciences, Paris</em>, 1â€“45.
</div>
<div id="ref-blower2004attempt" class="csl-entry">
Blower, S., &amp; Bernoulli, D. (2004). An attempt at a new analysis of the mortality caused by smallpox and of the advantages of inoculation to prevent it. 1766. <em>Reviews in Medical Virology</em>, <em>14</em>(5), 275â€“288.
</div>
<div id="ref-dietz2000bernoulli" class="csl-entry">
Dietz, K., &amp; Heesterbeek, J. (2000). Bernoulli was ahead of modern epidemiology. <em>Nature</em>, <em>408</em>(6812), 513â€“514.
</div>
<div id="ref-dietz2002daniel" class="csl-entry">
Dietz, K., &amp; Heesterbeek, J. (2002). Daniel bernoulliâ€™s epidemiological model revisited. <em>Mathematical Biosciences</em>, <em>180</em>(1-2), 1â€“21.
</div>
<div id="ref-fine1975ross" class="csl-entry">
Fine, P. E. (1975). Rossâ€™s a priori pathometry - a perspective. <em>Proceedings of the Royal Society of Medicine</em>, <em>68</em>(8), 547â€“551.
</div>
<div id="ref-heesterbeek2015modeling" class="csl-entry">
Heesterbeek, H., Anderson, R. M., Andreasen, V., Bansal, S., De Angelis, D., Dye, C., Eames, K. T., Edmunds, W. J., Frost, S. D., Funk, S., et al. (2015). Modeling infectious disease dynamics in the complex landscape of global health. <em>Science</em>, <em>347</em>(6227).
</div>
<div id="ref-ioannidis2020how" class="csl-entry">
Ioannidis, E. (2020). How history of mathematics can help to face a crisis situation: The case of the polemic between bernoulli and dâ€™alembert about the smallpox epidemic. <em>ZDM Mathematics Education</em>, <em>54</em>, 569â€“581.
</div>
<div id="ref-razzell1977conquest" class="csl-entry">
Razzell, P. E. (1977). <em>The conquest of smallpox: The impact of inoculation on smallpox mortality in eighteenth century britain</em>. Caliban Books.
</div>
<div id="ref-straub1970bernoulli" class="csl-entry">
Straub, H. (1970). Bernoulli, daniel. <em>Dictionary of Scientific Biography</em>, <em>2</em>, 36â€“46.
</div>
</div></section></div> ]]></description>
  <category>ê°ì—¼ë³‘</category>
  <category>ìˆ˜ë¦¬ëª¨í˜•</category>
  <category>ì—­í•™</category>
  <category>ì—­ì‚¬</category>
  <guid>https://www.jonghoonk.com/blog/posts/book_bernoulli_math_model_smallpox/index.html</guid>
  <pubDate>Mon, 05 May 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>ì™œ ìˆ˜í•™ìœ¼ë¡œ ê°ì—¼ë³‘ì„ ì„¤ëª…í•˜ëŠ”ê°€?</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/book_math_model_why_kor/index.html</link>
  <description><![CDATA[ 



<section id="ì™œ-ìˆ˜í•™ìœ¼ë¡œ-ê°ì—¼ë³‘ì„-ì„¤ëª…í•˜ëŠ”ê°€" class="level1">
<h1>ì™œ ìˆ˜í•™ìœ¼ë¡œ ê°ì—¼ë³‘ì„ ì„¤ëª…í•˜ëŠ”ê°€?</h1>
<p>ìˆ˜í•™ì€ ì„¸ìƒì„ ì„¤ëª…í•˜ëŠ” ì–¸ì–´ë‹¤. [ì „í†µì ì¸ text. í˜¹ì€ ìœ í´ë¦¬ë“œ, ì•„ë¥´ì¼€ë©”ë°ìŠ¤, ] ë°”ì´ëŸ¬ìŠ¤ëŠ” ìˆ«ìžë¥¼ ëª¨ë¥¸ë‹¤. ë°”ì´ëŸ¬ìŠ¤ ì–´ë–¤ ìˆ˜ì‹ì„ ê³„ì‚°í•´ì„œ ë‹¤ìŒ ë‚  í™˜ìžìˆ˜ë¥¼ ê²°ì •í•˜ì§€ëŠ” ì•Šì„ ê²ƒì´ë‹¤. ê·¸ëŸ°ë° ìš°ë¦¬ëŠ” ë°”ì´ëŸ¬ìŠ¤ì˜ ì „íŒŒ ê³¼ì •ì„ ìˆ«ìžë¡œ ì„¤ëª…í•œë‹¤. ì™œ ê·¸ëŸ´ê¹Œ?</p>
<p>ìˆ˜ì‹ì„ ì´ìš©í•˜ëŠ” ë°©ë²•ì´ ì„¸ìƒì„ ì´í•´í•˜ëŠ” ë°ì— ê½¤ ê´œì°®ë‹¤. ì½”ë¡œë‚˜19ê°€ í„°ì¡Œì„ ë•Œ ì‚¬ëžŒë“¤ì€ â€˜í•˜ë£¨ í™•ì§„ìž ìˆ˜â€™, â€˜ëˆ„ì  ê°ì—¼ìžâ€™, â€˜ê°ì—¼ìž¬ìƒì‚°ì§€ìˆ˜ (<img src="https://latex.codecogs.com/png.latex?R">)â€™ ê°™ì€ ìˆ«ìžì— ë¯¼ê°í•˜ê²Œ ë°˜ì‘í–ˆë‹¤. ì •ë¶€ì˜ ì •ì±…ì€ ì´ ìˆ«ìžë“¤ì— ë”°ë¼ ì›€ì§ì˜€ë‹¤. í•œêµ­ì—ì„œëŠ” ì‚¬íšŒì  ê±°ë¦¬ë‘ê¸° ë‹¨ê³„ê°€ í™•ì§„ìž ìˆ˜ì— ë”°ë¼ ê²°ì •ë˜ì—ˆê³  <span class="citation" data-cites="kimminsoo2021">(Kim et al., 2021)</span>, ì˜êµ­ì—ì„œëŠ” <img src="https://latex.codecogs.com/png.latex?R">ê°’ì´ 1 ë¯¸ë§Œìœ¼ë¡œ ë–¨ì–´ì§ˆ ë•Œê¹Œì§€ ë´‰ì‡„ ì¡°ì¹˜ë¥¼ ì—°ìž¥í–ˆë‹¤ <span class="citation" data-cites="flaxman2020">(Flaxman et al., 2020)</span>.</p>
<p>ì‚¬ëžŒì„ ë©ˆì¶˜ ê±´ ìˆ«ìžì˜€ë‹¤. ì•„ë‹ˆ, ìˆ«ìžê°€ ë³´ì—¬ì£¼ëŠ” í™•ì‚°ì˜ ì†ë„ì˜€ë‹¤.</p>
<p>ìˆ˜í•™ì€ ê°ì—¼ë³‘ì˜ íë¦„ì„ ì‹œë®¬ë ˆì´ì…˜í•  ìˆ˜ ìžˆê³ , ì˜ˆì¸¡í•  ìˆ˜ ìžˆìœ¼ë©°, ë•Œë¡œëŠ” ë§‰ì„ ìˆ˜ë„ ìžˆë‹¤.</p>
<p>ë‚˜ëŠ” ì´ ì±…ì—ì„œ ê°ì—¼ë³‘ ìˆ˜ë¦¬ ëª¨í˜•ì´ ë¬´ì—‡ì´ê³ , ì™œ ì¤‘ìš”í•œì§€, ê·¸ë¦¬ê³  ì´ê±¸ ì–´ë µì§€ ì•Šê²Œ ì´í•´í•  ìˆ˜ ìžˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ë³´ì—¬ì£¼ê³  ì‹¶ë‹¤.</p>
<p>ì§€ê¸ˆë¶€í„° ìˆ«ìžì™€ ê°ì—¼ë³‘ì˜ ì´ì•¼ê¸°ë¥¼ ì‹œìž‘í•˜ìž.</p>
<section id="ì™œ-ì´-ì´ì•¼ê¸°ê°€-í•„ìš”í•œê°€" class="level2">
<h2 class="anchored" data-anchor-id="ì™œ-ì´-ì´ì•¼ê¸°ê°€-í•„ìš”í•œê°€">ì™œ ì´ ì´ì•¼ê¸°ê°€ í•„ìš”í•œê°€</h2>
<p>2020ë…„ ë´„, ì „ ì„¸ê³„ê°€ ë™ì‹œì— ì •ì§€í–ˆë‹¤. ê±°ë¦¬ì—” ì°¨ê°€ ì—†ê³ , í•™êµì—” í•™ìƒì´ ì—†ì—ˆë‹¤. ì§€êµ¬ ì „ì²´ê°€ â€™ì‚¬íšŒì  ê±°ë¦¬ë‘ê¸°â€™ë¼ëŠ” ë§ì— ë¬¶ì—¬ ì¡°ìš©í•´ì¡Œë‹¤. ê·¸ í˜¼ëž€ ì†ì—ì„œ ë§¤ì¼ ë‰´ìŠ¤ëŠ” ìˆ«ìžë¥¼ ìŸì•„ëƒˆë‹¤.</p>
<p>â€œì˜¤ëŠ˜ í™•ì§„ìž 125ëª…, ëˆ„ì  í™•ì§„ìž 1,532ëª….â€<br>
â€œ<img src="https://latex.codecogs.com/png.latex?R">ê°’ì´ 1.7ì„ ë„˜ì—ˆë‹¤.â€<br>
â€œ2ì£¼ í›„ ì¤‘í™˜ìž ë³‘ìƒì´ ë¶€ì¡±í•´ì§ˆ ìˆ˜ ìžˆë‹¤.â€</p>
<p>ì´ ìˆ«ìžë“¤ì€ ì–´ë””ì„œ ì˜¨ ê±¸ê¹Œ? ëˆ„ê°€ ê³„ì‚°í–ˆì„ê¹Œ? ì–´ë–»ê²Œ ê·¸ë ‡ê²Œ ì˜ˆì¸¡í•  ìˆ˜ ìžˆì—ˆì„ê¹Œ?</p>
<p>ì •ë‹µì€ â€™ëª¨í˜•â€™ì´ë‹¤. ìˆ˜ë¦¬ ëª¨í˜•. ìš°ë¦¬ê°€ ì‹¤ì œ ì„¸ê³„ì˜ íë¦„ì„ ìˆ˜ì‹ê³¼ ë…¼ë¦¬ë¡œ ë°”ê¿” í‘œí˜„í•œ ê²ƒì´ë‹¤.</p>
<p>ìˆ˜í•™ì€ í˜„ì‹¤ì„ ì„¤ëª…í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” ì–¸ì–´ë‹¤. ê°ì—¼ë³‘ë„ ì˜ˆì™¸ê°€ ì•„ë‹ˆë‹¤. ì˜¤ížˆë ¤ ê°ì—¼ë³‘ì€ ìˆ˜í•™ê³¼ ì¹œí•˜ë‹¤. ë°”ì´ëŸ¬ìŠ¤ëŠ” ë…¼ë¦¬ë¥¼ ë”°ë¼ ì›€ì§ì´ê¸° ë•Œë¬¸ì´ë‹¤. ë¬´ìž‘ìœ„ ê°™ì§€ë§Œ, ì•„ë‹ˆë‹¤. ê°ì—¼ì—ëŠ” ê·œì¹™ì´ ìžˆë‹¤. ê·¸ë¦¬ê³  ê·œì¹™ì´ ìžˆë‹¤ë©´, ìˆ˜í•™ìœ¼ë¡œ ê·¸ë¦´ ìˆ˜ ìžˆë‹¤.</p>
</section>
<section id="ì—­ì‚¬-ì†ì˜-ìˆ˜í•™ì -ê°ì—¼ë³‘-ëª¨ë¸" class="level2">
<h2 class="anchored" data-anchor-id="ì—­ì‚¬-ì†ì˜-ìˆ˜í•™ì -ê°ì—¼ë³‘-ëª¨ë¸">ì—­ì‚¬ ì†ì˜ ìˆ˜í•™ì  ê°ì—¼ë³‘ ëª¨ë¸</h2>
<p>ì‚¬ì‹¤ ìˆ˜í•™ìœ¼ë¡œ ê°ì—¼ë³‘ì„ ì„¤ëª…í•˜ëŠ” ì¼ì€ ìƒˆë¡œìš´ ì‹œë„ê°€ ì•„ë‹ˆë‹¤. 1760ë…„, ìŠ¤ìœ„ìŠ¤ì˜ ìˆ˜í•™ìž ë‹¤ë‹ˆì—˜ ë² ë¥´ëˆ„ì´ (Daniel Bernoulli)ëŠ” ì²œì—°ë‘ ì˜ˆë°©ì ‘ì¢…ì˜ íš¨ê³¼ë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•´ ìµœì´ˆì˜ ìˆ˜í•™ì  ì§ˆë³‘ ëª¨ë¸ì„ ë§Œë“¤ì—ˆë‹¤ <span class="citation" data-cites="bernoulli1760">(Bernoulli, 1760)</span>. ê·¸ëŠ” ì²œì—°ë‘ ê°ì—¼ í™•ë¥ ê³¼ ì ‘ì¢…ì˜ ìœ„í—˜ì„±ì„ ë¹„êµí•˜ì—¬, ì ‘ì¢…ì´ ìƒëª…ì„ êµ¬í•œë‹¤ëŠ” ê²ƒì„ ìˆ˜í•™ì ìœ¼ë¡œ ì¦ëª…í–ˆë‹¤.</p>
<p>20ì„¸ê¸° ì´ˆì—ëŠ” ë¡œë„ë“œ ë¡œìŠ¤ (Ronald Ross) ê°€ ë§ë¼ë¦¬ì•„ ëª¨ë¸ì„ ê°œë°œí–ˆê³  <span class="citation" data-cites="ross1911">(Ross, 1911)</span>, ê·¸ í›„ ì»¤ë§¥ (Kermack)ê³¼ ë§¥ì¼„ë“œë¦­ (McKendrick)ì´ ì§€ê¸ˆë„ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” SIR (Susceptible-Infected-Recovered) ëª¨ë¸ì„ ì œì•ˆí–ˆë‹¤ <span class="citation" data-cites="kermack1927">(Kermack &amp; McKendrick, 1927)</span>. ì´ ëª¨ë¸ì€ ì¸êµ¬ë¥¼ ê°ì—¼ë  ìˆ˜ ìžˆëŠ” ì‚¬ëžŒ(S), ì´ë¯¸ ê°ì—¼ëœ ì‚¬ëžŒ(I), íšŒë³µëœ ì‚¬ëžŒ(R)ìœ¼ë¡œ ë‚˜ëˆ„ì–´ ì§ˆë³‘ì˜ ì „íŒŒë¥¼ ì„¤ëª…í•œë‹¤.</p>
<p>ì´ëŸ¬í•œ ëª¨ë¸ë“¤ì€ ë‹¨ìˆœí•˜ì§€ë§Œ ê°•ë ¥í•˜ë‹¤. ê°ì—¼ë³‘ì˜ ê¸°ë³¸ì ì¸ íŠ¹ì„±ì„ íŒŒì•…í•˜ê³ , ì´ë¥¼ í†µí•´ ë¯¸ëž˜ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ìžˆê²Œ í•´ì¤€ë‹¤.</p>
</section>
<section id="ëª¨ë¸ì˜-íž˜-ëˆˆì—-ë³´ì´ì§€-ì•ŠëŠ”-ê²ƒì„-ë³´ëŠ”-ë°©ë²•" class="level2">
<h2 class="anchored" data-anchor-id="ëª¨ë¸ì˜-íž˜-ëˆˆì—-ë³´ì´ì§€-ì•ŠëŠ”-ê²ƒì„-ë³´ëŠ”-ë°©ë²•">ëª¨ë¸ì˜ íž˜: ëˆˆì— ë³´ì´ì§€ ì•ŠëŠ” ê²ƒì„ ë³´ëŠ” ë°©ë²•</h2>
<p>ê°ì—¼ë³‘ì€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. ê°ì—¼ë³‘ì˜ ì›ì¸ì´ ë˜ëŠ” ë°”ì´ëŸ¬ìŠ¤ê°€ ì„¸ê· ì€ ë„ˆë¬´ ìž‘ì•„ì„œ ë§¨ëˆˆìœ¼ë¡œ ë³¼ ìˆ˜ ì—†ë‹¤. ê·¸ëŸ¬ë‚˜ ê·¸ ì˜í–¥ì€ í¬ê³  ëª…í™•í•˜ë‹¤.</p>
<p>ìˆ˜ë¦¬ ëª¨í˜•ì€ ë³´ì´ì§€ ì•ŠëŠ” ê²ƒì„ â€˜ë³´ëŠ”â€™ ë°©ë²•ì´ë‹¤. ìš°ë¦¬ëŠ” ê´€ì°°ëœ ë°ì´í„°(í™•ì§„ìž ìˆ˜, ì‚¬ë§ìž ìˆ˜)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°ì—¼ì˜ íŒ¨í„´ì„ íŒŒì•…í•œë‹¤. ê·¸ë¦¬ê³  ê·¸ íŒ¨í„´ì—ì„œ ê·œì¹™ì„ ì°¾ì•„ ë¯¸ëž˜ë¥¼ ì˜ˆì¸¡í•œë‹¤.</p>
<p>ì˜ˆë¥¼ ë“¤ì–´, 2014ë…„ ì„œì•„í”„ë¦¬ì¹´ ì—ë³¼ë¼ ìœ í–‰ ë‹¹ì‹œ, ì—°êµ¬ìžë“¤ì€ ì´ˆê¸° í™•ì§„ìž ë°ì´í„°ë§Œìœ¼ë¡œ ì—ë³¼ë¼ì˜ ê¸°ë³¸ìž¬ìƒì‚°ìˆ˜(<img src="https://latex.codecogs.com/png.latex?R_0">)ë¥¼ ì¶”ì •í–ˆë‹¤ <span class="citation" data-cites="nishiura2014">(Nishiura, 2014)</span>. ì´ <img src="https://latex.codecogs.com/png.latex?R_0">ê°’ (ì•½ 1.5-2.0)ì„ í†µí•´ ì ì ˆí•œ ì¡°ì¹˜ ì—†ì´ëŠ” ìœ í–‰ì´ í™•ì‚°ë  ê²ƒì´ë¼ê³  ì˜ˆì¸¡í–ˆê³ , ì‹¤ì œë¡œ ê·¸ë ‡ê²Œ ë˜ì—ˆë‹¤.</p>
<p>ìˆ˜ë¦¬ ëª¨í˜•ì€ ë‹¨ìˆœí•œ ì˜ˆì¸¡ì„ ë„˜ì–´, ë‹¤ì–‘í•œ ì§ˆë¬¸ì— ë‹µí•  ìˆ˜ ìžˆë‹¤:</p>
<ul>
<li>ì´ ê°ì—¼ë³‘ì€ ì–¼ë§ˆë‚˜ ë¹ ë¥´ê²Œ í¼ì§ˆê¹Œ?</li>
<li>ì–¸ì œ ì •ì ì— ë„ë‹¬í• ê¹Œ?</li>
<li>ì–´ë–¤ í†µì œ ì „ëžµì´ ê°€ìž¥ íš¨ê³¼ì ì¼ê¹Œ?</li>
<li>ë°±ì‹ ì„ ì–´ë–»ê²Œ ë°°ë¶„í•´ì•¼ ê°€ìž¥ ë§Žì€ ìƒëª…ì„ êµ¬í•  ìˆ˜ ìžˆì„ê¹Œ?</li>
</ul>
<p>ì´ëŸ¬í•œ ì§ˆë¬¸ë“¤ì€ ë‹¨ìˆœí•œ ì§ê´€ì´ë‚˜ ê´€ì°°ë§Œìœ¼ë¡œëŠ” ë‹µí•˜ê¸° ì–´ë µë‹¤. ìˆ˜í•™ì  ëª¨ë¸ë§ì€ ë³µìž¡í•œ ì‹œìŠ¤í…œì„ ì´í•´í•˜ê³  ë¶„ì„í•˜ëŠ” ê°•ë ¥í•œ ë„êµ¬ê°€ ëœë‹¤.</p>
</section>
<section id="ì½”ë¡œë‚˜19-ëª¨ë¸ë§ì˜-ì‹œëŒ€" class="level2">
<h2 class="anchored" data-anchor-id="ì½”ë¡œë‚˜19-ëª¨ë¸ë§ì˜-ì‹œëŒ€">ì½”ë¡œë‚˜19: ëª¨ë¸ë§ì˜ ì‹œëŒ€</h2>
<p>2020ë…„ ì½”ë¡œë‚˜19 íŒ¬ë°ë¯¹ì€ ìˆ˜ë¦¬ ëª¨í˜•ì˜ ì¤‘ìš”ì„±ì„ ì „ ì„¸ê³„ì— ê°ì¸ì‹œì¼°ë‹¤. ì „ë¡€ ì—†ëŠ” ê·œëª¨ì˜ ê°ì—¼ë³‘ ìœ„ê¸° ì†ì—ì„œ, ê³¼í•™ìžë“¤ì€ ìˆ˜ë¦¬ ëª¨í˜•ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ì–‘í•œ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶„ì„í–ˆë‹¤.</p>
<p>ì˜êµ­ ìž„íŽ˜ë¦¬ì–¼ ì¹¼ë¦¬ì§€ì˜ (Imperial College) ì—°êµ¬ì§„ì€ ì¡°ê¸°ì— ì—¬ëŸ¬ í†µì œ ì „ëžµì˜ íš¨ê³¼ë¥¼ ëª¨ë¸ë§í–ˆë‹¤ <span class="citation" data-cites="ferguson2020">(Ferguson et al., 2020)</span>. ê·¸ë“¤ì˜ ì˜ˆì¸¡ì€ ì¶©ê²©ì ì´ì—ˆë‹¤: ì•„ë¬´ ì¡°ì¹˜ë¥¼ ì·¨í•˜ì§€ ì•Šìœ¼ë©´ ë¯¸êµ­ì—ì„œë§Œ 220ë§Œ ëª…ì´ ì‚¬ë§í•  ìˆ˜ ìžˆë‹¤ëŠ” ê²ƒì´ì—ˆë‹¤. ì´ ì—°êµ¬ëŠ” ì—¬ëŸ¬ êµ­ê°€ì˜ ë´‰ì‡„ ì •ì±… ê²°ì •ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ë¯¸ì³¤ë‹¤.</p>
<p>í•œêµ­ì—ì„œë„ ìˆ˜ë¦¬ ëª¨ë¸ë§ì€ ì¤‘ìš”í•œ ì—­í• ì„ í–ˆë‹¤. ì—°êµ¬ìžë“¤ì€ ì´ˆê¸° ëŒ€êµ¬ ìœ í–‰ì˜ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ì ‘ì´‰ìž ì¶”ì ê³¼ ì‚¬íšŒì  ê±°ë¦¬ë‘ê¸°ì˜ íš¨ê³¼ë¥¼ í‰ê°€í–ˆë‹¤ <span class="citation" data-cites="choi2020">(Choi &amp; Ki, 2020)</span>. ì´ëŸ¬í•œ ë¶„ì„ì€ ì •ë¶€ì˜ ë‹¨ê³„ì  ê±°ë¦¬ë‘ê¸° ì •ì±… ìˆ˜ë¦½ì— ê¸°ì—¬í–ˆë‹¤.</p>
<p>ìˆ˜ë¦¬ ëª¨í˜•ì€ ì™„ë²½í•˜ì§€ ì•Šë‹¤. ì´ˆê¸° ë°ì´í„°ì˜ ë¶€ì¡±, ë°”ì´ëŸ¬ìŠ¤ì˜ íŠ¹ì„±ì— ëŒ€í•œ ë¶ˆí™•ì‹¤ì„±, ì¸ê°„ í–‰ë™ì˜ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥ì„± ë“± ë§Žì€ ë³€ìˆ˜ê°€ ìžˆë‹¤. ê·¸ëŸ¬ë‚˜ ë¶ˆì™„ì „í•¨ì—ë„ ë¶ˆêµ¬í•˜ê³ , ëª¨í˜•ì€ ê²°ì •ì ì¸ ìˆœê°„ì— ë°©í–¥ì„ ì œì‹œí–ˆë‹¤.</p>
</section>
<section id="ëª¨ë¸ì˜-ì–¸ì–´ë¥¼-ë°°ìš°ëŠ”-ì´ìœ " class="level2">
<h2 class="anchored" data-anchor-id="ëª¨ë¸ì˜-ì–¸ì–´ë¥¼-ë°°ìš°ëŠ”-ì´ìœ ">ëª¨ë¸ì˜ ì–¸ì–´ë¥¼ ë°°ìš°ëŠ” ì´ìœ </h2>
<p>â€œëª¨ë“  ëª¨ë¸ì€ í‹€ë ¸ì§€ë§Œ, ì¼ë¶€ëŠ” ìœ ìš©í•˜ë‹¤â€ (All models are wrong, but some are useful) ë¼ëŠ” í†µê³„í•™ìž ì¡°ì§€ ë°•ìŠ¤ (George Box)ì˜ ë§ì€ ìœ ëª…í•˜ë‹¤ <span class="citation" data-cites="box1976">(Box, 1976)</span>. ìˆ˜ë¦¬ ëª¨í˜•ì€ í˜„ì‹¤ì˜ ë‹¨ìˆœí™”ëœ í‘œí˜„ì´ê¸° ë•Œë¬¸ì— ì™„ë²½í•  ìˆ˜ ì—†ë‹¤. í•˜ì§€ë§Œ ìœ ìš©í•œ ëª¨ë¸ì€ í˜„ì‹¤ì— ëŒ€í•œ í†µì°°ë ¥ì„ ì œê³µí•œë‹¤.</p>
<p>ê°ì—¼ë³‘ ìˆ˜ë¦¬ ëª¨í˜•ì„ ì´í•´í•˜ëŠ” ê²ƒì€ ë‹¨ìˆœížˆ ìˆ˜í•™ì  í˜¸ê¸°ì‹¬ì„ ì¶©ì¡±ì‹œí‚¤ëŠ” ê²ƒì´ ì•„ë‹ˆë‹¤. ì´ëŠ” ê³µì¤‘ë³´ê±´ ì •ì±…ì„ ì´í•´í•˜ê³ , ë‰´ìŠ¤ì—ì„œ ì ‘í•˜ëŠ” ìˆ˜ì¹˜ë¥¼ ë¹„íŒì ìœ¼ë¡œ í‰ê°€í•˜ë©°, ë¯¸ëž˜ì˜ ê±´ê°• ìœ„ê¸°ì— ë” ìž˜ ëŒ€ì‘í•˜ê¸° ìœ„í•œ ì†Œì–‘ì´ë‹¤.</p>
<p>ë˜í•œ, ëª¨ë¸ë§ì˜ ì–¸ì–´ë¥¼ ë°°ìš°ëŠ” ê²ƒì€ ë¶ˆí™•ì‹¤ì„± ì†ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ì‚¬ê³ í•˜ëŠ” ë°©ë²•ì„ ë°°ìš°ëŠ” ê²ƒì´ë‹¤. ìš°ë¦¬ëŠ” ëª¨ë“  ê²ƒì„ ì•Œ ìˆ˜ ì—†ë‹¤. í•˜ì§€ë§Œ ë¶ˆì™„ì „í•œ ì •ë³´ ì†ì—ì„œë„ ìµœì„ ì˜ íŒë‹¨ì„ ë‚´ë ¤ì•¼ í•œë‹¤. ìˆ˜ë¦¬ ëª¨í˜•ì€ ê·¸ëŸ° íŒë‹¨ì„ ë„ì™€ì£¼ëŠ” ë„êµ¬ë‹¤.</p>
</section>
<section id="ì´-ì±…ì˜-ì—¬ì •" class="level2">
<h2 class="anchored" data-anchor-id="ì´-ì±…ì˜-ì—¬ì •">ì´ ì±…ì˜ ì—¬ì •</h2>
<p>ì´ ìž¥ì—ì„œëŠ” ë¨¼ì €, ìš°ë¦¬ê°€ ì™œ ìˆ˜í•™ìœ¼ë¡œ ê°ì—¼ë³‘ì„ ì´ì•¼ê¸°í•˜ê²Œ ë˜ì—ˆëŠ”ì§€, ê·¸ í•„ìš”ì„±ê³¼ ë°°ê²½ì„ ì§šì–´ë³´ì•˜ë‹¤. ì½”ë¡œë‚˜19ëŠ” ë¬¼ë¡ ì´ê³ , ê·¸ ì´ì „ê³¼ ì´í›„ì˜ ì‚¬ë¡€ê¹Œì§€.</p>
<p>ì•žìœ¼ë¡œì˜ ìž¥ì—ì„œëŠ” ê°ì—¼ë³‘ ìˆ˜ë¦¬ ëª¨í˜•ì˜ ê¸°ë³¸ ê°œë…ë¶€í„° ì‹œìž‘í•˜ì—¬, ë³µìž¡í•œ ìˆ˜ë¦¬ ëª¨í˜•ê³¼ ì‹¤ì œ ì ìš© ì‚¬ë¡€ê¹Œì§€ ì‚´íŽ´ë³¼ ê²ƒì´ë‹¤. ìˆ˜í•™ì  ë°°ê²½ì§€ì‹ì´ ë¶€ì¡±í•˜ë”ë¼ë„ ê±±ì •í•˜ì§€ ë§ìž. ì´ ì±…ì€ ìˆ˜í•™ìžê°€ ì•„ë‹Œ ì¼ë°˜ ë…ìžë¥¼ ìœ„í•œ ì•ˆë‚´ì„œë‹¤. ì €ìž ë˜í•œ ìˆ˜í•™ìžê°€ ì•„ë‹ˆë‹¤.</p>
<p>ë…ìžëŠ” ëŠë‚„ ê²ƒì´ë‹¤. ì´ê±´ ë‹¨ìˆœí•œ ìˆ«ìž ë†€ìŒì´ ì•„ë‹ˆë¼, ì‚¬ëžŒê³¼ ì‚¬íšŒ, ë¯¸ëž˜ë¥¼ ë‹¤ë£¨ëŠ” ë„êµ¬ë¼ëŠ” ê±¸. ë°”ì´ëŸ¬ìŠ¤ëŠ” ìˆ«ìžë¥¼ ëª¨ë¥¼ì§€ ëª¨ë¥´ì§€ë§Œ, ìˆ«ìžë¥¼ ì•„ëŠ” ìš°ë¦¬ëŠ” ë°”ì´ëŸ¬ìŠ¤ë¥¼ ë” ìž˜ ì´í•´í•˜ê³  ëŒ€ì‘í•  ìˆ˜ ìžˆë‹¤.</p>
</section>
<section id="ì°¸ê³ ë¬¸í—Œ" class="level2">




</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">ì°¸ê³ ë¬¸í—Œ</h2><div id="refs" class="references csl-bib-body hanging-indent" data-line-spacing="2">
<div id="ref-bernoulli1760" class="csl-entry">
Bernoulli, D. (1760). Essai dâ€™une nouvelle analyse de la mortalit<span>Ã©</span> caus<span>Ã©</span>e par la petite v<span>Ã©</span>role et des avantages de lâ€™inoculation pour la pr<span>Ã©</span>venir. <em>M<span>Ã©</span>moires de Math<span>Ã©</span>matiques Et de Physique, Acad<span>Ã©</span>mie Royale Des Sciences</em>, 1â€“45.
</div>
<div id="ref-box1976" class="csl-entry">
Box, G. E. (1976). Science and statistics. <em>Journal of the American Statistical Association</em>, <em>71</em>(356), 791â€“799.
</div>
<div id="ref-choi2020" class="csl-entry">
Choi, S., &amp; Ki, M. (2020). Estimating the reproductive number and the outbreak size of COVID-19 in korea. <em>Epidemiology and Health</em>, <em>42</em>, e2020011.
</div>
<div id="ref-ferguson2020" class="csl-entry">
Ferguson, N. M., Laydon, D., Nedjati-Gilani, G., Imai, N., Ainslie, K., Baguelin, M., Bhatia, S., Boonyasiri, A., CucunubÃ¡, Z., Cuomo-Dannenburg, G., et al. (2020). Impact of non-pharmaceutical interventions (NPIs) to reduce COVID-19 mortality and healthcare demand. <em>Imperial College London</em>, <em>9</em>(2020.03.16).
</div>
<div id="ref-flaxman2020" class="csl-entry">
Flaxman, S., Mishra, S., Gandy, A., Unwin, H. J. T., Mellan, T. A., Coupland, H., Whittaker, C., Zhu, H., Berah, T., Eaton, J. W., et al. (2020). Estimating the effects of non-pharmaceutical interventions on COVID-19 in europe. <em>Nature</em>, <em>584</em>(7820), 257â€“261.
</div>
<div id="ref-kermack1927" class="csl-entry">
Kermack, W. O., &amp; McKendrick, A. G. (1927). A contribution to the mathematical theory of epidemics. <em>Proceedings of the Royal Society of London. Series A</em>, <em>115</em>(772), 700â€“721.
</div>
<div id="ref-kimminsoo2021" class="csl-entry">
Kim, M. S., Seong, M.-W., Kim, H. J., Cho, S. I., Kim, J., Chung, Y.-S., Lee, J.-A., Kim, N., Park, S. H., Jang, S. Y., et al. (2021). COVID-19 national emergency response center, epidemiology and case management team, korea disease control and prevention agency. Contact transmission of COVID-19 in south korea: Novel investigation techniques for tracing contacts. <em>Osong Public Health and Research Perspectives</em>, <em>12</em>(1), 60â€“63.
</div>
<div id="ref-nishiura2014" class="csl-entry">
Nishiura, H. (2014). Early epidemiological assessment of the virulence of emerging infectious diseases: A case study of an influenza pandemic. <em>PLoS One</em>, <em>9</em>(8), e105132.
</div>
<div id="ref-ross1911" class="csl-entry">
Ross, R. (1911). The prevention of malaria. <em>London: John Murray</em>.
</div>
</div></section></div> ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/book_math_model_why_kor/index.html</guid>
  <pubDate>Thu, 17 Apr 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>The Ross-Macdonald Framework: Foundational Mathematical Models in Vector-Borne Disease Epidemiology</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/Ross-Macdonald/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>The mathematical modeling of infectious diseases has become an indispensable tool in modern epidemiology, guiding intervention strategies and policy decisions. While contemporary models exhibit increasing complexity, many fundamental principles trace back to the pioneering work of Sir Ronald Ross, who established the theoretical foundation for understanding vector-borne disease transmission dynamics at the turn of the 20th century.</p>
<p>This article examines Rossâ€™s seminal contributions to mathematical epidemiology, the subsequent refinements by George Macdonald, and how these models continue to influence contemporary approaches to vector-borne disease control. We will focus on the mathematical formulations that undergird the Ross-Macdonald framework and their implications for disease control thresholds.</p>
</section>
<section id="rosss-initial-mathematical-framework" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="rosss-initial-mathematical-framework"><span class="header-section-number">2</span> Rossâ€™s Initial Mathematical Framework</h2>
<p>After establishing the mosquito-malaria parasite life cycle, for which he received the Nobel Prize in Medicine in 1902, Ronald Ross turned his attention to developing mathematical models to guide control strategies. His first models, published in 1908 in â€œReport on the Prevention of Malaria in Mauritiusâ€ <span class="citation" data-cites="ross1908report">(Ross 1908)</span> and expanded in his 1911 book â€œThe Prevention of Malariaâ€ <span class="citation" data-cites="ross1911prevention">(Ross 1911)</span>, represented a paradigm shift in epidemiological thinking.</p>
<p>Ross later formalized these mathematical principles in his landmark papers â€œSome a priori pathometric equationsâ€ <span class="citation" data-cites="ross1915some">(Ross 1915)</span> and â€œAn application of the theory of probabilities to the study of a priori pathometryâ€ <span class="citation" data-cites="ross1916application">(Ross 1916)</span>, which laid the groundwork for the entire field of mathematical epidemiology.</p>
<p>Rossâ€™s initial model was remarkably straightforward yet profound. If we denote the proportion of infected humans as <img src="https://latex.codecogs.com/png.latex?p"> and the proportion of infected mosquitoes as <img src="https://latex.codecogs.com/png.latex?P">, his first model can be expressed as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bdp%7D%7Bdt%7D%20=%20abmP(1-p)%20-%20rp"> <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BdP%7D%7Bdt%7D%20=%20acp(1-P)%20-%20%5Cmu%20P"></p>
<p>Where: - <img src="https://latex.codecogs.com/png.latex?a"> represents the mosquito biting rate - <img src="https://latex.codecogs.com/png.latex?b"> is the probability of parasite transmission from mosquito to human per bite - <img src="https://latex.codecogs.com/png.latex?c"> is the probability of parasite transmission from human to mosquito per bite - <img src="https://latex.codecogs.com/png.latex?m"> is the mosquito density per human - <img src="https://latex.codecogs.com/png.latex?r"> is the human recovery rate - <img src="https://latex.codecogs.com/png.latex?%5Cmu"> is the mosquito mortality rate</p>
</section>
<section id="the-basic-reproduction-number" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="the-basic-reproduction-number"><span class="header-section-number">3</span> The Basic Reproduction Number</h2>
<p>Rossâ€™s most significant contribution was demonstrating that malaria transmission could be interrupted without eliminating the entire vector population <span class="citation" data-cites="smith2007revisiting">(Smith et al. 2007)</span>. This led to the concept of a critical threshold, later formalized as the basic reproduction number <img src="https://latex.codecogs.com/png.latex?R_0">.</p>
<p>For Rossâ€™s model, <img src="https://latex.codecogs.com/png.latex?R_0"> can be derived as:</p>
<p><img src="https://latex.codecogs.com/png.latex?R_0%20=%20%5Cfrac%7Ba%5E2bcm%7D%7B%5Cmu%20r%7D"></p>
<p>This quantity represents the expected number of secondary infections arising from a single infected individual in a completely susceptible population. When <img src="https://latex.codecogs.com/png.latex?R_0%20%3C%201">, the disease will eventually die out; when <img src="https://latex.codecogs.com/png.latex?R_0%20%3E%201">, the disease can persist in the population <span class="citation" data-cites="smith2012ross">(Smith et al. 2012)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to calculate R0 from model parameters</span></span>
<span id="cb1-2">calculate_R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(a, b, c, m, mu, r) {</span>
<span id="cb1-3">  R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r)</span>
<span id="cb1-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(R0)</span>
<span id="cb1-5">}</span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example parameter values</span></span>
<span id="cb1-8">a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Biting rate (bites per day)</span></span>
<span id="cb1-9">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: mosquito to human</span></span>
<span id="cb1-10">c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: human to mosquito</span></span>
<span id="cb1-11">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosquito density per human</span></span>
<span id="cb1-12">mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosquito mortality rate</span></span>
<span id="cb1-13">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Human recovery rate</span></span>
<span id="cb1-14"></span>
<span id="cb1-15">R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_R0</span>(a, b, c, m, mu, r)</span>
<span id="cb1-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"With these parameters, R0 ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(R0, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>With these parameters, R0 = 225</code></pre>
</div>
</div>
</section>
<section id="the-macdonald-refinements" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="the-macdonald-refinements"><span class="header-section-number">4</span> The Macdonald Refinements</h2>
<p>George Macdonald expanded Rossâ€™s work in the 1950s, incorporating additional biological complexity <span class="citation" data-cites="macdonald1952analysis">(Macdonald 1952)</span>. His key modifications included:</p>
<ol type="1">
<li>Accounting for the latent period in the mosquito (<img src="https://latex.codecogs.com/png.latex?n"> days), during which the parasite develops</li>
<li>Recognition of mosquito survival as exponential, with daily survival probability <img src="https://latex.codecogs.com/png.latex?p"></li>
</ol>
<p>Macdonaldâ€™s version of the reproduction number became:</p>
<p><img src="https://latex.codecogs.com/png.latex?R_0%20=%20%5Cfrac%7Bma%5E2bcp%5En%7D%7B-r%5Cln(p)%7D"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?-%5Cln(p)"> replaces <img src="https://latex.codecogs.com/png.latex?%5Cmu"> as the mosquito mortality rate.</p>
<p>A crucial insight from Macdonald was that malaria transmission is particularly sensitive to adult mosquito longevity, as expressed by the exponent <img src="https://latex.codecogs.com/png.latex?n"> in the equation. This led to the strategic emphasis on adult mosquito control using residual insecticides <span class="citation" data-cites="garrett1964malaria">(Garrett-Jones 1964)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Macdonald's R0 calculation</span></span>
<span id="cb3-2">calculate_macdonald_R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(m, a, b, c, p, n, r) {</span>
<span id="cb3-3">  R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>n) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(p))</span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(R0)</span>
<span id="cb3-5">}</span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example parameter values</span></span>
<span id="cb3-8">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosquito density per human</span></span>
<span id="cb3-9">a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Biting rate (bites per day)</span></span>
<span id="cb3-10">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: mosquito to human</span></span>
<span id="cb3-11">c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: human to mosquito</span></span>
<span id="cb3-12">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Daily mosquito survival probability</span></span>
<span id="cb3-13">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extrinsic incubation period (days)</span></span>
<span id="cb3-14">r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Human recovery rate</span></span>
<span id="cb3-15"></span>
<span id="cb3-16">macdonald_R0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_macdonald_R0</span>(m, a, b, c, p, n, r)</span>
<span id="cb3-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"With Macdonald's formulation, R0 ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(macdonald_R0, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>With Macdonald's formulation, R0 = 74.46</code></pre>
</div>
</div>
</section>
<section id="equilibrium-analysis-and-threshold-conditions" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="equilibrium-analysis-and-threshold-conditions"><span class="header-section-number">5</span> Equilibrium Analysis and Threshold Conditions</h2>
<p>Rossâ€™s mathematical analysis demonstrated that the system has two equilibrium points <span class="citation" data-cites="bailey1982biomathematics">(Bailey 1982)</span>:</p>
<ol type="1">
<li>Disease-free equilibrium: <img src="https://latex.codecogs.com/png.latex?(p,%20P)%20=%20(0,%200)"></li>
<li>Endemic equilibrium: <img src="https://latex.codecogs.com/png.latex?(p,%20P)%20=%20(p%5E*,%20P%5E*)"> where:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?p%5E*%20=%20%5Cfrac%7BabmP%5E*%20-%20rp%5E*%7D%7BabmP%5E*%7D"> <img src="https://latex.codecogs.com/png.latex?P%5E*%20=%20%5Cfrac%7Bacp%5E*%20-%20%5Cmu%20P%5E*%7D%7Bacp%5E*%7D"></p>
<p>The stability of these equilibria depends on the value of <img src="https://latex.codecogs.com/png.latex?R_0">. When <img src="https://latex.codecogs.com/png.latex?R_0%20%3C%201">, the disease-free equilibrium is stable and the endemic equilibrium doesnâ€™t exist. When <img src="https://latex.codecogs.com/png.latex?R_0%20%3E%201">, the disease-free equilibrium is unstable and the endemic equilibrium is stable <span class="citation" data-cites="dietz1993malaria">(Dietz, Molineaux, and Thomas 1974)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simple SIS model with vector-host interaction</span></span>
<span id="cb5-2">ross_model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(time, state, parameters) {</span>
<span id="cb5-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(state, parameters)), {</span>
<span id="cb5-4">    dp_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> P <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> r <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p</span>
<span id="cb5-5">    dP_dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> a <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> P) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> P</span>
<span id="cb5-6">    </span>
<span id="cb5-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(dp_dt, dP_dt)))</span>
<span id="cb5-8">  })</span>
<span id="cb5-9">}</span>
<span id="cb5-10"></span>
<span id="cb5-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameter values</span></span>
<span id="cb5-12">params <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb5-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Biting rate</span></span>
<span id="cb5-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: mosquito to human</span></span>
<span id="cb5-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">c =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transmission probability: human to mosquito</span></span>
<span id="cb5-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">m =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosquito density per human</span></span>
<span id="cb5-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">r =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>,   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Human recovery rate</span></span>
<span id="cb5-18">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mosquito mortality rate</span></span>
<span id="cb5-19">)</span>
<span id="cb5-20"></span>
<span id="cb5-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial conditions</span></span>
<span id="cb5-22">init_state <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">p =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">P =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.005</span>)</span>
<span id="cb5-23"></span>
<span id="cb5-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time points</span></span>
<span id="cb5-25">times <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">365</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-26"></span>
<span id="cb5-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve the model</span></span>
<span id="cb5-28">solution <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ode</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> init_state, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> times, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">func =</span> ross_model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">parms =</span> params)</span>
<span id="cb5-29"></span>
<span id="cb5-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to data frame</span></span>
<span id="cb5-31">results <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(solution)</span>
<span id="cb5-32">results_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(results, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(p, P), </span>
<span id="cb5-33">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Compartment"</span>, </span>
<span id="cb5-34">                           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion"</span>)</span>
<span id="cb5-35"></span>
<span id="cb5-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot</span></span>
<span id="cb5-37"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(results_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> time, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> Proportion, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> Compartment)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-38">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-39">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkred"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkblue"</span>),</span>
<span id="cb5-40">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">labels =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"p"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Infected Humans"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"P"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Infected Mosquitoes"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-41">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ross Model Dynamics"</span>,</span>
<span id="cb5-42">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time (days)"</span>,</span>
<span id="cb5-43">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Proportion Infected"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-44">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>()</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Ross-Macdonald/index_files/figure-html/ross-model-simulation-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="vector-control-implications" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="vector-control-implications"><span class="header-section-number">6</span> Vector Control Implications</h2>
<p>The Ross-Macdonald framework provides clear guidance on vector control strategies. From the expression for <img src="https://latex.codecogs.com/png.latex?R_0">, we can derive critical thresholds for various control parameters <span class="citation" data-cites="smith2014recasting">(Smith et al. 2014)</span>. For example, the critical mosquito density <img src="https://latex.codecogs.com/png.latex?m_c"> below which transmission cannot be sustained is:</p>
<p><img src="https://latex.codecogs.com/png.latex?m_c%20=%20%5Cfrac%7B%5Cmu%20r%7D%7Ba%5E2bc%7D"></p>
<p>Similarly, the required efficacy of insecticides to achieve control can be calculated. If we denote the proportional reduction in mosquito density as <img src="https://latex.codecogs.com/png.latex?%5CDelta%20m">, then for disease elimination:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5CDelta%20m%20%3E%201%20-%20%5Cfrac%7B1%7D%7BR_0%7D"></p>
<p>This concept is directly related to the herd immunity threshold in direct transmission diseases <span class="citation" data-cites="fine1981herd">(Fine 1993)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate critical mosquito density</span></span>
<span id="cb6-2">calculate_critical_m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(a, b, c, mu, r) {</span>
<span id="cb6-3">  m_c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (mu <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> c)</span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(m_c)</span>
<span id="cb6-5">}</span>
<span id="cb6-6"></span>
<span id="cb6-7">m_c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_critical_m</span>(a, b, c, mu, r)</span>
<span id="cb6-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Critical mosquito density (m_c) ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(m_c, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"mosquitoes per human</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Critical mosquito density (m_c) = 0.04 mosquitoes per human</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate required control effectiveness</span></span>
<span id="cb8-2">required_control <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>R0)</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Required proportional reduction in mosquito density ="</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(required_control, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"%"</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Required proportional reduction in mosquito density = 99.56 %</code></pre>
</div>
</div>
</section>
<section id="sensitivity-analysis" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="sensitivity-analysis"><span class="header-section-number">7</span> Sensitivity Analysis</h2>
<p>A key insight from the Ross-Macdonald framework is the differential sensitivity of <img src="https://latex.codecogs.com/png.latex?R_0"> to various parameters. This can be formally analyzed through partial derivatives or elasticity analysis <span class="citation" data-cites="brady2016vectorial">(Brady et al. 2016)</span>.</p>
<p>For example, the elasticity of <img src="https://latex.codecogs.com/png.latex?R_0"> with respect to parameter <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is:</p>
<p><img src="https://latex.codecogs.com/png.latex?E_%7B%5Ctheta%7D%20=%20%5Cfrac%7B%5Ctheta%7D%7BR_0%7D%20%5Cfrac%7B%5Cpartial%20R_0%7D%7B%5Cpartial%20%5Ctheta%7D"></p>
<p>For the mosquito mortality rate <img src="https://latex.codecogs.com/png.latex?%5Cmu">, this becomes:</p>
<p><img src="https://latex.codecogs.com/png.latex?E_%7B%5Cmu%7D%20=%20-1"></p>
<p>This indicates that a 1% increase in mosquito mortality leads to approximately a 1% decrease in <img src="https://latex.codecogs.com/png.latex?R_0">.</p>
<p>For the parameter <img src="https://latex.codecogs.com/png.latex?a"> (biting rate), the elasticity is:</p>
<p><img src="https://latex.codecogs.com/png.latex?E_a%20=%202"></p>
<p>This reflects Macdonaldâ€™s important observation that interventions targeting mosquito biting behavior have a squared effect on transmission, since <img src="https://latex.codecogs.com/png.latex?a"> appears as <img src="https://latex.codecogs.com/png.latex?a%5E2"> in the <img src="https://latex.codecogs.com/png.latex?R_0"> expression <span class="citation" data-cites="smith2012ross">(Smith et al. 2012)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to calculate elasticity for different parameters</span></span>
<span id="cb10-2">calculate_elasticities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(a, b, c, m, mu, r) {</span>
<span id="cb10-3">  E_a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for biting rate</span></span>
<span id="cb10-4">  E_b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for transmission probability (mosquito to human)</span></span>
<span id="cb10-5">  E_c <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for transmission probability (human to mosquito)</span></span>
<span id="cb10-6">  E_m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>                <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for mosquito density</span></span>
<span id="cb10-7">  E_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>              <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for mosquito mortality rate</span></span>
<span id="cb10-8">  E_r <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>               <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Elasticity for human recovery rate</span></span>
<span id="cb10-9">  </span>
<span id="cb10-10">  elasticities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb10-11">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Parameter =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Biting rate (a)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transmission: mosquitoâ†’human (b)"</span>, </span>
<span id="cb10-12">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Transmission: humanâ†’mosquito (c)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mosquito density (m)"</span>,</span>
<span id="cb10-13">                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mosquito mortality (Î¼)"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Human recovery rate (r)"</span>),</span>
<span id="cb10-14">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Elasticity =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(E_a, E_b, E_c, E_m, E_mu, E_r)</span>
<span id="cb10-15">  )</span>
<span id="cb10-16">  </span>
<span id="cb10-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(elasticities)</span>
<span id="cb10-18">}</span>
<span id="cb10-19"></span>
<span id="cb10-20">elasticities <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">calculate_elasticities</span>(a, b, c, m, mu, r)</span>
<span id="cb10-21">elasticities</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                         Parameter Elasticity
1                  Biting rate (a)          2
2 Transmission: mosquitoâ†’human (b)          1
3 Transmission: humanâ†’mosquito (c)          1
4             Mosquito density (m)          1
5           Mosquito mortality (Î¼)         -1
6          Human recovery rate (r)         -1</code></pre>
</div>
</div>
</section>
<section id="contemporary-extensions-and-applications" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="contemporary-extensions-and-applications"><span class="header-section-number">8</span> Contemporary Extensions and Applications</h2>
<p>While the Ross-Macdonald framework remains foundational, modern approaches have extended these models in several directions <span class="citation" data-cites="reiner2013systematic mandal2011mathematical">(Reiner et al. 2013; Mandal, Sarkar, and Sinha 2011)</span>:</p>
<ol type="1">
<li><strong>Spatial heterogeneity</strong>: Incorporating spatial structure and human mobility</li>
<li><strong>Stochasticity</strong>: Accounting for random events, particularly important near elimination</li>
<li><strong>Vector bionomics</strong>: More detailed entomological parameters</li>
<li><strong>Immunity dynamics</strong>: Accounting for acquired immunity in human populations</li>
<li><strong>Drug resistance</strong>: Modeling the spread of antimalarial resistance</li>
</ol>
<p>The mathematical expression for <img src="https://latex.codecogs.com/png.latex?R_0"> in these more complex models becomes correspondingly more intricate. For example, in a spatial metapopulation model with <img src="https://latex.codecogs.com/png.latex?n"> patches, <img src="https://latex.codecogs.com/png.latex?R_0"> can be expressed as the dominant eigenvalue of the next-generation matrix:</p>
<p><img src="https://latex.codecogs.com/png.latex?R_0%20=%20%5Crho(FV%5E%7B-1%7D)"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?F"> represents new infections and <img src="https://latex.codecogs.com/png.latex?V"> represents transitions between compartments.</p>
</section>
<section id="practical-applications-in-disease-control-programs" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="practical-applications-in-disease-control-programs"><span class="header-section-number">9</span> Practical Applications in Disease Control Programs</h2>
<p>The threshold concept derived from Rossâ€™s work remains central to modern malaria control programs <span class="citation" data-cites="smith2007revisiting">(Smith et al. 2007)</span>. The World Health Organizationâ€™s Global Technical Strategy for Malaria 2016-2030 implicitly relies on these mathematical principles when setting targets for vector control coverage and intervention effectiveness.</p>
<p>Key applications include:</p>
<ol type="1">
<li><strong>Indoor residual spraying (IRS)</strong>: Targeting the adult mosquito longevity parameter</li>
<li><strong>Insecticide-treated nets (ITNs)</strong>: Affecting both mosquito mortality and biting rate</li>
<li><strong>Larval source management</strong>: Reducing the mosquito density parameter <img src="https://latex.codecogs.com/png.latex?m"></li>
</ol>
<p>Mathematical models help quantify the coverage levels required for these interventions to bring <img src="https://latex.codecogs.com/png.latex?R_0"> below 1 <span class="citation" data-cites="brady2016vectorial">(Brady et al. 2016)</span>.</p>
</section>
<section id="discussion" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="discussion"><span class="header-section-number">10</span> Discussion</h2>
<p>Rossâ€™s mathematical insights have withstood the test of time remarkably well. The threshold concept, formalized as <img src="https://latex.codecogs.com/png.latex?R_0">, remains central to infectious disease epidemiology across all pathogens, not just vector-borne diseases.</p>
<p>Modern computational capabilities allow for increasingly complex simulations, but the core mathematical principles established by Ross <span class="citation" data-cites="ross1911prevention">(Ross 1911)</span> and refined by Macdonald <span class="citation" data-cites="macdonald1952analysis">(Macdonald 1952)</span> continue to guide our understanding of transmission dynamics. The elegance of these models lies in their ability to capture essential dynamics with relatively simple formulations.</p>
<p>As we face challenges like climate change, insecticide resistance, and drug resistance, these mathematical frameworks are being adapted to address increasingly complex scenarios <span class="citation" data-cites="smith2014recasting">(Smith et al. 2014)</span>. Yet the threshold principle - that disease transmission can be interrupted without eliminating every vector - remains a profound insight that continues to guide public health strategies worldwide.</p>
</section>
<section id="references" class="level2" data-number="11">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">11 References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bailey1982biomathematics" class="csl-entry">
Bailey, Norman TJ. 1982. <span>â€œThe Biomathematics of Malaria.â€</span> <em>Mathematics in Medicine and Biology</em> 2 (4).
</div>
<div id="ref-brady2016vectorial" class="csl-entry">
Brady, Oliver J, H Charles J Godfray, Andrew J Tatem, Peter W Gething, Justin M Cohen, F Ellis McKenzie, T Alex Perkins, et al. 2016. <span>â€œVectorial Capacity and Vector Control: Reconsidering Sensitivity to Parameters for Malaria Elimination.â€</span> <em>Transactions of the Royal Society of Tropical Medicine and Hygiene</em> 110 (2): 107â€“17. <a href="https://doi.org/10.1093/trstmh/trv113">https://doi.org/10.1093/trstmh/trv113</a>.
</div>
<div id="ref-dietz1993malaria" class="csl-entry">
Dietz, Klaus, Louis Molineaux, and Anthony Thomas. 1974. <span>â€œA Malaria Model Tested in the African Savannah.â€</span> <em>Bulletin of the World Health Organization</em> 50 (3-4): 347â€“57.
</div>
<div id="ref-fine1981herd" class="csl-entry">
Fine, Paul EM. 1993. <span>â€œHerd Immunity: History, Theory, Practice.â€</span> <em>Epidemiologic Reviews</em> 15 (2): 265â€“302.
</div>
<div id="ref-garrett1964malaria" class="csl-entry">
Garrett-Jones, C. 1964. <span>â€œMalaria Eradication and Control from a Global Standpoint.â€</span> <em>Journal of Medical Entomology</em> 1 (4): 353â€“65.
</div>
<div id="ref-macdonald1952analysis" class="csl-entry">
Macdonald, George. 1952. <span>â€œThe Analysis of Equilibrium in Malaria.â€</span> <em>Tropical Diseases Bulletin</em> 49 (9): 813â€“29.
</div>
<div id="ref-mandal2011mathematical" class="csl-entry">
Mandal, Sandip, Ram Rup Sarkar, and Somdatta Sinha. 2011. <span>â€œMathematical Models of Malaria-a Review.â€</span> <em>Malaria Journal</em> 10 (1): 1â€“19. <a href="https://doi.org/10.1186/1475-2875-10-202">https://doi.org/10.1186/1475-2875-10-202</a>.
</div>
<div id="ref-reiner2013systematic" class="csl-entry">
Reiner, Robert C, T Alex Perkins, Christopher M Barker, Tianchan Niu, Luis Fernando Chaves, Alicia M Ellis, Dylan B George, et al. 2013. <span>â€œA Systematic Review of Mathematical Models of Mosquito-Borne Pathogen Transmission: 1970â€“2010.â€</span> <em>Journal of the Royal Society Interface</em> 10 (81): 20120921. <a href="https://doi.org/10.1098/rsif.2012.0921">https://doi.org/10.1098/rsif.2012.0921</a>.
</div>
<div id="ref-ross1908report" class="csl-entry">
Ross, Ronald. 1908. <em>Report on the Prevention of Malaria in Mauritius</em>. London: Waterlow &amp; Sons Limited.
</div>
<div id="ref-ross1911prevention" class="csl-entry">
â€”â€”â€”. 1911. <em>The Prevention of Malaria</em>. London: John Murray.
</div>
<div id="ref-ross1915some" class="csl-entry">
â€”â€”â€”. 1915. <span>â€œSome a Priori Pathometric Equations.â€</span> <em>British Medical Journal</em> 1 (2830): 546â€“47.
</div>
<div id="ref-ross1916application" class="csl-entry">
â€”â€”â€”. 1916. <span>â€œAn Application of the Theory of Probabilities to the Study of a Priori Pathometry. Part i.â€</span> <em>Proceedings of the Royal Society of London. Series A</em> 92 (638): 204â€“30.
</div>
<div id="ref-smith2012ross" class="csl-entry">
Smith, David L, Katherine E Battle, Simon I Hay, Christopher M Barker, Thomas W Scott, and F Ellis McKenzie. 2012. <span>â€œRoss, Macdonald, and a Theory for the Dynamics and Control of Mosquito-Transmitted Pathogens.â€</span> <em>PLOS Pathogens</em> 8 (4): e1002588. <a href="https://doi.org/10.1371/journal.ppat.1002588">https://doi.org/10.1371/journal.ppat.1002588</a>.
</div>
<div id="ref-smith2007revisiting" class="csl-entry">
Smith, David L, F Ellis McKenzie, Robert W Snow, and Simon I Hay. 2007. <span>â€œRevisiting the Basic Reproductive Number for Malaria and Its Implications for Malaria Control.â€</span> <em>PLOS Biology</em> 5 (3): e42. <a href="https://doi.org/10.1371/journal.pbio.0050042">https://doi.org/10.1371/journal.pbio.0050042</a>.
</div>
<div id="ref-smith2014recasting" class="csl-entry">
Smith, David L, T Alex Perkins, Robert C Reiner, Christopher M Barker, Tianchan Niu, Luis Fernando Chaves, Alicia M Ellis, et al. 2014. <span>â€œRecasting the Theory of Mosquito-Borne Pathogen Transmission Dynamics and Control.â€</span> <em>Transactions of the Royal Society of Tropical Medicine and Hygiene</em> 108 (4): 185â€“97. <a href="https://doi.org/10.1093/trstmh/tru026">https://doi.org/10.1093/trstmh/tru026</a>.
</div>
</div></section></div> ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/Ross-Macdonald/index.html</guid>
  <pubDate>Wed, 16 Apr 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>The Birth of Epidemic Modeling: Daniel Bernoulli and the Smallpox Inoculation Controversy</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/Daniel_Bernoulli/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="introduction"><span class="header-section-number">1</span> Introduction</h2>
<p>Mathematical modeling of infectious diseases is now a cornerstone of public health decision-making. During COVID-19, we all became familiar with concepts like â€œflattening the curveâ€ and reproduction numbers. But did you know that the first mathematical model for infectious disease control was developed nearly 300 years ago? In 1760, a Swiss mathematician named Daniel Bernoulli created a revolutionary approach to evaluate a controversial medical procedure: smallpox inoculation <span class="citation" data-cites="bernoulli1766">(Bernoulli 1766)</span>. His work represents the birth of what we now call mathematical epidemiology <span class="citation" data-cites="dietz2002bernoulli">(Dietz and Heesterbeek 2002)</span>.</p>
</section>
<section id="who-was-daniel-bernoulli" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="who-was-daniel-bernoulli"><span class="header-section-number">2</span> Who Was Daniel Bernoulli?</h2>
<p>Daniel Bernoulli (1700-1782) came from a family of brilliant mathematicians. While his relatives focused on pure mathematics, Daniel pursued medicine alongside his mathematical studies <span class="citation" data-cites="hald2003history">(Hald 2003)</span>. This unique combination placed him perfectly to bridge these two worlds when a major public health controversy erupted in 18th century Europe.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.jonghoonk.com/blog/posts/Daniel_Bernoulli/https:/upload.wikimedia.org/wikipedia/commons/b/b3/Daniel_Bernoulli_by_Johann_Rudolf_Huber.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Daniel Bernoulli</figcaption>
</figure>
</div>
</section>
<section id="the-smallpox-crisis" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="the-smallpox-crisis"><span class="header-section-number">3</span> The Smallpox Crisis</h2>
<p>Today, we celebrate smallpox as the first human disease to be completely eradicated through vaccination. But in Bernoulliâ€™s time, smallpox was a devastating illness that:</p>
<ul>
<li>Killed approximately 400,000 Europeans annually</li>
<li>Caused death in 1 out of every 7-10 infected individuals</li>
<li>Left survivors permanently scarred and sometimes blind</li>
<li>Affected nearly everyone, with most contracting it during childhood</li>
</ul>
</section>
<section id="the-controversial-solution-variolation" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="the-controversial-solution-variolation"><span class="header-section-number">4</span> The Controversial Solution: Variolation</h2>
<p>In the early 18th century, a precursor to vaccination called â€œvariolationâ€ (or inoculation) was introduced to Europe <span class="citation" data-cites="blower2004attempt">(Blower and Bernoulli 2004)</span>. This procedure involved:</p>
<ol type="1">
<li>Taking a small amount of pus from a person with a mild case of smallpox</li>
<li>Inserting it under the skin of a healthy person</li>
<li>Inducing a usually milder form of the disease</li>
<li>Conferring lifelong immunity if the person survived</li>
</ol>
<p>This technique reduced the mortality rate from smallpox from about 15% to approximately 1-2%. However, it was extremely controversial because:</p>
<ul>
<li>It deliberately infected healthy people with a deadly disease</li>
<li>Some people died from the procedure itself</li>
<li>Inoculated individuals could spread smallpox to others</li>
<li>Religious and ethical objections were raised against â€œinterfering with Godâ€™s willâ€</li>
</ul>
</section>
<section id="bernoullis-breakthrough-the-first-disease-model" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="bernoullis-breakthrough-the-first-disease-model"><span class="header-section-number">5</span> Bernoulliâ€™s Breakthrough: The First Disease Model</h2>
<p>Bernoulli recognized that this controversy needed more than opinionsâ€”it needed data and mathematical analysis. In 1760, he presented his work â€œEssai dâ€™une nouvelle analyse de la mortalitÃ© causÃ©e par la petite vÃ©roleâ€ (Essay on a new analysis of the mortality caused by smallpox) to the Royal Academy of Sciences in Paris <span class="citation" data-cites="bernoulli1766">(Bernoulli 1766)</span>.</p>
<p>His approach was revolutionary because:</p>
<ol type="1">
<li>It was the first mathematical model specifically designed to evaluate a public health intervention</li>
<li>It separated the risk of dying from smallpox from other causes of death</li>
<li>It calculated potential years of life gained through inoculation</li>
<li>It used real demographic data from the city of London</li>
</ol>
</section>
<section id="the-model-explained-simply" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="the-model-explained-simply"><span class="header-section-number">6</span> The Model Explained Simply</h2>
<p>Bernoulliâ€™s approach can be understood through a simple analogy:</p>
<p>Imagine 1,000 children born in the same year. Without inoculation, these children face two risks as they age: - The risk of contracting and possibly dying from smallpox - The risk of dying from any other cause</p>
<p>Bernoulli used available data to estimate: - How many people would get smallpox each year - How many would die from it - How many would die from other causes</p>
<p>He then compared this natural scenario with one where everyone was inoculated against smallpox. Although inoculation carried its own small risk of death, Bernoulliâ€™s calculations showed that widespread inoculation would:</p>
<ul>
<li>Increase life expectancy by about 3 years (significant for that time period)</li>
<li>Save thousands of lives across a population</li>
</ul>
</section>
<section id="mathematical-innovation-the-life-table-approach" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="mathematical-innovation-the-life-table-approach"><span class="header-section-number">7</span> Mathematical Innovation: The Life Table Approach</h2>
<p>Bernoulliâ€™s work was mathematically innovative because he:</p>
<ol type="1">
<li>Created what we now call a â€œdynamic life tableâ€ - tracking population changes over time</li>
<li>Separated specific causes of death (what epidemiologists now call â€œcompeting risksâ€)</li>
<li>Introduced differential equations to model population changes due to disease <span class="citation" data-cites="dietz2002bernoulli">(Dietz and Heesterbeek 2002)</span></li>
</ol>
<p>In modern mathematical notation, his core equation looked something like:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bdp(a)%7D%7Bda%7D%20=%20-%5Cmu(a)p(a)%20-%20%5Clambda%20p_s(a)"></p>
<p>Where: - <img src="https://latex.codecogs.com/png.latex?p(a)"> represents the proportion of people surviving to age <img src="https://latex.codecogs.com/png.latex?a"> - <img src="https://latex.codecogs.com/png.latex?%5Cmu(a)"> is the force of mortality from causes other than smallpox - <img src="https://latex.codecogs.com/png.latex?%5Clambda"> is the rate of smallpox infection - <img src="https://latex.codecogs.com/png.latex?p_s(a)"> is the proportion of susceptible people at age <img src="https://latex.codecogs.com/png.latex?a"></p>
<p>While this may look intimidating, the concept is straightforward: Bernoulli tracked how many people would die from different causes under different scenarios <span class="citation" data-cites="heesterbeek1996oxford">(J. A. P. Heesterbeek and Dietz 1996)</span>.</p>
</section>
<section id="impact-and-legacy" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="impact-and-legacy"><span class="header-section-number">8</span> Impact and Legacy</h2>
<p>Bernoulliâ€™s mathematical analysis had profound effects:</p>
<ol type="1">
<li><p><strong>Quantified benefits</strong>: He showed that inoculation would increase life expectancy by approximately 3 years - remarkable in an era when life expectancy was around 30 years <span class="citation" data-cites="blower2004attempt">(Blower and Bernoulli 2004)</span>.</p></li>
<li><p><strong>Risk comparison</strong>: He demonstrated that the 1-2% risk of death from inoculation was far smaller than the lifetime risk of dying from natural smallpox infection.</p></li>
<li><p><strong>Policy influence</strong>: His work helped shift public opinion and policy toward accepting inoculation as a worthwhile public health measure.</p></li>
<li><p><strong>Methodological innovation</strong>: He established mathematical modeling as a valid approach to public health questions <span class="citation" data-cites="hethcote2000mathematics">(Hethcote 2000)</span>.</p></li>
</ol>
</section>
<section id="the-birth-of-mathematical-epidemiology" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="the-birth-of-mathematical-epidemiology"><span class="header-section-number">9</span> The Birth of Mathematical Epidemiology</h2>
<p>Bernoulliâ€™s approach contained the seeds of modern infectious disease modeling:</p>
<ul>
<li>It used mathematics to predict disease outcomes</li>
<li>It quantified the impact of interventions</li>
<li>It separated competing causes of death</li>
<li>It estimated population-level effects from individual risks</li>
</ul>
<p>The field that Bernoulli pioneered would later be expanded by other mathematical innovators like Ronald Ross <span class="citation" data-cites="ross1908report ross1911prevention">(Ross 1908, 1911)</span> and the team of Kermack and McKendrick <span class="citation" data-cites="kermack1927contribution">(Kermack and McKendrick 1927)</span>, eventually leading to the sophisticated models we use today <span class="citation" data-cites="anderson1991infectious">(Anderson and May 1991)</span>.</p>
</section>
<section id="modern-applications-of-bernoullis-approach" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="modern-applications-of-bernoullis-approach"><span class="header-section-number">10</span> Modern Applications of Bernoulliâ€™s Approach</h2>
<p>The principles Bernoulli established are still used to answer questions like:</p>
<ul>
<li>How many lives will a new vaccine save? <span class="citation" data-cites="ferguson2006strategies">(Ferguson et al. 2006)</span></li>
<li>Is a screening program worth its costs?</li>
<li>Which age groups should receive priority for limited medical resources?</li>
<li>What is the optimal strategy for controlling an epidemic? <span class="citation" data-cites="riley2003transmission">(Riley et al. 2003)</span></li>
</ul>
<p>Modern epidemic models have incorporated additional mathematical sophistication, particularly around the concept of the basic reproduction number (Râ‚€) and the construction of next-generation matrices <span class="citation" data-cites="diekmann2010construction wallinga2007generation">(Diekmann, Heesterbeek, and Roberts 2010; Wallinga and Lipsitch 2007)</span>, but they still follow Bernoulliâ€™s fundamental approach of using mathematics to guide public health decisions.</p>
</section>
<section id="conclusion" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">11</span> Conclusion</h2>
<p>Daniel Bernoulliâ€™s 1760 smallpox model represents a pivotal moment in the history of public health <span class="citation" data-cites="bernoulli1766">(Bernoulli 1766)</span>. By applying mathematical reasoning to a contentious medical issue, he demonstrated that data and analysis could guide decisions more effectively than opinions alone.</p>
<p>As we continue to face infectious disease challenges in the modern world, from emerging pathogens to vaccine hesitancy, Bernoulliâ€™s approach remains relevant <span class="citation" data-cites="keeling2008modeling">(Keeling and Rohani 2008)</span>. His work reminds us that mathematical modeling is not just an academic exercise but a powerful tool for saving lives and informing policy.</p>
<p>The next time you hear about disease models predicting the course of an epidemic or evaluating the impact of interventions, remember that this approach began with a mathematician applying his skills to a pressing public health problem nearly three centuries ago <span class="citation" data-cites="heesterbeek2015mathematical">(H. Heesterbeek and Roberts 2015)</span>.</p>
</section>
<section id="references" class="level2" data-number="12">




</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">12 References</h2><div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-anderson1991infectious" class="csl-entry">
Anderson, Roy M., and Robert M. May. 1991. <span>â€œInfectious Diseases of Humans: Dynamics and Control.â€</span> <em>Oxford University Press</em>.
</div>
<div id="ref-bernoulli1766" class="csl-entry">
Bernoulli, Daniel. 1766. <span>â€œEssai dâ€™une Nouvelle Analyse de La Mortalit<span>Ã©</span> Caus<span>Ã©</span>e Par La Petite v<span>Ã©</span>role.â€</span> <em>M<span>Ã©</span>moires de Math<span>Ã©</span>matiques Et de Physique, Acad<span>Ã©</span>mie Royale Des Sciences</em>, 1â€“45.
</div>
<div id="ref-blower2004attempt" class="csl-entry">
Blower, Sally, and Daniel Bernoulli. 2004. <span>â€œAn Attempt at a New Analysis of the Mortality Caused by Smallpox and of the Advantages of Inoculation to Prevent It.â€</span> <em>Reviews in Medical Virology</em> 14 (5): 275â€“88.
</div>
<div id="ref-diekmann2010construction" class="csl-entry">
Diekmann, Odo, J. A. P. Heesterbeek, and Michael G. Roberts. 2010. <span>â€œThe Construction of Next-Generation Matrices for Compartmental Epidemic Models.â€</span> <em>Journal of the Royal Society Interface</em> 7 (47): 873â€“85.
</div>
<div id="ref-dietz2002bernoulli" class="csl-entry">
Dietz, Klaus, and J. A. P. Heesterbeek. 2002. <span>â€œDaniel Bernoulliâ€™s Epidemiological Model Revisited.â€</span> <em>Mathematical Biosciences</em> 180 (1-2): 1â€“21.
</div>
<div id="ref-ferguson2006strategies" class="csl-entry">
Ferguson, Neil M., Derek A. T. Cummings, Christophe Fraser, James C. Cajka, Philip C. Cooley, and Donald S. Burke. 2006. <span>â€œStrategies for Mitigating an Influenza Pandemic.â€</span> <em>Nature</em> 442 (7101): 448â€“52.
</div>
<div id="ref-hald2003history" class="csl-entry">
Hald, Anders. 2003. <em>History of Probability and Statistics and Their Applications Before 1750</em>. Hoboken, NJ: John Wiley &amp; Sons.
</div>
<div id="ref-heesterbeek2015mathematical" class="csl-entry">
Heesterbeek, Hans, and Mick G. Roberts. 2015. <span>â€œHow Mathematical Epidemiology Became a Field of Biology: A Commentary on Anderson and May (1981) â€™the Population Dynamics of Microparasites and Their Invertebrate Hostsâ€™.â€</span> <em>Philosophical Transactions of the Royal Society B</em> 370 (1666): 20140307.
</div>
<div id="ref-heesterbeek1996oxford" class="csl-entry">
Heesterbeek, J. A. P., and Klaus Dietz. 1996. <span>â€œMathematical Epidemiology of Infectious Diseases: Model Building, Analysis and Interpretation.â€</span> <em>Mathematical Biosciences</em> 146 (1): 77â€“79.
</div>
<div id="ref-hethcote2000mathematics" class="csl-entry">
Hethcote, Herbert W. 2000. <span>â€œThe Mathematics of Infectious Diseases.â€</span> <em>SIAM Review</em> 42 (4): 599â€“653.
</div>
<div id="ref-keeling2008modeling" class="csl-entry">
Keeling, Matt J., and Pejman Rohani. 2008. <span>â€œModeling Infectious Diseases in Humans and Animals.â€</span> <em>Princeton University Press</em>.
</div>
<div id="ref-kermack1927contribution" class="csl-entry">
Kermack, William O., and Anderson G. McKendrick. 1927. <span>â€œA Contribution to the Mathematical Theory of Epidemics.â€</span> <em>Proceedings of the Royal Society of London. Series A</em> 115 (772): 700â€“721.
</div>
<div id="ref-riley2003transmission" class="csl-entry">
Riley, Steven, Christophe Fraser, Christl A. Donnelly, Azra C. Ghani, Laith J. Abu-Raddad, Anthony J. Hedley, Gabriel M. Leung, et al. 2003. <span>â€œTransmission Dynamics of the Etiological Agent of SARS in Hong Kong: Impact of Public Health Interventions.â€</span> <em>Science</em> 300 (5627): 1961â€“66.
</div>
<div id="ref-ross1908report" class="csl-entry">
Ross, Ronald. 1908. <span>â€œReport on the Prevention of Malaria in Mauritius.â€</span>
</div>
<div id="ref-ross1911prevention" class="csl-entry">
â€”â€”â€”. 1911. <em>The Prevention of Malaria</em>. London: John Murray.
</div>
<div id="ref-wallinga2007generation" class="csl-entry">
Wallinga, Jacco, and Marc Lipsitch. 2007. <span>â€œHow Generation Intervals Shape the Relationship Between Growth Rates and Reproductive Numbers.â€</span> <em>Proceedings of the Royal Society B: Biological Sciences</em> 274 (1609): 599â€“604.
</div>
</div></section></div> ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/Daniel_Bernoulli/index.html</guid>
  <pubDate>Sun, 13 Apr 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Regularization in statistical models</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/regularization/index.html</link>
  <description><![CDATA[ 



<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(glmnet)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(caret)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(recipes)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span></code></pre></div>
</details>
</div>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Regularization is a fundamental technique in statistical modeling that helps prevent overfitting and improves model generalization. This blog post explores different regularization methods, their implementation in R, and their practical applications, with a special focus on scenarios where the number of parameters exceeds the number of observations (p &gt; n).</p>
</section>
<section id="understanding-regularization" class="level2">
<h2 class="anchored" data-anchor-id="understanding-regularization">Understanding Regularization</h2>
<p>Regularization works by adding a penalty term to the modelâ€™s loss function, effectively constraining the magnitude of model coefficients. The three most common types are:</p>
<ol type="1">
<li>Ridge (L2)</li>
<li>Lasso (L1)</li>
<li>Elastic Net (combination of L1 and L2)</li>
</ol>
</section>
<section id="simulation-study-when-p-n" class="level2">
<h2 class="anchored" data-anchor-id="simulation-study-when-p-n">Simulation Study: When p &gt; n</h2>
<p>Letâ€™s first create a scenario where we have more parameters than observations:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate synthetic data</span></span>
<span id="cb2-2">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of observations</span></span>
<span id="cb2-3">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of predictors</span></span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create sparse true coefficients (most are zero)</span></span>
<span id="cb2-6">true_beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, p)</span>
<span id="cb2-7">true_beta[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate predictor matrix</span></span>
<span id="cb2-10">X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> n)</span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate response with some noise</span></span>
<span id="cb2-12">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> true_beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to data frame</span></span>
<span id="cb2-15">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(X)</span>
<span id="cb2-16">data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y</span></code></pre></div>
</details>
</div>
</section>
<section id="ridge-regression-l2" class="level2">
<h2 class="anchored" data-anchor-id="ridge-regression-l2">Ridge Regression (L2)</h2>
<p>Ridge regression adds the sum of squared coefficients to the loss function:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare data for glmnet</span></span>
<span id="cb3-2">x_matrix <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(data[, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ncol</span>(data)])</span>
<span id="cb3-3">y_vector <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit ridge regression</span></span>
<span id="cb3-6">ridge_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb3-7">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)))</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validation to find optimal lambda</span></span>
<span id="cb3-10">cv_ridge <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cv.glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb3-11"></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot cross-validation results</span></span>
<span id="cb3-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(cv_ridge)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/regularization/index_files/figure-html/ridge-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="lasso-regression-l1" class="level2">
<h2 class="anchored" data-anchor-id="lasso-regression-l1">Lasso Regression (L1)</h2>
<p>Lasso regression uses absolute value penalties and can perform variable selection:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit lasso regression</span></span>
<span id="cb4-2">lasso_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb4-3">                    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)))</span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validation</span></span>
<span id="cb4-6">cv_lasso <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cv.glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-7"></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot solution path</span></span>
<span id="cb4-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(lasso_fit, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xvar =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">label =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/regularization/index_files/figure-html/lasso-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="elastic-net" class="level2">
<h2 class="anchored" data-anchor-id="elastic-net">Elastic Net</h2>
<p>Elastic Net combines both L1 and L2 penalties:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit elastic net with alpha = 0.5</span></span>
<span id="cb5-2">enet_fit <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>,</span>
<span id="cb5-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)))</span>
<span id="cb5-4"></span>
<span id="cb5-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Cross-validation</span></span>
<span id="cb5-6">cv_enet <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cv.glmnet</span>(x_matrix, y_vector, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb5-7"></span>
<span id="cb5-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compare coefficients at optimal lambda</span></span>
<span id="cb5-9">coef_comparison <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb5-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">true =</span> true_beta,</span>
<span id="cb5-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ridge =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(cv_ridge, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda.min"</span>))[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lasso =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(cv_lasso, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda.min"</span>))[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">elastic =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.vector</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">coef</span>(cv_enet, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">s =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"lambda.min"</span>))[<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb5-14">)</span>
<span id="cb5-15"></span>
<span id="cb5-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot first 20 coefficients</span></span>
<span id="cb5-17"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">head</span>(coef_comparison, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   true        ridge      lasso       elastic
1   1.5  0.168206623  1.4215046  1.3290087822
2  -0.8 -0.136466379 -0.7070713 -0.7202401708
3   1.2  0.159580168  1.1339067  1.0787191944
4  -0.5 -0.036699418 -0.2745075 -0.2490259735
5   0.9  0.074879809  0.8026272  0.7517043315
6   0.0 -0.023896821  0.0000000  0.0000000000
7   0.0 -0.009236366  0.0000000  0.0000000000
8   0.0 -0.015842275  0.0000000  0.0000000000
9   0.0 -0.104338887  0.0000000 -0.0146134033
10  0.0 -0.011447505  0.0000000  0.0000000000
11  0.0  0.044632265  0.0000000  0.0000000000
12  0.0  0.005038114  0.0000000  0.0000000000
13  0.0 -0.008216405  0.0000000  0.0000000000
14  0.0  0.028400026  0.0000000  0.0001638061
15  0.0  0.011236623  0.0000000  0.0000000000
16  0.0  0.003305804  0.0000000  0.0000000000
17  0.0  0.017521241  0.0000000  0.0000000000
18  0.0  0.021065650  0.0000000  0.0000000000
19  0.0 -0.005236160  0.0000000  0.0000000000
20  0.0  0.039430620  0.0000000  0.0000000000</code></pre>
</div>
</div>
</section>
<section id="regularization-in-p-n-scenarios" class="level2">
<h2 class="anchored" data-anchor-id="regularization-in-p-n-scenarios">Regularization in p &gt; n Scenarios</h2>
<p>When the number of parameters (p) exceeds the number of observations (n), regularization becomes not just useful but essential. Hereâ€™s why:</p>
<ol type="1">
<li><p><strong>Mathematical Necessity</strong>: Without regularization, the problem is ill-posed as there are infinitely many solutions that perfectly fit the training data.</p></li>
<li><p><strong>Variance Reduction</strong>: Regularization helps reduce the variance of parameter estimates, which is particularly important when we have limited data.</p></li>
<li><p><strong>Feature Selection</strong>: Lasso and Elastic Net can help identify the most important features, which is crucial when dealing with high-dimensional data.</p></li>
</ol>
<p>Letâ€™s demonstrate this with a comparison of prediction errors:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate test data</span></span>
<span id="cb7-2">X_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">nrow =</span> n)</span>
<span id="cb7-3">y_test <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> X_test <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%*%</span> true_beta <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(n, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate MSE for each method</span></span>
<span id="cb7-6">mse <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Method =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Ridge"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lasso"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Elastic Net"</span>),</span>
<span id="cb7-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">MSE =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(</span>
<span id="cb7-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(cv_ridge, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newx =</span> X_test) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_test)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb7-10">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(cv_lasso, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newx =</span> X_test) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_test)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb7-11">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(cv_enet, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">newx =</span> X_test) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_test)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-12">  )</span>
<span id="cb7-13">)</span>
<span id="cb7-14"></span>
<span id="cb7-15"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(mse)</span></code></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>       Method       MSE
1       Ridge 6.3827969
2       Lasso 0.4183443
3 Elastic Net 0.5025287</code></pre>
</div>
</div>
</section>
<section id="best-practices-and-recommendations" class="level2">
<h2 class="anchored" data-anchor-id="best-practices-and-recommendations">Best Practices and Recommendations</h2>
<p>When working with p &gt; n scenarios:</p>
<ol type="1">
<li><p><strong>Start with Cross-Validation</strong>: Always use cross-validation to select the optimal regularization parameter (Î»).</p></li>
<li><p><strong>Consider Multiple Methods</strong>: Try different regularization approaches as their performance can vary depending on the underlying data structure.</p></li>
<li><p><strong>Scale Features</strong>: Standardize predictors before applying regularization to ensure fair penalization.</p></li>
<li><p><strong>Monitor Sparsity</strong>: If interpretability is important, prefer Lasso or Elastic Net as they can produce sparse solutions.</p></li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Regularization is particularly crucial in p &gt; n scenarios, where it helps: - Prevent perfect but meaningless fits to training data - Reduce model complexity - Identify important features - Improve prediction accuracy on new data</p>
<p>The choice between Ridge, Lasso, and Elastic Net depends on your specific needs regarding sparsity, prediction accuracy, and interpretability.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ol type="1">
<li>Hastie, T., Tibshirani, R., &amp; Friedman, J. (2009). The Elements of Statistical Learning.</li>
<li>Zou, H., &amp; Hastie, T. (2005). Regularization and variable selection via the elastic net.</li>
<li>James, G., Witten, D., Hastie, T., &amp; Tibshirani, R. (2013). An Introduction to Statistical Learning.</li>
</ol>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/regularization/index.html</guid>
  <pubDate>Sat, 01 Feb 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Understanding correlation, covariation, and least squares regression</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/correlation/index.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Understanding relationships between variables is a fundamental aspect of statistical analysis. Three key concepts in this domain are <strong>correlation</strong>, <strong>covariation</strong>, and <strong>least squares regression</strong>. In this post, we will explore how these concepts interrelate and use <strong>R</strong> for demonstration.</p>
</section>
<section id="covariance" class="level2">
<h2 class="anchored" data-anchor-id="covariance">Covariance</h2>
<p>Covariance measures how two variables move together. The covariance between two variables <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7BCov%7D(X,%20Y)%20=%20%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20(X_i%20-%20%5Cbar%7BX%7D)(Y_i%20-%20%5Cbar%7BY%7D)%0A"></p>
<p>where: - <img src="https://latex.codecogs.com/png.latex?X_i,%20Y_i"> are individual observations, - <img src="https://latex.codecogs.com/png.latex?%5Cbar%7BX%7D,%20%5Cbar%7BY%7D"> are the means of <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">.</p>
<p>A positive covariance indicates that as <img src="https://latex.codecogs.com/png.latex?X"> increases, <img src="https://latex.codecogs.com/png.latex?Y"> tends to increase. A negative covariance suggests an inverse relationship.</p>
<section id="r-code-example" class="level3">
<h3 class="anchored" data-anchor-id="r-code-example">R code example</h3>
<div class="sourceCode" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate sample data</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb1-3">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-4">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute covariance</span></span>
<span id="cb1-7">cov_xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cov</span>(x, y)</span>
<span id="cb1-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(cov_xy)</span></code></pre></div>
</section>
</section>
<section id="correlation" class="level2">
<h2 class="anchored" data-anchor-id="correlation">Correlation</h2>
<p>Correlation standardizes covariance by dividing it by the product of standard deviations of <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">. The Pearson correlation coefficient is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Crho_%7BX,Y%7D%20=%20%5Cfrac%7B1%7D%7Bn%7D%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20%5Cleft(%5Cfrac%7BX_i%20-%20%5Cbar%7BX%7D%7D%7Bs_X%7D%5Cright)%20%5Cleft(%5Cfrac%7BY_i%20-%20%5Cbar%7BY%7D%7D%7Bs_Y%7D%5Cright)%20=%20%5Cfrac%7B%5Ctext%7BCov%7D(X,%20Y)%7D%7Bs_X%20s_Y%7D%0A"> where <img src="https://latex.codecogs.com/png.latex?s_X"> and <img src="https://latex.codecogs.com/png.latex?s_Y"> are standard deviations of <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">. The correlation coefficient ranges from -1 to 1: - <strong>+1</strong>: Perfect positive correlation - <strong>-1</strong>: Perfect negative correlation - <strong>0</strong>: No linear relationship</p>
<section id="r-code-example-1" class="level3">
<h3 class="anchored" data-anchor-id="r-code-example-1">R Code Example</h3>
<div class="sourceCode" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute correlation</span></span>
<span id="cb2-2">cor_xy <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cor</span>(x, y)</span>
<span id="cb2-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(cor_xy)</span></code></pre></div>
</section>
</section>
<section id="least-squares-regression" class="level2">
<h2 class="anchored" data-anchor-id="least-squares-regression">Least squares regression</h2>
<p>Least squares regression models the relationship between <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> by fitting a line that minimizes the sum of squared residuals:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20X%20+%20%5Cepsilon%0A"></p>
<p>where: - <img src="https://latex.codecogs.com/png.latex?%5Cbeta_0"> (intercept) and <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> (slope) are estimated using:</p>
<p>The equation for the <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> can be derived by minimizing the error sum of squares (SSE) <img src="https://latex.codecogs.com/png.latex?%0ASSE%20=%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20(Y_i%20-%20(%5Cbeta_0%20+%20%5Cbeta_1%20X_i))%5E2%0A"> , which in turn can be solved using the following equation. <img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20%5Cbeta_1%7D%20%5Csum_%7Bi=1%7D%5E%7Bn%7D%20(Y_i%20-%20%5Cbeta_0%20-%20%5Cbeta_1%20X_i)%5E2%20=%200%0A"></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_1%20=%20%5Cfrac%7B%5Ctext%7BCov%7D(X,%20Y)%7D%7B%5Ctext%7BVar%7D(X)%7D%0A"></p>
<p>The intuition behind this formula is as follows. Covariance <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BCov%7D(X,Y)"> measures how <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y"> vary together. Variance <img src="https://latex.codecogs.com/png.latex?%5Ctext%7BVar%7D(X)"> measures how spread out <img src="https://latex.codecogs.com/png.latex?X"> is.<br>
The ratio <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Ctext%7BCov%7D(X,Y)%7D%7B%5Ctext%7BVar%7D(X)%7D"> tells us the change in <img src="https://latex.codecogs.com/png.latex?Y"> for a one-unit change in <img src="https://latex.codecogs.com/png.latex?X">. This makes sense because we are essentially scaling the covariance by the variability of <img src="https://latex.codecogs.com/png.latex?X">â€“ensuring that our slope correctly reflects how much <img src="https://latex.codecogs.com/png.latex?Y"> changes per unit of <img src="https://latex.codecogs.com/png.latex?X">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_0%20=%20%5Cbar%7BY%7D%20-%20%5Cbeta_1%20%5Cbar%7BX%7D%0A"></p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> represents the residual error.</li>
</ul>
<section id="r-code-example-2" class="level3">
<h3 class="anchored" data-anchor-id="r-code-example-2">R code Example</h3>
<div class="sourceCode" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fit a linear model</span></span>
<span id="cb3-2">model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> x)</span>
<span id="cb3-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(model)</span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot regression</span></span>
<span id="cb3-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Least Squares Regression"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pch =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">19</span>)</span>
<span id="cb3-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
</section>
</section>
<section id="relationship-between-concepts" class="level2">
<h2 class="anchored" data-anchor-id="relationship-between-concepts">Relationship between concepts</h2>
<ol type="1">
<li><strong>Covariation quantifies the direction and strength of a linear relationship</strong> but does not standardize it.</li>
<li><strong>Correlation standardizes covariance</strong> to provide a measure that is independent of the units of <img src="https://latex.codecogs.com/png.latex?X"> and <img src="https://latex.codecogs.com/png.latex?Y">.</li>
<li><strong>Least squares regression uses covariance to estimate the slope (<img src="https://latex.codecogs.com/png.latex?%5Cbeta_1">)</strong> and define the best-fit line.</li>
</ol>
<section id="summary-table" class="level3">
<h3 class="anchored" data-anchor-id="summary-table">Summary Table</h3>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 46%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Concept</th>
<th>Definition &amp; Formula</th>
<th>Interpretation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Covariation</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Ctext%7BCov%7D(X,%20Y)%20=%20%5Cfrac%7B1%7D%7Bn%7D%20%5Csum%20(X_i%20-%20%5Cbar%7BX%7D)(Y_i%20-%20%5Cbar%7BY%7D)"></td>
<td>Measures the direction of relationship but not the scale.</td>
</tr>
<tr class="even">
<td>Correlation</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Crho_%7BX,Y%7D%20=%20%5Cfrac%7B%5Ctext%7BCov%7D(X,%20Y)%7D%7Bs_X%20s_Y%7D"></td>
<td>Standardized measure of association between -1 and 1.</td>
</tr>
<tr class="odd">
<td>Regression</td>
<td><img src="https://latex.codecogs.com/png.latex?Y%20=%20%5Cbeta_0%20+%20%5Cbeta_1%20X%20+%20%5Cepsilon"></td>
<td>Uses covariance to estimate <img src="https://latex.codecogs.com/png.latex?%5Cbeta_1"> and predict <img src="https://latex.codecogs.com/png.latex?Y">.</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>Understanding <strong>covariance, correlation, and regression</strong> allows for deeper insights into data relationships. Covariance provides directionality, correlation offers a unit-free measure of strength, and regression predicts outcomes. By applying these techniques in <strong>R</strong>, we can uncover meaningful patterns in data!</p>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/correlation/index.html</guid>
  <pubDate>Wed, 29 Jan 2025 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Distribution Matching Methods: From Theory to Practice</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/distribution_matching/index.html</link>
  <description><![CDATA[ 



<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load required packages</span></span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(MASS)</span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ks)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(patchwork)</span>
<span id="cb1-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyr)</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(dplyr)</span></code></pre></div>
</div>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>When working with data from different sources or distributions, we often need to transform one distribution to match another. In this post, weâ€™ll explore various methods for distribution matching, implement them in R, and discuss their strengths and limitations.</p>
</section>
<section id="distribution-matching-methods" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Distribution Matching Methods</h1>
<section id="quantile-matching" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="quantile-matching"><span class="header-section-number">2.1</span> Quantile Matching</h2>
<p>Quantile matching transforms data by mapping corresponding quantiles between distributions. Itâ€™s a non-parametric approach that preserves the rank order of the original data.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">quantile_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(A, B) {</span>
<span id="cb2-2">  probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">length.out =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(A))</span>
<span id="cb2-3">  sorted_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(A)</span>
<span id="cb2-4">  </span>
<span id="cb2-5">  B_transformed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">approx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> probs,</span>
<span id="cb2-6">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> sorted_A,</span>
<span id="cb2-7">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xout =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rank</span>(B)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(B) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb2-8">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">method =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linear"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y</span>
<span id="cb2-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(B_transformed)</span>
<span id="cb2-10">}</span></code></pre></div>
</details>
</div>
</section>
<section id="box-cox-transformation" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="box-cox-transformation"><span class="header-section-number">2.2</span> Box-Cox Transformation</h2>
<p>The Box-Cox transformation is particularly useful when you want to transform data to approximate normality before matching moments.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">boxcox_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(A, B) {</span>
<span id="cb3-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find optimal lambda for both distributions</span></span>
<span id="cb3-3">  bc_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boxcox</span>(A <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">plotit =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">FALSE</span>)</span>
<span id="cb3-4">  lambda_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> bc_A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x[<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">which.max</span>(bc_A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y)]</span>
<span id="cb3-5">  </span>
<span id="cb3-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transform to normality</span></span>
<span id="cb3-7">  transform_boxcox <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, lambda) {</span>
<span id="cb3-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(lambda) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>) {</span>
<span id="cb3-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(x)</span>
<span id="cb3-10">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb3-11">      (x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>lambda <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> lambda</span>
<span id="cb3-12">    }</span>
<span id="cb3-13">  }</span>
<span id="cb3-14">  </span>
<span id="cb3-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transform both samples</span></span>
<span id="cb3-16">  A_transformed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transform_boxcox</span>(A, lambda_A)</span>
<span id="cb3-17">  B_transformed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">transform_boxcox</span>(B, lambda_A)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use same lambda</span></span>
<span id="cb3-18">  </span>
<span id="cb3-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Match moments</span></span>
<span id="cb3-20">  B_standardized <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (B_transformed <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(B_transformed)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(B_transformed)</span>
<span id="cb3-21">  B_matched <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> B_standardized <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(A_transformed) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(A_transformed)</span>
<span id="cb3-22">  </span>
<span id="cb3-23">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inverse transform</span></span>
<span id="cb3-24">  inverse_boxcox <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x, lambda) {</span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abs</span>(lambda) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>) {</span>
<span id="cb3-26">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(x)</span>
<span id="cb3-27">    } <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> {</span>
<span id="cb3-28">      (lambda <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>lambda)</span>
<span id="cb3-29">    }</span>
<span id="cb3-30">  }</span>
<span id="cb3-31">  </span>
<span id="cb3-32">  B_final <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">inverse_boxcox</span>(B_matched, lambda_A)</span>
<span id="cb3-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(B_final)</span>
<span id="cb3-34">}</span></code></pre></div>
</details>
</div>
</section>
<section id="kernel-density-based-transformation" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="kernel-density-based-transformation"><span class="header-section-number">2.3</span> Kernel Density-Based Transformation</h2>
<p>This method uses kernel density estimation to transform the distributions.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">kernel_density_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(A, B, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bw =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"nrd0"</span>) {</span>
<span id="cb4-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Estimate densities</span></span>
<span id="cb4-3">  density_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kde</span>(A, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bw.nrd0</span>(A))</span>
<span id="cb4-4">  density_B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kde</span>(B, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">h =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">bw.nrd0</span>(B))</span>
<span id="cb4-5">  </span>
<span id="cb4-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate CDFs using numerical integration</span></span>
<span id="cb4-7">  cdf_A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb4-8">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(x, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(xi) {</span>
<span id="cb4-9">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(xi, A, density_A<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>h))</span>
<span id="cb4-10">    })</span>
<span id="cb4-11">  }</span>
<span id="cb4-12">  </span>
<span id="cb4-13">  cdf_B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb4-14">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(x, <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(xi) {</span>
<span id="cb4-15">      <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pnorm</span>(xi, B, density_B<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>h))</span>
<span id="cb4-16">    })</span>
<span id="cb4-17">  }</span>
<span id="cb4-18">  </span>
<span id="cb4-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transform B to match A's distribution</span></span>
<span id="cb4-20">  B_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cdf_B</span>(B)</span>
<span id="cb4-21">  </span>
<span id="cb4-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create quantile function for A using interpolation</span></span>
<span id="cb4-23">  A_sorted <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sort</span>(A)</span>
<span id="cb4-24">  A_probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cdf_A</span>(A_sorted)</span>
<span id="cb4-25">  </span>
<span id="cb4-26">  B_transformed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">approx</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> A_probs,</span>
<span id="cb4-27">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> A_sorted,</span>
<span id="cb4-28">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xout =</span> B_probs,</span>
<span id="cb4-29">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yleft =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">min</span>(A),</span>
<span id="cb4-30">                         <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yright =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">max</span>(A))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y</span>
<span id="cb4-31">  </span>
<span id="cb4-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(B_transformed)</span>
<span id="cb4-33">}</span></code></pre></div>
</details>
</div>
</section>
<section id="moment-matching" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="moment-matching"><span class="header-section-number">2.4</span> Moment Matching</h2>
<p>A simpler approach that focuses on matching the first two moments of the distributions.</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">moment_match <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(A, B) {</span>
<span id="cb5-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standardize B</span></span>
<span id="cb5-3">  B_std <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (B <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(B)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(B)</span>
<span id="cb5-4">  </span>
<span id="cb5-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transform to match A's moments</span></span>
<span id="cb5-6">  B_transformed <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> B_std <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(A) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(A)</span>
<span id="cb5-7">  </span>
<span id="cb5-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(B_transformed)</span>
<span id="cb5-9">}</span></code></pre></div>
</details>
</div>
</section>
</section>
<section id="comparing-the-methods" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Comparing the Methods</h1>
<p>Letâ€™s generate some sample data and compare all methods:</p>
<div class="cell">
<details open="">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set seed for reproducibility</span></span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">123</span>)</span>
<span id="cb6-3"></span>
<span id="cb6-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate sample data</span></span>
<span id="cb6-5">A <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mean =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sd =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normal distribution</span></span>
<span id="cb6-6">B <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rexp</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">rate =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)          <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Exponential distribution</span></span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply all transformations</span></span>
<span id="cb6-9">B_quantile <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile_match</span>(A, B)</span>
<span id="cb6-10">B_boxcox <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boxcox_match</span>(A, B)</span>
<span id="cb6-11">B_kernel <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernel_density_match</span>(A, B)</span>
<span id="cb6-12">B_moment <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">moment_match</span>(A, B)</span></code></pre></div>
</details>
</div>
<section id="visual-comparison" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="visual-comparison"><span class="header-section-number">3.1</span> Visual Comparison</h2>
<p>Letâ€™s create a more elegant visualization using ggplot2:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a data frame for plotting</span></span>
<span id="cb7-2">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Original_A =</span> A,</span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Original_B =</span> B,</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Quantile =</span> B_quantile,</span>
<span id="cb7-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BoxCox =</span> B_boxcox,</span>
<span id="cb7-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Kernel =</span> B_kernel,</span>
<span id="cb7-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Moment =</span> B_moment</span>
<span id="cb7-9">)</span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert to long format</span></span>
<span id="cb7-12">df_long <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pivot_longer</span>(df, </span>
<span id="cb7-13">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cols =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">everything</span>(),</span>
<span id="cb7-14">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">names_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Method"</span>,</span>
<span id="cb7-15">                       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values_to =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>)</span>
<span id="cb7-16"></span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the plot</span></span>
<span id="cb7-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df_long, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> Value, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill =</span> Method)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_density</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">alpha =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-20">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>Method, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">scales =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"free_y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-22">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>,</span>
<span id="cb7-23">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>,</span>
<span id="cb7-24">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Comparison of Distribution Matching Methods"</span>,</span>
<span id="cb7-25">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original A (target) vs Original B and transformed distributions"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb7-26">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"none"</span>)</span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://www.jonghoonk.com/blog/posts/distribution_matching/index_files/figure-html/visualization-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption class="figure-caption">Comparison of Distribution Matching Methods</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="numerical-comparison" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="numerical-comparison"><span class="header-section-number">3.2</span> Numerical Comparison</h2>
<p>Letâ€™s compare some summary statistics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to calculate summary statistics</span></span>
<span id="cb8-2">get_stats <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(x) {</span>
<span id="cb8-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Mean =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x),</span>
<span id="cb8-4">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">SD =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(x),</span>
<span id="cb8-5">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Median =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">median</span>(x),</span>
<span id="cb8-6">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Skewness =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,</span>
<span id="cb8-7">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Kurtosis =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>((x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sd</span>(x)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb8-8">}</span>
<span id="cb8-9"></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate statistics for all distributions</span></span>
<span id="cb8-11">stats_df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(</span>
<span id="cb8-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Original_A =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(A),</span>
<span id="cb8-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Original_B =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(B),</span>
<span id="cb8-14">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Quantile =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(B_quantile),</span>
<span id="cb8-15">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BoxCox =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(B_boxcox),</span>
<span id="cb8-16">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Kernel =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(B_kernel),</span>
<span id="cb8-17">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Moment =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">get_stats</span>(B_moment)</span>
<span id="cb8-18">)</span>
<span id="cb8-19"></span>
<span id="cb8-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the results</span></span>
<span id="cb8-21">knitr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kable</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">round</span>(stats_df, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Summary Statistics Comparison </caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">Original_A</th>
<th style="text-align: right;">Original_B</th>
<th style="text-align: right;">Quantile</th>
<th style="text-align: right;">BoxCox</th>
<th style="text-align: right;">Kernel</th>
<th style="text-align: right;">Moment</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Mean</td>
<td style="text-align: right;">10.032</td>
<td style="text-align: right;">9.837</td>
<td style="text-align: right;">10.031</td>
<td style="text-align: right;">10.031</td>
<td style="text-align: right;">10.093</td>
<td style="text-align: right;">10.032</td>
</tr>
<tr class="even">
<td style="text-align: left;">SD</td>
<td style="text-align: right;">1.983</td>
<td style="text-align: right;">9.720</td>
<td style="text-align: right;">1.967</td>
<td style="text-align: right;">2.011</td>
<td style="text-align: right;">1.872</td>
<td style="text-align: right;">1.983</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Median</td>
<td style="text-align: right;">10.018</td>
<td style="text-align: right;">6.684</td>
<td style="text-align: right;">10.018</td>
<td style="text-align: right;">9.424</td>
<td style="text-align: right;">9.989</td>
<td style="text-align: right;">9.389</td>
</tr>
<tr class="even">
<td style="text-align: left;">Skewness</td>
<td style="text-align: right;">0.065</td>
<td style="text-align: right;">1.686</td>
<td style="text-align: right;">0.057</td>
<td style="text-align: right;">1.532</td>
<td style="text-align: right;">0.444</td>
<td style="text-align: right;">1.686</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Kurtosis</td>
<td style="text-align: right;">2.920</td>
<td style="text-align: right;">6.075</td>
<td style="text-align: right;">2.842</td>
<td style="text-align: right;">5.459</td>
<td style="text-align: right;">2.736</td>
<td style="text-align: right;">6.075</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="method-selection-guide" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Method Selection Guide</h1>
<p>Each method has its strengths and appropriate use cases:</p>
<section id="quantile-matching-1" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="quantile-matching-1"><span class="header-section-number">4.1</span> Quantile Matching</h2>
<ul>
<li><strong>Pros</strong>: Preserves rank order, works with any distribution</li>
<li><strong>Cons</strong>: May not extrapolate well</li>
<li><strong>Best for</strong>: General-purpose distribution matching</li>
</ul>
</section>
<section id="box-cox-transformation-1" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="box-cox-transformation-1"><span class="header-section-number">4.2</span> Box-Cox Transformation</h2>
<ul>
<li><strong>Pros</strong>: Works well for skewed data, preserves relationships</li>
<li><strong>Cons</strong>: Requires positive data, assumes underlying normality</li>
<li><strong>Best for</strong>: Right-skewed positive data</li>
</ul>
</section>
<section id="kernel-density-based" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="kernel-density-based"><span class="header-section-number">4.3</span> Kernel Density-Based</h2>
<ul>
<li><strong>Pros</strong>: Highly flexible, handles multimodal distributions</li>
<li><strong>Cons</strong>: Computationally intensive, sensitive to bandwidth selection</li>
<li><strong>Best for</strong>: Complex, multimodal distributions</li>
</ul>
</section>
<section id="moment-matching-1" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="moment-matching-1"><span class="header-section-number">4.4</span> Moment Matching</h2>
<ul>
<li><strong>Pros</strong>: Simple, fast, preserves linear relationships</li>
<li><strong>Cons</strong>: Only matches first two moments, assumes similar shapes</li>
<li><strong>Best for</strong>: Nearly normal distributions or quick approximations</li>
</ul>
</section>
</section>
<section id="performance-comparison" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Performance Comparison</h1>
<p>Letâ€™s compare the computational performance of these methods:</p>
<div class="cell" data-hash="index_cache/html/performance_127a6a95bd68cc1ff47ab3193ac9d115">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(microbenchmark)</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Benchmark the methods</span></span>
<span id="cb9-4">bench <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">microbenchmark</span>(</span>
<span id="cb9-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Quantile =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile_match</span>(A, B),</span>
<span id="cb9-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">BoxCox =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">boxcox_match</span>(A, B),</span>
<span id="cb9-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Kernel =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">kernel_density_match</span>(A, B),</span>
<span id="cb9-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Moment =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">moment_match</span>(A, B),</span>
<span id="cb9-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">times =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb9-10">)</span>
<span id="cb9-11"></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot results</span></span>
<span id="cb9-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">autoplot</span>(bench) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_minimal</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb9-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">title =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Performance Comparison"</span>,</span>
<span id="cb9-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">subtitle =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time taken by each method (lower is better)"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/distribution_matching/index_files/figure-html/performance-1.png" class="img-fluid" width="768"></p>
</div>
</div>
</section>
<section id="conclusion" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Conclusion</h1>
<p>While quantile matching is often the default choice for distribution matching, having multiple approaches in your toolkit allows you to handle various scenarios more effectively. The choice of method should depend on:</p>
<ol type="1">
<li>Your data characteristics</li>
<li>Computational resources</li>
<li>Preservation requirements</li>
<li>Desired properties of the transformed distribution</li>
</ol>
<p>Always validate your transformations through both visual inspection and numerical summaries to ensure the transformed distribution meets your requirements.</p>
</section>
<section id="references" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> References</h1>
<ul>
<li>Box, G. E. P., &amp; Cox, D. R. (1964). An analysis of transformations. Journal of the Royal Statistical Society: Series B (Methodological), 26(2), 211-243.</li>
<li>Silverman, B. W. (1986). Density estimation for statistics and data analysis. CRC press.</li>
<li>Bolstad, B. M., Irizarry, R. A., Ã…strand, M., &amp; Speed, T. P. (2003). A comparison of normalization methods for high density oligonucleotide array data based on variance and bias. Bioinformatics, 19(2), 185-193.</li>
</ul>


</section>

 ]]></description>
  <guid>https://www.jonghoonk.com/blog/posts/distribution_matching/index.html</guid>
  <pubDate>Wed, 30 Oct 2024 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Bayesian workflow: fake social contact data example</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/bayesian_workflow/index.html</link>
  <description><![CDATA[ 



<section id="bayesian-workflow" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-workflow">Bayesian workflow</h2>
<p>This post is my attempt to follow along a <a href="https://arxiv.org/abs/2011.01808">Bayesian Workflow</a> by Gelman <em>et al</em> and create examples for better understanding. While my ultimate goal is to study infectious disease transmission using a dynamic model following a Bayesian workflow, I use a simpler statistical model for practice in this post. I also consulted a <a href="https://betanalpha.github.io/assets/case_studies/principled_bayesian_workflow.html#31_Example_Workflow_Executions">blog post</a> by Michael Betancourt to create this post.</p>
<p>Regarding the definition of Bayesian workflow, <a href="https://arxiv.org/abs/2011.01808">Gelman <em>et al</em>.</a> writes:</p>
<blockquote class="blockquote">
<p>â€œâ€¦ Bayesian inference is just the formulation and computation of conditional probability or probability densities, <img src="https://latex.codecogs.com/png.latex?p(%5Ctheta%7Cy)%20%5Cpropto%20p(%5Ctheta)%20p(y%7C%5Ctheta)">. Bayesian workflow includes the three steps of model building, inference, and model checking/improvement, along with the comparison of different models, not just for the purpose of model choice or model averaging but more importantly to better understand these models â€¦â€</p>
</blockquote>
</section>
<section id="model-building" class="level2">
<h2 class="anchored" data-anchor-id="model-building">Model building</h2>
<section id="conceptual-analysis" class="level3">
<h3 class="anchored" data-anchor-id="conceptual-analysis">Conceptual analysis</h3>
<p>Letâ€™s suppose that we measured how the number of contact a person makes varies.<a href="https://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.0050074">A prior study</a> and other numerous studies showed that contact frequencies differ by age. And a significant fraction of contacts occur with household members and as such the contact frequencies will likely vary by household size. We sampled a group of people and followed them for some time (e.g., 1 week) and measured the number of contacts that a typical person makes in a day. We also collected variables such as age, sex, and household size.</p>
<p>There are three conceptual modelling approaches: descriptive, predictive and explanatory approaches as per <a href="https://www.stat.berkeley.edu/~aldous/157/Papers/shmueli.pdf">the study by Shmueli</a>. This study is best described as a descriptive study and does not directly aim at obtaining optimal predictive performance, but at capturing the data structure parsimoniously. For a descriptive model, interpretability, transportability and general usability are important criteria as described in the <a href="ttps://diagnprognres.biomedcentral.com/articles/10.1186/s41512-020-00074-3">article</a>.</p>
<p>Assuming that the number of contacts per day per person, <img src="https://latex.codecogs.com/png.latex?y_i">, follows a negative binomial distribution, we can mathematically express our concepts in the following equations:</p>
<p><span id="eq-nb"><img src="https://latex.codecogs.com/png.latex?%0Ay_i%20%5Csim%20%5Ctext%7BNB%7D(y_i%7C%5Cmu_i,%5Cphi)=%5Cfrac%7B%5CGamma%20(y_i%20+%20%5Ctheta)%7D%7B%5CGamma%20(%5Ctheta)%20y_i%20!%7D)%20%5Cleft(%5Cfrac%7B%5Cmu_i%7D%7B%5Cmu_i+%5Cphi%7D%20%5Cright)%5Ey%20%5Cleft(%5Cfrac%7B%5Cphi%7D%7B%5Cmu_i+%5Cphi%7D%20%5Cright)%5E%5Cphi%0A%5Ctag%7B1%7D"></span></p>
<p><span id="eq-mu"><img src="https://latex.codecogs.com/png.latex?%5Ctext%7Blog%7D(%5Cmu_i)=%20%5Calpha%20+%20%5Cbeta_%7B%5Ctext%7Bage%7D_i%7D%20%20+%20%5Cbeta_%7B%5Ctext%7Bsex%7D_i%7D%20+%5Cbeta_%7B%5Ctext%7Bhhsize%7D_i%7D%20%5Ctag%7B2%7D"></span></p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmu_i"> and <img src="https://latex.codecogs.com/png.latex?%5Cphi"> represent the mean number of contacts per day for a person <img src="https://latex.codecogs.com/png.latex?i"> and the shape parameter of the negative binomial distribution, respectively. <img src="https://latex.codecogs.com/png.latex?%5CGamma%20(%5Ccdot)"> denotes a <a href="https://en.wikipedia.org/wiki/Gamma_function">gamma function</a>.</p>
</section>
<section id="implemetation" class="level3">
<h3 class="anchored" data-anchor-id="implemetation">Implemetation</h3>
<p>Load packages</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># library(posterior)</span></span>
<span id="cb1-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># options(pillar.neg = FALSE, pillar.subtle=FALSE, pillar.sigfig=2)</span></span>
<span id="cb1-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(brms)</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># library(bayesplot)</span></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># theme_set(bayesplot::theme_default(base_family = "sans"))</span></span>
<span id="cb1-7">set1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> RColorBrewer<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brewer.pal</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Set1"</span>)</span></code></pre></div>
</div>
<p>Generate the fake data</p>
<p>We take the fake-data simulation approach, which can help us understand our data model and priors, what can be learned from an experiment, and the validity of the applied inference methods. Parameters of interest are the ratios of number of contacts per day (i.e., rate ratios or relative risks) by age, sex, and household size. Plugging Equation&nbsp;2 into Equation&nbsp;1 becomes our generative model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># parameter values to be estimated</span></span>
<span id="cb2-2">intercept_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># base number of contacts</span></span>
<span id="cb2-3">rr_age_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative number of contacts by age (age0 = 1)</span></span>
<span id="cb2-4">rr_hhsize_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.6</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative number of contacts by household size  (hhsize0 =1)  </span></span>
<span id="cb2-5">rr_sex_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># males have more frequent contacts, which is not modeled in model 1</span></span>
<span id="cb2-6">shape_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape parameter for the negative binomial distribution</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1220</span>)</span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 9 categories with &gt;100 observations on average</span></span>
<span id="cb2-10">d <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">age =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T),</span>
<span id="cb2-11">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">hhsize =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T), </span>
<span id="cb2-12">                <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sex =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sample</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">replace=</span>T))</span>
<span id="cb2-13">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb2-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb2-15">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, rr_age_true[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], rr_age_true[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative risk by age</span></span>
<span id="cb2-16">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_hhsize <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb2-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hhsize <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb2-18">         <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hhsize <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, rr_hhsize_true[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], rr_hhsize_true[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative risk by household size</span></span>
<span id="cb2-19">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_sex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sex <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, rr_sex_true) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># relative risk by sex</span></span>
<span id="cb2-20"></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># mean as a function of age and hhsize</span></span>
<span id="cb2-22">a <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> intercept_true </span>
<span id="cb2-23">log_mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(a) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_age) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_hhsize) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">log</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_sex)</span>
<span id="cb2-24">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(log_mu)</span>
<span id="cb2-25">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>age)</span>
<span id="cb2-26">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hhsize <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>hhsize)</span>
<span id="cb2-27">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sex <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.factor</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>sex)</span>
<span id="cb2-28">d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnbinom</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nrow</span>(d), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">mu=</span>d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>mu, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">size=</span>shape_true) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size, aka, shape, dispersion</span></span></code></pre></div>
</div>
<p>Histogram, mean, and variance of the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(tidyverse)</span>
<span id="cb3-2">d <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>contacts))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_histogram</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">binwidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of contacts per day per person"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6.252</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(d<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>contacts)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29.13964</code></pre>
</div>
</div>
<p>The number of contacts is count data and the variance-to-mean ratio is around 5. Thefore, the choice of negative binomial distribution looks reasonable.</p>
</section>
<section id="model-1-age-and-household-size" class="level3">
<h3 class="anchored" data-anchor-id="model-1-age-and-household-size">Model 1: age and household size</h3>
<p>For this model, we assume that the dependent variable is mostly influenced by age and household size and do not include sex variable in the model.</p>
<p>We use the <code>brms</code> package to implement the Bayesian regression model. We first set the priors for the intercept, <code>a_*</code>, the age and household size, <code>b_*</code>, and the shape parameter of the negative binomial distribution, <code>shp_*</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prior distributions</span></span>
<span id="cb8-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># intercept, modeled as normal</span></span>
<span id="cb8-3">a_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-4">a_scale <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exp(2*a_scale) will likely cover plausible values </span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># beta for the age and the household, modeled as normal</span></span>
<span id="cb8-6">b_mean <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-7">b_scale <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape parameter of the negbin distr, modeled as inverse gamma</span></span>
<span id="cb8-9">shp_alpha <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.4 (brms default) causes divergent transitions,</span></span>
<span id="cb8-10">shp_beta <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb8-11"></span>
<span id="cb8-12">my_priors <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_string</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal("</span>, a_mean, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, a_scale,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span>), </span>
<span id="cb8-14">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>),</span>
<span id="cb8-15">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_string</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal("</span>, b_mean, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, b_scale,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span>),</span>
<span id="cb8-16">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b"</span>),</span>
<span id="cb8-17">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prior_string</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">paste0</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"inv_gamma("</span>, shp_alpha, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">","</span>, shp_beta,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">")"</span>), </span>
<span id="cb8-18">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>))</span></code></pre></div>
</div>
</section>
<section id="prior-predictive-check" class="level3">
<h3 class="anchored" data-anchor-id="prior-predictive-check">Prior predictive check</h3>
<p>We use <code>sample_prior = "only"</code> argument to get the prior predictive distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">prior_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hhsize,</span>
<span id="cb9-2">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> d,</span>
<span id="cb9-3">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">negbinomial</span>(),</span>
<span id="cb9-4">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> my_priors,</span>
<span id="cb9-5">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">sample_prior =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"only"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(prior_pred, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior_pred.rds"</span>)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">prior_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior_pred.rds"</span>)</span>
<span id="cb10-2">priorpc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(prior_pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb10-3"></span>
<span id="cb10-4">priorpc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb10-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y_obs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_linerange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>h, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>l, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of contacts per day per person"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb10-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="fit-the-model" class="level3">
<h3 class="anchored" data-anchor-id="fit-the-model">Fit the model</h3>
<p><a href="https://arxiv.org/abs/2011.01808">Gelman <em>et al</em>.</a> writes:</p>
<blockquote class="blockquote">
<p>â€ â€¦ The first step in validating computation is to check that the model actually finishes the fitting process in an acceptable time frame and the convergence diagnostics are reasonable. In the context of HMC, this is primarily the absence of divergent transitions, <img src="https://latex.codecogs.com/png.latex?%5Chat%7BR%7D"> diagnostic near 1, and sufficient effective sample sizes for the central tendency, the tail quantiles, and the energy (Vehtari et al., 2020). â€¦â€</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hhsize, </span>
<span id="cb11-2">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> d, </span>
<span id="cb11-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">negbinomial</span>(),</span>
<span id="cb11-4">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> my_priors,</span>
<span id="cb11-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb11-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(fit1, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit1.rds"</span>)</span></code></pre></div>
</div>
<p><code>brms</code> package reports all the relevant information to check the fitting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit1.rds"</span>)</span>
<span id="cb12-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = log; shape = identity 
Formula: contacts ~ 1 + age + hhsize 
   Data: d (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup draws = 20000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.13      0.05     1.03     1.23 1.00    18152    14753
age2          0.48      0.05     0.38     0.57 1.00    22583    16259
age3         -0.47      0.05    -0.57    -0.37 1.00    21570    15970
hhsize2       0.71      0.05     0.60     0.81 1.00    19003    15277
hhsize3       0.96      0.05     0.85     1.06 1.00    18962    15515

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     4.47      0.36     3.81     5.22 1.00    25673    14986

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
</section>
<section id="posterior-predictive-values-along-with-prior-predictive-values" class="level3">
<h3 class="anchored" data-anchor-id="posterior-predictive-values-along-with-prior-predictive-values">Posterior predictive values along with prior predictive values</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">prior_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"prior_pred.rds"</span>)</span>
<span id="cb14-2">priorpc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(prior_pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb14-3">postpc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pp_check</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"bars"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ndraws =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb14-4"></span>
<span id="cb14-5">postpc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">|&gt;</span> </span>
<span id="cb14-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>x))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_col</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>y_obs, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fill=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>priorpc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_linerange</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>priorpc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>data,<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>h, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>l, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>m, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_linerange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span>h, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span>l, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_x_continuous</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">limits=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of contacts per day per person"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>],</span>
<span id="cb14-15">                               <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_fill_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Data"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb14-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend.position=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="inference" class="level2">
<h2 class="anchored" data-anchor-id="inference">Inference</h2>
<p>Prior and posterior distributions of parameters. Trace plots and histograms</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^b_"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot(fit, pars = ".*age*.")</span></span>
<span id="cb16-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot(fit, pars = ".*hhsize*.")</span></span></code></pre></div>
</div>
<p>Correlations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*age*."</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There is a positive correlation between <code>b_age2</code> and <code>b_age3</code>. It appears that increase in one parameter creates a deviation from the specified distribution (negative binomial distribution) and the other parameter also increases for all predicted values conform to the specified distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^b_age*.|^In*."</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>I also expected that the increase in those parameters (<code>b_age2</code> and <code>b_age3</code>) lead to the decrease in the <code>Intercept</code> to maintain the mean. This is, however, only clear when examining the association among <code>Intercept</code>, <code>b_hhsize2</code>, and <code>b_hhsize3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">".*hh*."</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pairs</span>(fit1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">pars =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"^b_hh*.|^In*."</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-13-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctext%7Bage%7D%7D"> parameter</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1">df_post <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(fit1)</span>
<span id="cb21-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb21-3">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>))</span>
<span id="cb21-4">df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>prior_density <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(df<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>x, b_mean, b_scale)</span>
<span id="cb21-5"></span>
<span id="cb21-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, b_mean, b_scale), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), </span>
<span id="cb21-7">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(beta[age]))</span>
<span id="cb21-8"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_age2)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb21-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_age3)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb21-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v=</span>rr_age_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)</span>
<span id="cb21-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>,</span>
<span id="cb21-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>,</span>
<span id="cb21-13">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb21-14">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>],set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb21-15">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age2"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"age3"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>),</span>
<span id="cb21-16">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot2 way</span></span>
<span id="cb22-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ggplot()+</span></span>
<span id="cb22-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   geom_line(data=df, aes(x=exp(x), y=prior_density, color="Prior"))+</span></span>
<span id="cb22-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   geom_density(data=df_post, aes(x=exp(b_age2), color="Posterior b_age2"))+</span></span>
<span id="cb22-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   geom_density(data=df_post, aes(x=exp(b_age3), color="Posterior b_age3"))+</span></span>
<span id="cb22-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   scale_color_manual(values=c("Prior"="forestgreen", </span></span>
<span id="cb22-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                               "Posterior b_age2"="firebrick",</span></span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#                               "Posterior b_age3"="steelblue"))+</span></span>
<span id="cb22-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   labs(color="", x="value", y="density")+</span></span>
<span id="cb22-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   theme(legend.position="bottom")</span></span></code></pre></div>
</div>
<p>True <img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctext%7Bage%7D%7D"> values were well retrieved.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbeta_%7B%5Ctext%7Bhhsize%7D%7D"> parameter</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, b_mean, b_scale), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), </span>
<span id="cb23-2">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">expression</span>(beta[hhsize]))</span>
<span id="cb23-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_hhsize2)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb23-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_hhsize3)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb23-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v=</span>rr_hhsize_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)</span>
<span id="cb23-6"></span>
<span id="cb23-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>,</span>
<span id="cb23-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>,</span>
<span id="cb23-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb23-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb23-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hhsize2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"hhsize3"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>),</span>
<span id="cb23-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Intercept</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb24-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(x), <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dnorm</span>(x, a_mean, a_scale), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>), </span>
<span id="cb24-3">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>)</span>
<span id="cb24-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>b_Intercept)), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb24-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v=</span>intercept_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)</span>
<span id="cb24-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>,</span>
<span id="cb24-7">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>,</span>
<span id="cb24-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb24-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb24-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>),</span>
<span id="cb24-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Shape parameter</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(extraDistr)</span>
<span id="cb25-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb25-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">dinvgamma</span>(x, shp_alpha, shp_beta), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, </span>
<span id="cb25-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Shape"</span>)</span>
<span id="cb25-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">density</span>(df_post<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>shape), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb25-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">v=</span>shape_true, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span>set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>)</span>
<span id="cb25-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>,</span>
<span id="cb25-8">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>,</span>
<span id="cb25-9">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),</span>
<span id="cb25-10">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],set1[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]),</span>
<span id="cb25-11">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prior"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Posterior"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>),</span>
<span id="cb25-12">       <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="model-checking-improvement-and-comparing-multiple-models" class="level2">
<h2 class="anchored" data-anchor-id="model-checking-improvement-and-comparing-multiple-models">Model checking, improvement, and comparing multiple models</h2>
<p>Gelman <em>et al</em>. writes:</p>
<blockquote class="blockquote">
<p>â€œâ€¦ The key aspect of Bayesian workflow, which takes it beyond Bayesian data analysis, is that we are fitting many models while working on a single problem. We are not talking here about model selection or model averaging but rather of the use of a series of fitted models to better understand each one. â€¦â€</p>
</blockquote>
<section id="model-evaluation" class="level3">
<h3 class="anchored" data-anchor-id="model-evaluation">Model evaluation</h3>
<p>We use leave-one-out (LOO) cross validation as suggested in <a href="https://link.springer.com/article/10.1007/s11222-016-9696-4">Vehtari <em>et al.</em></a> and <a href="https://link.springer.com/article/10.1007/s11222-013-9416-2">Gelman <em>et al.</em></a>.</p>
<p>We fit two additional models: <code>fit2</code> and <code>fit0</code>. <code>fit2</code> includes <code>sex</code> variable in addition to all variables included in <code>fit1</code> and could be better or worse than <code>fit1</code> as impact of sex is not big in the data set. <code>fit0</code> is intercept-only model and thus is very likely to be worse than <code>fit1</code> or <code>fit2</code>.</p>
</section>
<section id="model-2-include-sex-in-addition-to-age-and-household-size-as-covariates." class="level3">
<h3 class="anchored" data-anchor-id="model-2-include-sex-in-addition-to-age-and-household-size-as-covariates.">Model 2: Include sex in addition to age and household size as covariates.</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> age <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hhsize <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sex, </span>
<span id="cb26-2">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> d, </span>
<span id="cb26-3">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">negbinomial</span>(),</span>
<span id="cb26-4">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> my_priors,</span>
<span id="cb26-5">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb26-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(fit2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit2.rds"</span>)</span>
<span id="cb26-7"></span>
<span id="cb26-8">fit0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">brm</span>(contacts <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, </span>
<span id="cb26-9">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data =</span> d, </span>
<span id="cb26-10">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">family =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">negbinomial</span>(),</span>
<span id="cb26-11">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prior =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set_prior</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"normal(0,5)"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">class=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Intercept"</span>),</span>
<span id="cb26-12">           <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">iter =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cores =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb26-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">saveRDS</span>(fit0, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit0.rds"</span>)</span></code></pre></div>
</div>
<p>Summary of fit0 and fit2</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit2.rds"</span>) </span>
<span id="cb27-2">fit0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">readRDS</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"fit0.rds"</span>)</span>
<span id="cb27-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = log; shape = identity 
Formula: contacts ~ 1 + age + hhsize + sex 
   Data: d (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup draws = 20000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.05      0.05     0.94     1.16 1.00    21036    16258
age2          0.49      0.05     0.40     0.59 1.00    23875    16265
age3         -0.46      0.05    -0.57    -0.36 1.00    23032    15811
hhsize2       0.70      0.05     0.60     0.80 1.00    22731    15830
hhsize3       0.95      0.05     0.85     1.06 1.00    21280    16524
sex2          0.15      0.04     0.07     0.23 1.00    29050    14273

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     4.57      0.37     3.89     5.35 1.00    30332    14155

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit0)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = log; shape = identity 
Formula: contacts ~ 1 
   Data: d (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup draws = 20000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.83      0.03     1.78     1.88 1.00    16643    12592

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     1.92      0.11     1.71     2.15 1.00    15701    13170

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>
<p>Shape parameter estimates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1">probs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.975</span>)</span>
<span id="cb31-2">shp1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit1)[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span>probs)</span>
<span id="cb31-3">shp2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit2)[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span>probs)</span>
<span id="cb31-4">shp0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">quantile</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(fit0)[,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"shape"</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">probs=</span>probs)</span>
<span id="cb31-5"></span>
<span id="cb31-6">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model 0"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(shp0))</span>
<span id="cb31-7">df <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model 1"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(shp1)),</span>
<span id="cb31-8">            <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model 2"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(shp2)))</span>
<span id="cb31-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># df$percentile &lt;- rep(as.character(100*probs),3)</span></span>
<span id="cb31-10"></span>
<span id="cb31-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(df, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>Model))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_linerange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X2.5.</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X97.5.</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_linerange</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymin=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X25.</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ymax=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X75.</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_point</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>Model, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">X50.</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb31-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_light</span>() <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb31-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Inference for the shape parameter"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/bayesian_workflow/index_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Compare fit0, fit1 and fit2 models</p>
<p>Using WAIC</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit1, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"waic"</span>)</span>
<span id="cb32-2">fit0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit0, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"waic"</span>)</span>
<span id="cb32-3">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"waic"</span>)</span>
<span id="cb32-4"></span>
<span id="cb32-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">waic</span>(fit0)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

          Estimate   SE
elpd_waic  -2848.4 28.0
p_waic         2.1  0.2
waic        5696.7 56.0</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">waic</span>(fit1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

          Estimate   SE
elpd_waic  -2575.3 26.8
p_waic         5.8  0.4
waic        5150.5 53.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">waic</span>(fit2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

          Estimate   SE
elpd_waic  -2569.2 26.6
p_waic         6.6  0.4
waic        5138.4 53.1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(fit1, fit2, fit0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">criterion =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"waic"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     elpd_diff se_diff
fit2    0.0       0.0 
fit1   -6.1       3.6 
fit0 -279.2      19.9 </code></pre>
</div>
</div>
<p>Using leave-one-out (LOO) cross-validation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit1, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loo"</span>)</span>
<span id="cb40-2">fit0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit0, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loo"</span>)</span>
<span id="cb40-3">fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_criterion</span>(fit2, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loo"</span>)</span>
<span id="cb40-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(fit1, fit2, fit0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">criterion =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"loo"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     elpd_diff se_diff
fit2    0.0       0.0 
fit1   -6.1       3.6 
fit0 -279.2      19.9 </code></pre>
</div>
</div>
<p><code>brms::loo_compare</code> uses the <code>loo::loo_compare</code> under the hood and and <code>loo::loo_compare</code> package produces the same results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(loo)</span>
<span id="cb42-2">loo_fit0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit0)</span>
<span id="cb42-3">loo_fit1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit1)</span>
<span id="cb42-4">loo_fit2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo</span>(fit2)</span>
<span id="cb42-5"></span>
<span id="cb42-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(loo_fit0)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

         Estimate   SE
elpd_loo  -2848.4 28.0
p_loo         2.1  0.2
looic      5696.7 56.0
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k &lt; 0.5).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(loo_fit1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

         Estimate   SE
elpd_loo  -2575.3 26.8
p_loo         5.8  0.4
looic      5150.5 53.7
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k &lt; 0.5).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">print</span>(loo_fit2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Computed from 20000 by 1000 log-likelihood matrix

         Estimate   SE
elpd_loo  -2569.2 26.6
p_loo         6.6  0.4
looic      5138.4 53.1
------
Monte Carlo SE of elpd_loo is 0.0.

All Pareto k estimates are good (k &lt; 0.5).
See help('pareto-k-diagnostic') for details.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1">brms<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">loo_compare</span>(loo_fit1, loo_fit2, loo_fit0)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     elpd_diff se_diff
fit2    0.0       0.0 
fit1   -6.1       3.6 
fit0 -279.2      19.9 </code></pre>
</div>
</div>
<p>It appears that <code>fit2</code> is the most favored by LOO cross validation. This implies that adding <code>sex</code> variable still improves the model performance while its influence on the number of contacts relatively small compared to the <code>age</code> and <code>household size</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">summary</span>(fit2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: negbinomial 
  Links: mu = log; shape = identity 
Formula: contacts ~ 1 + age + hhsize + sex 
   Data: d (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 10000; warmup = 5000; thin = 1;
         total post-warmup draws = 20000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     1.05      0.05     0.94     1.16 1.00    21036    16258
age2          0.49      0.05     0.40     0.59 1.00    23875    16265
age3         -0.46      0.05    -0.57    -0.36 1.00    23032    15811
hhsize2       0.70      0.05     0.60     0.80 1.00    22731    15830
hhsize3       0.95      0.05     0.85     1.06 1.00    21280    16524
sex2          0.15      0.04     0.07     0.23 1.00    29050    14273

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
shape     4.57      0.37     3.89     5.35 1.00    30332    14155

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>


</section>
</section>

 ]]></description>
  <category>Bayesian workflow</category>
  <category>negative binomial</category>
  <category>social contact</category>
  <guid>https://www.jonghoonk.com/blog/posts/bayesian_workflow/index.html</guid>
  <pubDate>Sat, 20 Jul 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/bayesian_workflow/sample_figure.png" medium="image" type="image/png"/>
</item>
<item>
  <title>Modeling human behavior: Infectious disease transmission modeling perspective</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/behavior_change/index.html</link>
  <description><![CDATA[ 



<section id="epidemiology" class="level2">
<h2 class="anchored" data-anchor-id="epidemiology">Epidemiology</h2>
<p>ê°ì—¼ë³‘ì˜ ì „íŒŒ ì–‘ìƒì„ ì—°êµ¬í•˜ëŠ” ê°ì—¼ë³‘ ì—­í•™ (Epidemiology of Infectious Diseases ; EID)ì—ì„œëŠ” ê°ì—¼ë³‘ì˜ ë°œìƒ ì–‘ìƒ¹ì„ ì„¸ ê°€ì§€ ìš”ì†Œë¡œ í•´ì„í•˜ê³ ìž í•œë‹¤. í•˜ë‚˜ëŠ” ë³‘ì„ ì¼ìœ¼í‚¤ëŠ” ê°ì—¼ì› (infectious agent)ì´ê³ , ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ì‚¬ëžŒì´ ì‚´ì•„ê°€ê³  ìžˆëŠ” ì£¼ë³€ í™˜ê²½ (environment)ì´ë©° ë§ˆì§€ë§‰ì€ ê°ì—¼ë˜ëŠ” ëŒ€ìƒ, ì¦‰ ìˆ™ì£¼ (host) ì´ë‹¤[<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2465549/">Barreto <em>et al</em>.</a>].</p>
<p>Sebastian Funk <em>et al</em>. ì˜ ë…¼ë¬¸ <a href="https://royalsocietypublishing.org/doi/full/10.1098/rsif.2010.0142">Modelling the influence of human behaviour on the spread of infectious diseases: a review</a>ì€ ì„ ì‚´íŽ´ë³´ê³ ìž í•œë‹¤.</p>
<blockquote class="blockquote">
<p>â€œâ€¦ After all, individual self-initiated behaviour can change the fate of an outbreak, and its interaction with disease dynamics requires proper understanding if we are to fully comprehend what happens when a disease spreads through human populations Ferguson <em>et al</em>. <a href="https://www.nature.com/articles/446733a">Capturing human behaviour</a>. â€¦â€</p>
</blockquote>


</section>

 ]]></description>
  <category>Bayesian workflow</category>
  <category>negative binomial</category>
  <category>social contact</category>
  <guid>https://www.jonghoonk.com/blog/posts/behavior_change/index.html</guid>
  <pubDate>Sat, 20 Jul 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/behavior_change/sample_figure.png" medium="image" type="image/png"/>
</item>
<item>
  <title>Kalman filter to estimate R using the FKF package</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/kalman_filter/index.html</link>
  <description><![CDATA[ 



<p><a href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0244474">Arroyo-Marioli et al</a> used a Kalman filter approach to estimate. I tried to reproduce in R. Letâ€™s use a SIR model as was used in my <a href="https://www.jonghoonk.com/posts/sir_deSolve_odin_diffeqr/">previous post</a> to generate growth rate time series.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(diffeqr)</span>
<span id="cb1-2">de <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> diffeqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diffeq_setup</span>()</span>
<span id="cb1-3"></span>
<span id="cb1-4">sir_julia <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(u, p, t){</span>
<span id="cb1-5">  N <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>(u)</span>
<span id="cb1-6">  R <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># R varies </span></span>
<span id="cb1-7">  p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-8">  </span>
<span id="cb1-9">  du1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N</span>
<span id="cb1-10">  du2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>N <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-11">  du3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>u[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-12">  </span>
<span id="cb1-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(du1,du2,du3))</span>
<span id="cb1-14">}</span>
<span id="cb1-15"></span>
<span id="cb1-16">u0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb1-17">tspan <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">50.0</span>)</span>
<span id="cb1-18">p <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span>
<span id="cb1-19">prob <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ODEProblem</span>(sir_julia, u0, tspan, p)</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prob_jit &lt;- diffeqr::jitoptimize_ode(de, prob)</span></span>
<span id="cb1-22">sol <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">solve</span>(prob, de<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Tsit5</span>(), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">saveat=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-23"></span>
<span id="cb1-24">mat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sapply</span>(sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>u, identity)</span>
<span id="cb1-25">udf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">t</span>(mat))</span>
<span id="cb1-26">tudf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">t=</span>sol<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>t), udf)</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(ggplot2)</span>
<span id="cb1-29"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(tudf, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span>t)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-30">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-31">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-32">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span>V3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span>)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-33">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, </span>
<span id="cb1-34">                     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"S"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"I"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,</span>
<span id="cb1-35">                              <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"darkgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-36">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">labs</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Number of individuals"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/kalman_filter/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Generate daily incidence assuming 100,000 population</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">I <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100000</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (tudf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>V3 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># true number of infected people at time t</span></span>
<span id="cb2-2">case_daily <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rpois</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(I)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lambda=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">diff</span>(I)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># observed number of infected people at t</span></span></code></pre></div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?I_t%20=%20(1-%5Cgamma)%20I_%7Bt-1%7D%20+%20%5Ctext%7Bnew%20cases%20at%20%7Dt"> <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7BI_t-I_%7Bt-1%7D%7D%7BI_%7Bt-1%7D%7D%5Cequiv%20r_t%20=%20%5Cgamma(R_t-1)%20+%20%5Cepsilon_i"> <img src="https://latex.codecogs.com/png.latex?R_t%20=%20R_%7Bt-1%7D%20+%20%5Ceta_i"></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">gamma <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recovery rate, which is the same as p[2] in the ODE model</span></span>
<span id="cb3-2">I_hat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rep</span>(<span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NA</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(case_daily)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># true number of infected people at time t</span></span>
<span id="cb3-3">I_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> I[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># cheating, it's okay as this is the simulation check </span></span>
<span id="cb3-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (i <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(I_hat)) {</span>
<span id="cb3-5">  I_hat[i] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gamma)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>I_hat[i<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> case_daily[i<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>]</span>
<span id="cb3-6">}</span>
<span id="cb3-7"></span>
<span id="cb3-8">It <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> I_hat <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># observed number of infected people at t</span></span>
<span id="cb3-9">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(It)</span>
<span id="cb3-10">gr <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (It[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>n] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> It[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(n<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> It[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(n<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">-1</span>)] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># observed growth rate</span></span>
<span id="cb3-11">t <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb3-12">R_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(t <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>))</span>
<span id="cb3-13">gr_true <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (R_true <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-14">R_hat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gr <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> gamma <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-15"></span>
<span id="cb3-16"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(R_hat, R_true[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(R_hat)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylim=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>), </span>
<span id="cb3-17">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R_hat"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"R_true"</span>)</span>
<span id="cb3-18"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/kalman_filter/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Inferring R based on the Kalman filter</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(FKF)</span>
<span id="cb4-2">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> gr</span>
<span id="cb4-3">a0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-4">P0 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-5"></span>
<span id="cb4-6">dt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb4-7">ct <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> gamma)  </span>
<span id="cb4-8">Zt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(gamma)</span>
<span id="cb4-9">Tt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-10"></span>
<span id="cb4-11">fit.fkf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">HHt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,</span>
<span id="cb4-12">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">GGt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">var</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">na.rm =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> .<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb4-13">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">fn =</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(par, ...)</span>
<span id="cb4-14">                 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fkf</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">HHt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(par[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">GGt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(par[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]), ...)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>logLik,</span>
<span id="cb4-15">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(y), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a0 =</span> a0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">P0 =</span> P0, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">dt =</span> dt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ct =</span> ct,</span>
<span id="cb4-16">                 <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Zt =</span> Zt, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">Tt =</span> Tt)</span>
<span id="cb4-17"></span>
<span id="cb4-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># recover values</span></span>
<span id="cb4-19">HHt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(fit.fkf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb4-20">GGt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(fit.fkf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>par[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb4-21">HHt; GGt</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01137336</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.187671e-05</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">y_kf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fkf</span>(a0, P0, dt, ct, Tt, Zt,</span>
<span id="cb7-2">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">HHt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(HHt), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">GGt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matrix</span>(HHt),</span>
<span id="cb7-3">             <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">yt =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rbind</span>(y)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Kalman filtering</span></span>
<span id="cb7-4"></span>
<span id="cb7-5">y_ks <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fks</span>(y_kf) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Kalman smoothing</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">data.frame</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">from =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">to =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb8-2">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> R_true,</span>
<span id="cb8-3">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_hat =</span> R_hat,</span>
<span id="cb8-4">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_kf =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_kf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>att),</span>
<span id="cb8-5">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_ks =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_ks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ahatt),</span>
<span id="cb8-6">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_ks_ub =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_ks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ahatt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(y_ks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Vt)),</span>
<span id="cb8-7">                   <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y_ks_lb =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_ks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>ahatt) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.96</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sqrt</span>(y_ks<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>Vt)))</span>
<span id="cb8-8"></span>
<span id="cb8-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggplot</span>(data, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x =</span> x)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_hat)) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-11">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_kf, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman filter"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-12">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_ks, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman smooth"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-13">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_ks_ub, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman smooth"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Upper bound"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-14">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y_ks_lb, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman smooth"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linetype=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lower bound"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-15">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">geom_line</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">aes</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">y =</span> y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">color =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">linewidth=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-16">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">xlab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"day"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ylab</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reproduction number"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-17">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ggtitle</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Reproduction number inferred with Kalman Filter"</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-18">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">theme_bw</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-19">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_color_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman filter"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"steelblue"</span>,</span>
<span id="cb8-20">                                  <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Kalman smooth"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"forestgreen"</span>))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb8-21">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">scale_linetype_manual</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">values=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Upper bound"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>,</span>
<span id="cb8-22">                                     <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Lower bound"</span><span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dotted"</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/kalman_filter/index_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>



 ]]></description>
  <category>kalman filter</category>
  <guid>https://www.jonghoonk.com/blog/posts/kalman_filter/index.html</guid>
  <pubDate>Wed, 10 Jul 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/kalman_filter/kalman_filter.png" medium="image" type="image/png" height="135" width="144"/>
</item>
<item>
  <title>Learning ChatGPT 4: Universal Approximation Theorem</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index.html</link>
  <description><![CDATA[ 



<p>Neural networks can approximate any function according to the <a href="https://en.wikipedia.org/wiki/Universal_approximation_theorem">Universal Approximation Theorem</a>. A more precise statement of the theorem is that neural networks with a single hidden layer can be used to approximate any continuous function to any desired precision by the <a href="http://neuralnetworksanddeeplearning.com/chap4.html">e-book</a> by Michael Nielsen. This e-book provides intuitive explanations about the proof. In what follows, I wrote what I was able to understand based on those materials and added a few R code chunks to supplement.</p>
<p>For a simple network with one hidden layer of two neurons, n1 and n2, what is being computed in a hidden neuron is <img src="https://latex.codecogs.com/png.latex?%5Csigma(w%20x%20+%20b)">, where <img src="https://latex.codecogs.com/png.latex?%5Csigma%20(z)%20%5Cequiv%201/(1+e%5E%7B-z%7D)"> is the sigmoid function. And what happens in the output neuron is <img src="https://latex.codecogs.com/png.latex?w_%7B31%7D%20n1%20+%20w_%7B32%7D%20n2%20+%20b">. Here, <img src="https://latex.codecogs.com/png.latex?w_%7B31%7D%20%5Ctext%7Band%7D%20w_%7B32%7D"> refer to weights that correspond to two neurons, n1 and n2, respectively.</p>
<p>The basic idea of the theorem is that weighted sum of outputs of neurons can approximate any functions. This can be visualized by studying a special case in which output from each neuron is close to a step function and weighted sum of a pair of step functions can create a bump of any height and width. With numerous those bumps, one can approximate any continuous function at any desired precision.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(igraph)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">graph_from_literal</span>(Input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--+</span>n1, Input<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--+</span>n2, n1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--+</span>Output, n2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">--+</span>Output))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In what follows, I will explain how a neural network can create a bump. Before that, letâ€™s get familiar with what is being computed in a single neuron. In the following codes, some combination of weight, <img src="https://latex.codecogs.com/png.latex?w"> , and bias, <img src="https://latex.codecogs.com/png.latex?b">, generate a typical sigmoid function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb2-2">w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb2-3">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb2-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n1"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>With high values for <img src="https://latex.codecogs.com/png.latex?w">, the output becomes close to a step function and the change point occurs at <img src="https://latex.codecogs.com/png.latex?-b/w">. For instance, letâ€™s look at the plot for <img src="https://latex.codecogs.com/png.latex?w=1000,%20b=-300">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb3-2">w <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span></span>
<span id="cb3-3">b <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb3-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n1"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>One can use the following codes to have a feel for how the weight and bias change the value in the neuron.</p>
<div class="sourceCode" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(manipulate)</span>
<span id="cb4-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">manipulate</span>(</span>
<span id="cb4-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b))), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Input"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n1"</span>),</span>
<span id="cb4-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slider</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initial =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>), </span>
<span id="cb4-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slider</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initial =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span></code></pre></div>
<p>Now letâ€™s create another step function in which the change point occurs at 0.4</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb5-2">w1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb5-3">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span></span>
<span id="cb5-4">y1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(w1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b1)))</span>
<span id="cb5-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y1, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>)</span>
<span id="cb5-6"></span>
<span id="cb5-7">w2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb5-8">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span></span>
<span id="cb5-9">y2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">exp</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(w2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b2)))</span>
<span id="cb5-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, y2, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What happens in the Output node is <img src="https://latex.codecogs.com/png.latex?%5Comega_%7B31%7D%20n1%20+%20%5Comega_%7B32%7D%20n2%20+%20b">. By setting <img src="https://latex.codecogs.com/png.latex?w1"> and <img src="https://latex.codecogs.com/png.latex?w2"> at different sign, we can create a bump.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">w31 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>        </span>
<span id="cb6-2">w32 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>       </span>
<span id="cb6-3">b3 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb6-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w32 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w31 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, one may use the following codes to have a feel for how two weights and the bias change the output in the Output.</p>
<div class="sourceCode" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">manipulate</span>(</span>
<span id="cb7-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w32 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w31 <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Output"</span>),</span>
<span id="cb7-3">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w31 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slider</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initial =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), </span>
<span id="cb7-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">w32 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slider</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initial =</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>),</span>
<span id="cb7-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b3 =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">slider</span>(<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">initial =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>))</span></code></pre></div>



 ]]></description>
  <category>Universal Approximation Theorem</category>
  <category>Neural network</category>
  <category>Arbitrary-Width</category>
  <category>Arbitrary-Depth</category>
  <guid>https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/index.html</guid>
  <pubDate>Sun, 23 Jun 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/Learning_ChatGPT_4_UniversalApproximationTheorem/UAT.png" medium="image" type="image/png" height="55" width="144"/>
</item>
<item>
  <title>Parallel simulation in R</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/parallel/index.html</link>
  <description><![CDATA[ 



<p>I find that <code>parallel</code>, <code>doParallel</code> and <code>foreach</code> packages provide the easiest approach for parallel computing in R. The <code>doParallel</code> <a href="https://cran.r-project.org/web/packages/doParallel/vignettes/gettingstartedParallel.pdf">vignette</a> provides a great overview. <code>library(doParallel)</code> command automatically loads required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(doParallel)</span>
<span id="cb1-2">ncores <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span>  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">detectCores</span>()</span>
<span id="cb1-3">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb1-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb1-5">nruns <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> ncores</span>
<span id="cb1-6"></span>
<span id="cb1-7">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-8">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.combine=</span>c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(i, x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) }</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span>
<span id="cb1-11">res</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1 4 2 4 3 4 4 4</code></pre>
</div>
</div>
<p>We can export packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb3-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb3-3"></span>
<span id="cb3-4">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.packages=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.table"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> {</span>
<span id="cb3-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollmean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb3-7">  }</span>
<span id="cb3-8"></span>
<span id="cb3-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span>
<span id="cb3-10">res</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         result.1   result.2   result.3  result.4     result.5
 [1,]          NA         NA         NA        NA           NA
 [2,]          NA         NA         NA        NA           NA
 [3,]          NA         NA         NA        NA           NA
 [4,]          NA         NA         NA        NA           NA
 [5,]          NA         NA         NA        NA           NA
 [6,]          NA         NA         NA        NA           NA
 [7,]  0.10610803 -0.2996241 0.03278228 0.4701361 -0.004181703
 [8,]  0.05807023 -0.3114088 0.20836936 0.3251219  0.400871629
 [9,]  0.14870568 -0.3538062 0.35330620 0.3301056  0.293785357
[10,] -0.01413357 -0.4768548 0.19839694 0.2946405 -0.029407561</code></pre>
</div>
</div>
<p>We may want to set the same seed for each worker.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb5-3"></span>
<span id="cb5-4">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> </span>
<span id="cb5-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.packages=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data.table"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">.combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> {</span>
<span id="cb5-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb5-7">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">frollmean</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb5-8">}</span>
<span id="cb5-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span>
<span id="cb5-10">res</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        result.1   result.2   result.3   result.4   result.5
 [1,]         NA         NA         NA         NA         NA
 [2,]         NA         NA         NA         NA         NA
 [3,]         NA         NA         NA         NA         NA
 [4,]         NA         NA         NA         NA         NA
 [5,]         NA         NA         NA         NA         NA
 [6,]         NA         NA         NA         NA         NA
 [7,] -0.6236335 -0.6236335 -0.6236335 -0.6236335 -0.6236335
 [8,] -0.5018746 -0.5018746 -0.5018746 -0.5018746 -0.5018746
 [9,] -0.7423937 -0.7423937 -0.7423937 -0.7423937 -0.7423937
[10,] -0.5445709 -0.5445709 -0.5445709 -0.5445709 -0.5445709</code></pre>
</div>
</div>
<p>Different <code>foreach</code> sessions with the same random seed are not reproducible.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb7-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb7-3"></span>
<span id="cb7-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb7-5">a1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb7-6">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb7-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb7-8">a2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb7-9">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dopar%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb7-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identical</span>(a1, a2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identical</span>(b1, b2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span></code></pre></div>
</div>
<p>Reproducibility across different <code>foreach</code> sessions are possible using <a href="https://ftp.heanet.ie/mirrors/cran.r-project.org/web/packages/doRNG/index.html">doRNG</a> package. Examples below were adapted from the <a href="https://stackoverflow.com/questions/8358098/how-to-set-seed-for-random-simulations-with-foreach-and-domc-packages">stackoverflow post</a>.</p>
<p>You use <code>%dorng%</code> instead of <code>%dopar%</code> in the <code>doRNG</code> approach</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(doRNG)</span>
<span id="cb10-2"></span>
<span id="cb10-3">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb10-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb10-5"></span>
<span id="cb10-6"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb10-7">a1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dorng%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb10-8">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dorng%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb10-9"></span>
<span id="cb10-10"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">set.seed</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb10-11">a2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dorng%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb10-12">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">foreach</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">i=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">combine=</span>cbind) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%dorng%</span> { <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">rnorm</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>) }</span>
<span id="cb10-13"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identical</span>(a1, a2) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&amp;&amp;</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">identical</span>(b1, b2)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span></code></pre></div>
</div>
<p>We may want to examine parallel workers.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">cl <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">makeCluster</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getOption</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cl.cores"</span>, ncores<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">registerDoParallel</span>(cl)</span>
<span id="cb13-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getDoParWorkers</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 10</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getDoParName</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "doParallelSNOW"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">getDoParVersion</span>()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "1.0.17"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stopCluster</span>(cl)</span></code></pre></div>
</div>



 ]]></description>
  <category>parallelism</category>
  <category>foreach</category>
  <category>doParallel</category>
  <guid>https://www.jonghoonk.com/blog/posts/parallel/index.html</guid>
  <pubDate>Thu, 13 Jun 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/parallel/right_trunc2.png" medium="image" type="image/png" height="114" width="144"/>
</item>
<item>
  <title>Basic reproduction number: An algorithmic approach</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/R0_mathematica/index.html</link>
  <description><![CDATA[ 



<p>A <a href="https://www.mdpi.com/2227-7390/12/1/27">recent article</a> published in Mathematics discusses an approach to calculating <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0">. Since I have previously written a <a href="https://www.jonghoonk.com/posts/R0-sympy/">post</a> about calculating <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0"> using Sympy, I wanted to explore a new approach proposed by the article.</p>
<p>The article claims that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0"> is a not function of the original set of ordinary differential equations (ODEs) because <img src="https://latex.codecogs.com/png.latex?(F,%20V)"> gradient decomposition may not be unique for a given set of ODEs. As a reminder, <a href="https://link.springer.com/article/10.1007/BF00178324">Diekmann <em>et al.</em></a> showed that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0"> is the spectral radius, or Perronâ€“Frobenius eigenvalue, of the next generation operator.</p>
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cmathrm%7Bd%7DS/%5Cmathrm%7Bd%7Dt%20&amp;=%20-%5Cbeta%20I%20S/N%20%5C%5C%0A%5Cmathrm%7Bd%7DI/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cbeta%20I%20S/N%20-%20%5Cgamma%20I%5C%5C%0A%5Cmathrm%7Bd%7DR/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cgamma%20I%0A%5Cend%7Balign%7D">
<p>Following Python and Mathematica codes generate that <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0%20=%20%5Cfrac%7B%5Cbeta%7D%7B%5Cgamma%7D."> if <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> and <img src="https://latex.codecogs.com/png.latex?%5Cgamma"> are replaced with <img src="https://latex.codecogs.com/png.latex?b"> and <img src="https://latex.codecogs.com/png.latex?g">, respectively.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sympy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-2">b, k, g, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b k g'</span>)</span>
<span id="cb1-3">F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Matrix([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, b],[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])</span>
<span id="cb1-4">V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Matrix([[k, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>k, g]])</span>
<span id="cb1-5">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(V<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-6">eigval <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.eigenvals(simplify<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true)</span>
<span id="cb1-7">init_printing(use_unicode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-8">lst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(eigval.keys())</span>
<span id="cb1-9">lst[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>b
â”€
g</code></pre>
</div>
</div>
<p>Mathematica uses the following next generation method (NGM) function provided in the article.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">NGM[mod_, inf_] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">=</span> </span>
<span id="cb3-2"> Module[{dyn, X, infc, M, V, F, F1, V1, K}, dyn <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]; </span>
<span id="cb3-3">  X <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> mod[[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]]; infc <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Complement[Range[Length[X]], inf]; </span>
<span id="cb3-4">  M <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Grad[dyn[[inf]], X[[inf]]]</span>
<span id="cb3-5">  (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>The jacobian of the infectious equations<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>); </span>
<span id="cb3-6">  V1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>. Thread[X[[infc]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-7">  (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>V1 is a first guess <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> V,</span>
<span id="cb3-8">  retains all gradient terms which disappear when the non infectious <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-9">components are null<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>); F1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> M <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> V1</span>
<span id="cb3-10">  (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>F1 is a first guess <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> F,containing all other gradient terms<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>); </span>
<span id="cb3-11">  F <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> Replace[F1, _. _?Negative <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>}];</span>
<span id="cb3-12">  (<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>all terms <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> F1 containing minuses are set to <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>); V <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> F <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> M;</span>
<span id="cb3-13">  K <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> (F . Inverse[V]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>. Thread[X[[inf]] <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> FullSimplify;</span>
<span id="cb3-14">  {M, V1, F1, F, V, K}]</span>
<span id="cb3-15"></span>
<span id="cb3-16">eqnsSEIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb3-17">  <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>b s i ,</span>
<span id="cb3-18">  b s i <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> k e,</span>
<span id="cb3-19">  k e <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> g i, </span>
<span id="cb3-20">  g i }</span>
<span id="cb3-21"></span>
<span id="cb3-22">varsSEIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {s, e, i, r}</span>
<span id="cb3-23">modSEIR <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {eqnsSEIR, varsSEIR}</span>
<span id="cb3-24">NGM[modSEIR, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>}] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>. s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">-&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span></code></pre></div>
</div>
<p>As in the <a href="https://www.jonghoonk.com/posts/R0-sympy/">previous post</a>, I applied the method to the model used in <a href="https://journals.plos.org/plosntds/article?id=10.1371/journal.pntd.0002642">Pitzer <em>et al</em>.</a>, of which the model may be expressed in the following set of equations.</p>
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cmathrm%7Bd%7DS_1/%5Cmathrm%7Bd%7Dt%20&amp;=%20B%20+%20%5Cepsilon%20S_2%20-%20(%5Clambda_p+%5Clambda_w+%5Cmu)S_1%5C%5C%0A%5Cmathrm%7Bd%7DI_1/%5Cmathrm%7Bd%7Dt%20&amp;=%20(%5Clambda_p+%5Clambda_w)S_1%20-%20(%5Cdelta+%5Cmu)%20I_1%20%5C%5C%0A%5Cmathrm%7Bd%7DR/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cdelta(1-%5Ctheta-%5Calpha)(I_1+I_2)%20-%20(%5Comega%20+%5Cmu)R%20%5C%5C%0A%5Cmathrm%7Bd%7DC/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cdelta%5Ctheta(I_1+I_2)%20-%20%5Cmu%20C%20%5C%5C%0A%5Cmathrm%7Bd%7DS_2/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Comega%20R%20-%5Cepsilon%20S_2%20-%20(%5Clambda_p+%5Clambda_w+%5Cmu)%20S_2%5C%5C%0A%5Cmathrm%7Bd%7DI_2/%5Cmathrm%7Bd%7Dt%20&amp;=%20(%5Clambda_p+%5Clambda_w)%20S_2%20-%20(%5Cdelta+%5Cmu)%20I_2%20%5C%5C%0A%5Cmathrm%7Bd%7DW/%5Cmathrm%7Bd%7Dt%20&amp;=%20%5Cgamma(I_1+rI_2+rC)%20-%20%5Cxi%20W%0A%5Cend%7Balign%7D">
<p>Following Python and Mathematica codes generates that</p>
<img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cmathcal%7BR%7D_0%20=%20%5Cfrac%7B1%7D%7B%5Cmu+%5Cdelta%7D%20%5Cleft(%5Cbeta_p%20+%5Cfrac%7B%5Cgamma%20%5Cbeta_w%7D%7B%5Cxi%7D%5Cright)%20%5Cleft(1%20+%5Cfrac%7B%5Cdelta%5Ctheta%20r%7D%7B%5Cmu%7D%5Cright)%0A%5Cend%7Balign%7D">
<p>In the following Python codes <img src="https://latex.codecogs.com/png.latex?p,%20r,%20w,%20d,%20m,%20t,%20g,%20x"> represent <img src="https://latex.codecogs.com/png.latex?%5Cbeta_p,%20r,%20%5Cbeta_w,%20%5Cdelta,%20%5Cmu,%20%5Ctheta,%20%5Cgamma,%20%5Cxi"> in the equation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">p, r, w, d, m, t, g, x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> symbols(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'p r w d m t g x'</span>)</span>
<span id="cb4-2">F <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Matrix([[p, r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p, r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>p, w], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])</span>
<span id="cb4-3">V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Matrix([[d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>m, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>m, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t, m, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>g, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>g, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>g, x]])</span>
<span id="cb4-4">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(V<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-5">eigval <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.eigenvals(simplify<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>true)</span>
<span id="cb4-6">init_printing(use_unicode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb4-7">eigval </span>
<span id="cb4-8">lst <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(eigval.keys())</span>
<span id="cb4-9">R0_eig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lst[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-10">R0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>m))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>g<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>w<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>x)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>r)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>m) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># R0 from the Pitzer (2014)</span></span>
<span id="cb4-11">simplify(R0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>R0_eig) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0 for the same expression (symbolic assessment)</span></span>
<span id="cb4-12">R0.equals(R0_eig) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True for the same expression (numerical assessment)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">eqnsSIRW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb5-2">  B <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Epsilon] Subscript[s, </span>
<span id="cb5-3">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (Subscript[\[Beta], </span>
<span id="cb5-4">       P] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-5">      Subscript[\[Beta], W] w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu]) Subscript[s, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-6">  \[Omega] R <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> \[Epsilon] Subscript[s, </span>
<span id="cb5-7">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (Subscript[\[Beta], </span>
<span id="cb5-8">       P] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> </span>
<span id="cb5-9">      Subscript[\[Beta], W]  w <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu]) Subscript[s, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-10">  (Subscript[\[Beta], P] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-11">       Subscript[\[Beta], W]  w) Subscript[s, </span>
<span id="cb5-12">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] \[Minus] (\[Delta] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu]) Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb5-13">  (Subscript[\[Beta], P] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb5-14">       Subscript[\[Beta], W]  w) Subscript[s, </span>
<span id="cb5-15">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (\[Delta] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu]) Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb5-16">  \[Delta] \[Theta] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> \[Mu] c,</span>
<span id="cb5-17">  \[Gamma] (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> r c) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> \[Xi] w,</span>
<span id="cb5-18">  \[Delta] (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> \[Theta]) (Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Subscript[i, </span>
<span id="cb5-19">      <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (\[Omega] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu]) R}</span>
<span id="cb5-20"></span>
<span id="cb5-21">varsSIRW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {Subscript[s, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], Subscript[s, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb5-22">  Subscript[i, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], c, w, R }</span>
<span id="cb5-23">  </span>
<span id="cb5-24">modSIRW <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {eqnsSIRW, varsSIRW}</span>
<span id="cb5-25">NGM[modSIRW, Range[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span></code></pre></div>
</div>
<p>Again, manually defining <img src="https://latex.codecogs.com/png.latex?F,V"> as follows leads to the same answer</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">F <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {{Subscript[\[Beta], P], r Subscript[\[Beta], P], </span>
<span id="cb6-2">   r Subscript[\[Beta], P], Subscript[\[Beta], W] }, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb6-3">    <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}}</span>
<span id="cb6-4">V <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> {{\[Delta] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}, {<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, \[Delta] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> \[Mu], <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, </span>
<span id="cb6-5">   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}, {<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>\[Delta] \[Theta], <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>\[Delta] \[Theta], \[Mu], </span>
<span id="cb6-6">   <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>}, {<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>\[Gamma], <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r \[Gamma], <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>r \[Gamma], \[Xi]}}</span>
<span id="cb6-7">Eigenvalues[Dot[F, Inverse[V]]] <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">/</span> FullSimplify</span></code></pre></div>
</div>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BR%7D_0%20=%20%5Cfrac%7B(%5Cmu%20+%5Cdelta%20%20%5Ctheta%20%20r)%20%5Cleft(%5Cxi%20%20%5Cbeta_P+%5Cgamma%20%20%5Cbeta_W%20%5Cright)%7D%7B%5Cmu%20%20%5Cxi%20%20(%5Cdelta%20+%5Cmu%20)%7D."></p>



 ]]></description>
  <category>Basic reproduction number</category>
  <category>Mathematica</category>
  <category>algorithmic approach</category>
  <category>next generation matrix</category>
  <guid>https://www.jonghoonk.com/blog/posts/R0_mathematica/index.html</guid>
  <pubDate>Sat, 01 Jun 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/R0_mathematica/intro-spikey.png" medium="image" type="image/png" height="147" width="144"/>
</item>
<item>
  <title>Claude 3</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/claude_api/index.html</link>
  <description><![CDATA[ 



<p>Testing Claude 3 with R</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(httr)</span>
<span id="cb1-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(jsonlite)</span>
<span id="cb1-3"></span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to make API request</span></span>
<span id="cb1-5">prompt_claude <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">function</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prompt =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb1-6">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">api_key =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">NULL</span>, </span>
<span id="cb1-7">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"opus"</span>,</span>
<span id="cb1-8">                          <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_tokens =</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) {</span>
<span id="cb1-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">is.null</span>(api_key)) {</span>
<span id="cb1-10">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"api_key must provided"</span>)</span>
<span id="cb1-11">  }</span>
<span id="cb1-12">  model <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">grep</span>(model, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude-3-haiku-20240307"</span>,</span>
<span id="cb1-13">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude-3-sonnet-20240229"</span>,</span>
<span id="cb1-14">                         <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"claude-3-opus-20240229"</span>), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">value=</span><span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-15">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">length</span>(model) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>){</span>
<span id="cb1-16">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">stop</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The model name is wrong. It must be one of the haiku, sonnet, and opus"</span>)</span>
<span id="cb1-17">  }</span>
<span id="cb1-18">  </span>
<span id="cb1-19">  response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> httr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">POST</span>(</span>
<span id="cb1-20">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">url =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"https://api.anthropic.com/v1/messages"</span>,</span>
<span id="cb1-21">    httr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add_headers</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">x-api-key</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> api_key, </span>
<span id="cb1-22">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">anthropic-version</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"2023-06-01"</span>,</span>
<span id="cb1-23">                <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">content-type</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">`</span> <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"application/json"</span>),</span>
<span id="cb1-24">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">encode =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"json"</span>,</span>
<span id="cb1-25">    <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">body =</span> jsonlite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">toJSON</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(</span>
<span id="cb1-26">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model =</span> model,</span>
<span id="cb1-27">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">max_tokens =</span> max_tokens,</span>
<span id="cb1-28">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">messages =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">list</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">role =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"user"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">content =</span> prompt))</span>
<span id="cb1-29">    ), <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">auto_unbox =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-30"> )</span>
<span id="cb1-31"> content <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> httr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">content</span>(response, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">as=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"text"</span>)</span>
<span id="cb1-32"> json_data <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> jsonlite<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">::</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">fromJSON</span>(content, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">flatten =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb1-33"> response <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> json_data<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>content<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>text</span>
<span id="cb1-34"> </span>
<span id="cb1-35"> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">return</span>(response)</span>
<span id="cb1-36">}</span>
<span id="cb1-37"></span>
<span id="cb1-38">api_key <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">Sys.getenv</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"CLAUDE_API_KEY"</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># api key was stored in the .Renviron file</span></span>
<span id="cb1-39">res <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">prompt_claude</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">prompt=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"The cat sat on the"</span>, api_key, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">model=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"haiku"</span>)</span>
<span id="cb1-40"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(res)</span></code></pre></div>
</div>



 ]]></description>
  <category>LLM</category>
  <category>Claude</category>
  <guid>https://www.jonghoonk.com/blog/posts/claude_api/index.html</guid>
  <pubDate>Wed, 29 May 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/claude_api/anthropic.png" medium="image" type="image/png" height="136" width="144"/>
</item>
<item>
  <title>Learning ChatGPT 2: Approximating a tower function using a neural net</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/index.html</link>
  <description><![CDATA[ 



<p>The <a href="https://writings.stephenwolfram.com/2023/02/what-is-chatgpt-doing-and-why-does-it-work/">blog post by Stephen Wolfram</a> discusses a neural network for approximating some sort of a step function. This post is my attempt to reproduce it. A <a href="https://www.youtube.com/watch?v=Ijqkc7OLenI">YouTube video</a> and a <a href="http://neuralnetworksanddeeplearning.com/chap4.html">book chapter</a> by Michael Nielsen beautifully explain how a neural network can approximate a tower function while explaining the <a href="https://en.wikipedia.org/wiki/Universal_approximation_theorem">Universal Approximation Theorem</a>.</p>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">library</span>(torch)</span>
<span id="cb1-2">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">seq</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">by=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb1-3">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">ifelse</span>(x <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>))</span>
<span id="cb1-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input and output are turned into a 1-column tensor  </span></span>
<span id="cb1-5">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_tensor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(x, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb1-6">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_tensor</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ncol=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb1-7"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/index_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="neural-network" class="level3">
<h3 class="anchored" data-anchor-id="neural-network">Neural network</h3>
<p>One simple way to create a neural network is to use <code>nn_sequential</code> function of the <code>torch</code> package. <a href="https://en.wikipedia.org/wiki/Rectifier_(neural_networks)">Rectified linear unit (ReLU)</a> is used for an activation function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">dim_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-2">dim_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-3">dim_hidden <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb2-4"></span>
<span id="cb2-5">net <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_sequential</span>(</span>
<span id="cb2-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_in, dim_hidden),</span>
<span id="cb2-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_relu</span>(),</span>
<span id="cb2-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_hidden, dim_out)</span>
<span id="cb2-9">)</span></code></pre></div>
</div>
</section>
<section id="traing-a-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="traing-a-neural-network">Traing a neural network</h3>
<p>The <a href="https://arxiv.org/abs/1412.6980">Adam optimizer</a>, which a popular choice, is used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">opt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(net<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters)</span>
<span id="cb3-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># opt &lt;- optim_sgd(net$parameters, lr=0.001)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">num_epochs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb4-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>num_epochs) {</span>
<span id="cb4-3">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb4-4">  loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_mse_loss</span>(y_pred, y)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute loss </span></span>
<span id="cb4-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) { </span>
<span id="cb4-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch: "</span>, epoch, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", Loss: "</span>, loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-7">  }</span>
<span id="cb4-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># back propagation </span></span>
<span id="cb4-9">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb4-10">  loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb4-11">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update weights</span></span>
<span id="cb4-12">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch:  100 , Loss:  0.05918226 
Epoch:  200 , Loss:  0.04266065 
Epoch:  300 , Loss:  0.02848286 
Epoch:  400 , Loss:  0.01916445 
Epoch:  500 , Loss:  0.01608658 
Epoch:  600 , Loss:  0.01477717 
Epoch:  700 , Loss:  0.01393809 
Epoch:  800 , Loss:  0.01333173 
Epoch:  900 , Loss:  0.01286871 
Epoch:  1000 , Loss:  0.01249429 </code></pre>
</div>
</div>
<p>Compare the data and the model predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">ypred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)</span>
<span id="cb6-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L2 loss: %.4f"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((ypred<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L2 loss: 3.7598"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, ypred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>)</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, </span>
<span id="cb8-4">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neural net"</span>), </span>
<span id="cb8-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>), </span>
<span id="cb8-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>),</span>
<span id="cb8-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb8-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, </span>
<span id="cb8-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, </span>
<span id="cb8-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text.col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, </span>
<span id="cb8-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">horiz =</span> F , </span>
<span id="cb8-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/index_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="enlarge-the-neural-network" class="level3">
<h3 class="anchored" data-anchor-id="enlarge-the-neural-network">Enlarge the neural network</h3>
<p>Letâ€™s repeat an experiment using a larger network - more nodes and layers</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">dim_hidden <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb9-2"></span>
<span id="cb9-3">net <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_sequential</span>(</span>
<span id="cb9-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_in, dim_hidden),</span>
<span id="cb9-5">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_relu</span>(),</span>
<span id="cb9-6">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_hidden, dim_hidden),</span>
<span id="cb9-7">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_relu</span>(),</span>
<span id="cb9-8">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_hidden, dim_hidden),</span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_relu</span>(),</span>
<span id="cb9-10">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_hidden, dim_out)</span>
<span id="cb9-11">)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">opt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(net<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">num_epochs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span></span>
<span id="cb11-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span>num_epochs) {</span>
<span id="cb11-3">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb11-4">  loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_mse_loss</span>(y_pred, y)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute loss </span></span>
<span id="cb11-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) { </span>
<span id="cb11-6">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch: "</span>, epoch, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", Loss: "</span>, loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb11-7">  }</span>
<span id="cb11-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># back propagation </span></span>
<span id="cb11-9">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb11-10">  loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb11-11">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update weights</span></span>
<span id="cb11-12">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch:  100 , Loss:  0.02049372 
Epoch:  200 , Loss:  0.005859586 
Epoch:  300 , Loss:  0.00293437 
Epoch:  400 , Loss:  0.001943566 
Epoch:  500 , Loss:  0.001552111 
Epoch:  600 , Loss:  0.001466194 
Epoch:  700 , Loss:  0.00113698 
Epoch:  800 , Loss:  0.001119171 
Epoch:  900 , Loss:  0.0009291215 
Epoch:  1000 , Loss:  0.001042918 </code></pre>
</div>
</div>
<p>Compare the data and the model predictions</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">ypred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sprintf</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"L2 loss: %.4f"</span>, <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((ypred<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "L2 loss: 0.3239"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># png("stepfunc_nn.png")</span></span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(x, y, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">type=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"l"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"X"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Y"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb15-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lines</span>(x, ypred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>)</span>
<span id="cb15-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">legend</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"topright"</span>, </span>
<span id="cb15-5">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">legend=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"data"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"neural net"</span>), </span>
<span id="cb15-6">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"firebrick"</span>), </span>
<span id="cb15-7">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lty=</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"dashed"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"solid"</span>),</span>
<span id="cb15-8">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">lwd=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, </span>
<span id="cb15-9">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">bty =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"n"</span>, </span>
<span id="cb15-10">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">cex =</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, </span>
<span id="cb15-11">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">text.col =</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, </span>
<span id="cb15-12">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">horiz =</span> F , </span>
<span id="cb15-13">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">inset =</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>))</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/index_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dev.off()</span></span></code></pre></div>
</div>


</section>

 ]]></description>
  <category>Neural network</category>
  <category>Adam</category>
  <category>matrix</category>
  <guid>https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/index.html</guid>
  <pubDate>Mon, 27 May 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/learning_ChatGPT_2/stepfunc_nn.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>A very basic implementation of a neural network</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/neural_network_basic/index.html</link>
  <description><![CDATA[ 



<p>I am documenting my learning of a neural network. The contents are mostly based on the <a href="https://skeydan.github.io/Deep-Learning-and-Scientific-Computing-with-R-torch/">e-book</a>.</p>
<p>Load the <code>torch</code> library.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">require</span>(torch)</span></code></pre></div>
</div>
<section id="data" class="level3">
<h3 class="anchored" data-anchor-id="data">Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input dimensionality (number of input features)</span></span>
<span id="cb2-2">dim_in <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span></span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of observations in training set</span></span>
<span id="cb2-4">n <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb2-5"></span>
<span id="cb2-6">x <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(n, dim_in)</span>
<span id="cb2-7">coefs <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>, <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb2-8">y <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">matmul</span>(coefs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">unsqueeze</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(n, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># column matrix</span></span></code></pre></div>
</div>
<p>Weights and biases</p>
<p><img src="https://latex.codecogs.com/png.latex?f(%5Cbf%7BX%7D)=%5Cbf%7BXW%7D+b"></p>
<p>Using two layers with corresponding parameters, <code>w1, b1, w2</code> and <code>b2</code>.</p>
<p><img src="https://latex.codecogs.com/png.latex?f(%5Cbf%7BX%7D)=(%5Cbf%7BXW_1%7D+b_1)%5Cbf%7BW_2%7D+b_2"></p>
<p><code>y_pred &lt;- x$mm(w1)$add(b1)$relu()$mm(w2)$add(b2)</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dimensionality of hidden layer</span></span>
<span id="cb3-2">dim_hidden <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output dimensionality (number of predicted features)</span></span>
<span id="cb3-4">dim_out <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># weights connecting input to hidden layer</span></span>
<span id="cb3-7">w1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(dim_in, dim_hidden, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">requires_grad =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># weights connecting hidden to output layer</span></span>
<span id="cb3-9">w2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_randn</span>(dim_hidden, dim_out, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">requires_grad =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-10"></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># hidden layer bias</span></span>
<span id="cb3-12">b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_zeros</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim_hidden, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">requires_grad =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output layer bias</span></span>
<span id="cb3-14">b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">torch_zeros</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim_out, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">requires_grad =</span> <span class="cn" style="color: #8f5902;
background-color: null;
font-style: inherit;">TRUE</span>)</span></code></pre></div>
</div>
<p>Predicted values from the above network is computed as follows and using Rectified Linear Unit (ReLU) as the activation function</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relu</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b2)</span></code></pre></div>
</div>
<p>Then the loss function can be created as follows</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (y_pred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pow</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>()</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">learning_rate <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span></span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### training loop ----------------------------------------</span></span>
<span id="cb6-4"></span>
<span id="cb6-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb6-6">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### -------- Forward pass --------</span></span>
<span id="cb6-7">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relu</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b2)</span>
<span id="cb6-8">  </span>
<span id="cb6-9">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### -------- Compute loss -------- </span></span>
<span id="cb6-10">  loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> (y_pred <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">pow</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mean</span>()</span>
<span id="cb6-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb6-12">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch: "</span>, epoch, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"   Loss: "</span>, loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb6-13">  </span>
<span id="cb6-14">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### -------- Backpropagation --------</span></span>
<span id="cb6-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute gradient of loss w.r.t. all tensors with</span></span>
<span id="cb6-16">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># requires_grad = TRUE</span></span>
<span id="cb6-17">  loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb6-18">  </span>
<span id="cb6-19">  <span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### -------- Update weights -------- </span></span>
<span id="cb6-20">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Wrap in with_no_grad() because this is a part we don't </span></span>
<span id="cb6-21">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># want to record for automatic gradient computation</span></span>
<span id="cb6-22">   <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">with_no_grad</span>({</span>
<span id="cb6-23">     w1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_</span>(learning_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad)</span>
<span id="cb6-24">     w2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> w2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_</span>(learning_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad)</span>
<span id="cb6-25">     b1 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_</span>(learning_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad)</span>
<span id="cb6-26">     b2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sub_</span>(learning_rate <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad)  </span>
<span id="cb6-27">     </span>
<span id="cb6-28">     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Zero gradients after every pass, as they'd</span></span>
<span id="cb6-29">     <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># accumulate otherwise</span></span>
<span id="cb6-30">     w1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_</span>()</span>
<span id="cb6-31">     w2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_</span>()</span>
<span id="cb6-32">     b1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_</span>()</span>
<span id="cb6-33">     b2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_</span>()  </span>
<span id="cb6-34">   })</span>
<span id="cb6-35">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch:  10    Loss:  3.000276 
Epoch:  20    Loss:  2.144468 
Epoch:  30    Loss:  1.749418 
Epoch:  40    Loss:  1.538223 
Epoch:  50    Loss:  1.413543 
Epoch:  60    Loss:  1.33866 
Epoch:  70    Loss:  1.294799 
Epoch:  80    Loss:  1.265488 
Epoch:  90    Loss:  1.244047 
Epoch:  100    Loss:  1.226817 
Epoch:  110    Loss:  1.212944 
Epoch:  120    Loss:  1.201177 
Epoch:  130    Loss:  1.190159 
Epoch:  140    Loss:  1.178311 
Epoch:  150    Loss:  1.167546 
Epoch:  160    Loss:  1.157191 
Epoch:  170    Loss:  1.147406 
Epoch:  180    Loss:  1.13854 
Epoch:  190    Loss:  1.131134 
Epoch:  200    Loss:  1.123894 </code></pre>
</div>
</div>
<p>Evaluate the model visually</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># png("obs_pred.png")</span></span>
<span id="cb8-2">y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">relu</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">mm</span>(w2)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">add</span>(b2)</span>
<span id="cb8-3"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(y, y_pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted"</span>, </span>
<span id="cb8-4">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural network from scratch"</span>)</span>
<span id="cb8-5"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/neural_network_basic/index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dev.off()</span></span>
<span id="cb9-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_pred))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 224.638</code></pre>
</div>
</div>
<p>The same model can be created in a more compactly way using a sequential module and using the activation function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1">net <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_sequential</span>(</span>
<span id="cb11-2">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_in, dim_hidden),</span>
<span id="cb11-3">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_relu</span>(),</span>
<span id="cb11-4">  <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nn_linear</span>(dim_hidden, dim_out)</span>
<span id="cb11-5">)</span></code></pre></div>
</div>
<p>Train using the <code>Adam</code> optimizer, a popular choice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">opt <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">optim_adam</span>(net<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>parameters)</span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># opt &lt;- optim_sgd(net$parameters, lr=0.001)</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><span class="do" style="color: #5E5E5E;
background-color: null;
font-style: italic;">### training loop --------------------------------------</span></span>
<span id="cb13-2"></span>
<span id="cb13-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> (epoch <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>) {</span>
<span id="cb13-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># forward pass</span></span>
<span id="cb13-5">  y_pred <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)</span>
<span id="cb13-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute loss </span></span>
<span id="cb13-7">  loss <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">nnf_mse_loss</span>(y_pred, y)</span>
<span id="cb13-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> (epoch <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span> <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) { </span>
<span id="cb13-9">    <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cat</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Epoch: "</span>, epoch, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">", Loss: "</span>, loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">item</span>(), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-10">  }</span>
<span id="cb13-11">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># back propagation </span></span>
<span id="cb13-12">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">zero_grad</span>()</span>
<span id="cb13-13">  loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">backward</span>()</span>
<span id="cb13-14">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update weights</span></span>
<span id="cb13-15">  opt<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">step</span>()</span>
<span id="cb13-16">}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch:  10 , Loss:  3.195003 
Epoch:  20 , Loss:  2.957336 
Epoch:  30 , Loss:  2.741568 
Epoch:  40 , Loss:  2.544529 
Epoch:  50 , Loss:  2.363058 
Epoch:  60 , Loss:  2.193356 
Epoch:  70 , Loss:  2.034059 
Epoch:  80 , Loss:  1.885832 
Epoch:  90 , Loss:  1.748948 
Epoch:  100 , Loss:  1.624851 
Epoch:  110 , Loss:  1.513974 
Epoch:  120 , Loss:  1.417417 
Epoch:  130 , Loss:  1.33595 
Epoch:  140 , Loss:  1.269105 
Epoch:  150 , Loss:  1.216185 
Epoch:  160 , Loss:  1.176016 
Epoch:  170 , Loss:  1.147551 
Epoch:  180 , Loss:  1.128549 
Epoch:  190 , Loss:  1.116211 
Epoch:  200 , Loss:  1.108102 </code></pre>
</div>
</div>
<p>Compare the prediction and observation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">y_pred_s <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">net</span>(x)</span>
<span id="cb15-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(y, y_pred, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted"</span>, </span>
<span id="cb15-3">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Neural network: A sequential module"</span>)</span>
<span id="cb15-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/neural_network_basic/index_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean squared error, L2 loss</span></span>
<span id="cb16-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y) <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.numeric</span>(y_pred))<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 221.6205</code></pre>
</div>
</div>
<p>Compared with the linear model</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1">xdf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(x))</span>
<span id="cb18-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(xdf) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x1"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x2"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x3"</span>)</span>
<span id="cb18-3">ydf <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.data.frame</span>(<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">as.matrix</span>(y))</span>
<span id="cb18-4"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">names</span>(ydf) <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">c</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"y"</span>)</span>
<span id="cb18-5">dat <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(xdf, ydf)</span>
<span id="cb18-6">m <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">lm</span>(y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>x1<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>x2<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>x3, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">data=</span>dat)</span>
<span id="cb18-7">y_pred_lm <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">predict</span>(m, xdf)</span>
<span id="cb18-8">ydf2 <span class="ot" style="color: #003B4F;
background-color: null;
font-style: inherit;">&lt;-</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">cbind</span>(ydf, y_pred_lm)</span>
<span id="cb18-9"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">plot</span>(ydf2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ydf2[,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">xlab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Observed"</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">ylab=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted"</span>, </span>
<span id="cb18-10">     <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">main=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Linear regresssion"</span>)</span>
<span id="cb18-11"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">abline</span>(<span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">a=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">b=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">col=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span></code></pre></div>
<div class="cell-output-display">
<p><img src="https://www.jonghoonk.com/blog/posts/neural_network_basic/index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean squared error, L2 loss</span></span>
<span id="cb19-2"><span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">sum</span>((ydf<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">$</span>y <span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_pred_lm)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">^</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 218.2733</code></pre>
</div>
</div>


</section>

 ]]></description>
  <category>GPT-2</category>
  <category>ChatGPT</category>
  <category>Wolfram</category>
  <guid>https://www.jonghoonk.com/blog/posts/neural_network_basic/index.html</guid>
  <pubDate>Sun, 26 May 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/neural_network_basic/obs_pred.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Variables selection in statistical models</title>
  <dc:creator>Jong-Hoon Kim</dc:creator>
  <link>https://www.jonghoonk.com/blog/posts/variable_selection/index.html</link>
  <description><![CDATA[ 



<p>When building statistical models, one of the most critical steps is variable selection. This process involves choosing the appropriate predictors or features that will be included in your model. The goal is to create a model that is both accurate and interpretable, avoiding overfitting and underfitting. Iâ€™ll explore what I am learning regarding issues related to variable selection, the common methods used, and best practices to ensure robust model performance.</p>
<p>The following contents are mainly based on <a href="https://diagnprognres.biomedcentral.com/articles/10.1186/s41512-020-00074-3">the work by Sauebrei et al</a>, which I am learning. As such, the following contents should not be used as a definitive guide to variable selection.</p>
<p>Variable selection should start by defining what kind of model one is developing. The work by Shumeli, <a href="https://www.stat.berkeley.edu/~aldous/157/Papers/shmueli.pdf">To explain or to predict?</a>, discusses that there may be three kinds of statistical models: descriptive, explanatory, and predictive models. The first sentence of its abstract reads, â€œStatistical modeling is a powerful tool for developing and testing theories by way of causal explanation, prediction, and description.â€</p>
<p>Then we can list the variables based on the prior information. In this stage, drawing a directed acyclic graph (DAG) may help.</p>
<p>Once the list is made, one can employ a</p>
<ol type="1">
<li>Forward selection (FS)</li>
<li>Backward elimination (BE)</li>
<li>Stepwise method that combines FS with additional BE. BE method is preferred because we already starts with a plausible model</li>
<li>Best subset selection</li>
</ol>
<p>Different information criteria have been proposed, among which Akaikeâ€™s information criterion (AIC) is in principle preferable for predictive models and Schwartzâ€™s Bayesian information criterion (BIC) for descriptive models.</p>
<ol start="19" type="1">
<li>Burnham KP, Anderson DR. Model selection and multimodel inference: a practical information-theoretic approach. New York: Springer; 2002.</li>
</ol>
<p>true data generating model??</p>
<ol type="1">
<li>Filter Methods: These methods apply statistical measures to assign a score to each feature. Features are ranked by their scores, and the top-ranked ones are selected.</li>
</ol>
<p>Correlation Coefficient: Measures the linear relationship between each feature and the target variable. Features with high correlation (positive or negative) are preferred.</p>
<p>Chi-Square Test: Used for categorical variables, this test assesses whether there is a significant association between the feature and the target variable.</p>
<p>ANOVA F-Value: For continuous variables, the ANOVA F-value tests the null hypothesis that all means are equal.</p>
<ol start="2" type="1">
<li>Wrapper Methods: These methods evaluate feature subsets based on model performance. The main types of wrapper methods include:</li>
</ol>
<p>Forward Selection: Starts with no variables and adds one variable at a time based on model performance improvement.</p>
<p>Backward Elimination: Starts with all variables and removes the least significant variable at each step.</p>
<p>Recursive Feature Elimination (RFE): Builds the model and eliminates the least important feature iteratively until the optimal number of features is reached.</p>
<ol start="3" type="1">
<li>Embedded Methods: These methods perform variable selection during the model training process and are typically specific to certain types of models.</li>
</ol>
<p>LASSO (Least Absolute Shrinkage and Selection Operator): Adds a penalty equal to the absolute value of the magnitude of coefficients. This penalty can shrink some coefficients to zero, effectively performing variable selection.</p>
<p>Ridge Regression: Adds a penalty equal to the square of the magnitude of coefficients. While it doesnâ€™t perform variable selection outright, it can reduce the impact of less important variables.</p>
<p>Tree-Based Methods: Models like Random Forests or Gradient Boosting Trees inherently perform variable selection by considering the importance of variables based on their contribution to reducing impurity or error.</p>
<p>Best Practices for Variable Selection 1. Understand Your Data: Before diving into variable selection techniques, itâ€™s crucial to have a deep understanding of your data. Perform exploratory data analysis (EDA) to identify potential relationships and understand the context of each variable.</p>
<ol start="2" type="1">
<li><p>Use Domain Knowledge: Leverage domain expertise to inform your variable selection process. Certain variables might be inherently more important based on the context of the problem.</p></li>
<li><p>Cross-Validation: Always use cross-validation to assess the performance of your model with the selected variables. This ensures that your modelâ€™s performance is consistent across different subsets of the data.</p></li>
<li><p>Combine Methods: Often, the best approach is to combine multiple methods. For instance, you might start with filter methods to narrow down the field and then use wrapper methods to fine-tune the selection.</p></li>
<li><p>Regularly Re-Evaluate: As new data becomes available or the problem context changes, re-evaluate your variable selection. What was relevant at one time may no longer be the best choice.</p></li>
</ol>
<p>Conclusion Variable selection is a pivotal step in building effective statistical models. By carefully choosing the right variables, you can improve model accuracy, interpretability, and efficiency. Whether using filter methods, wrapper methods, or embedded methods, the key is to balance model complexity with performance. Combining these methods with domain knowledge and cross-validation will ensure that your model is robust and reliable. As data science continues to evolve, so too will the strategies for variable selection, making it an exciting area of ongoing research and application.</p>
<p>Use prior information. Try to draw a directed acyclic graph (DAG)</p>
<ol type="1">
<li>Forward selection (FS)</li>
<li>Backward elimination (BE)</li>
<li>Stepwise method that combines FS with additional BE. BE method is preferred because we already starts with a plausible model</li>
<li>Best subset selection</li>
</ol>
<p>Different information criteria have been proposed, among which Akaikeâ€™s information criterion (AIC) is in principle preferable for predictive models and Schwartzâ€™s Bayesian information criterion (BIC) for descriptive models.</p>
<ol start="19" type="1">
<li>Burnham KP, Anderson DR. Model selection and multimodel inference: a practical information-theoretic approach. New York: Springer; 2002.</li>
</ol>
<p>true data generating model??</p>
<ol start="5" type="1">
<li>Change-in-estimate</li>
<li>Lasso</li>
<li>Elastic net</li>
<li>Boosting - Component-wise boosting is a forward stagewise regression procedure applicable to generalised linear models</li>
<li>Resampling-based: 9.1: bootstrap inclusion frequencies (BIF) 9.2: stability selection</li>
</ol>
<p>Post-selection inference</p>
<p>Since the main aim of descriptive models is the interpretation of the estimated regression coefficients, point estimates should be accompanied by confidence intervals and sometimes also by <img src="https://latex.codecogs.com/png.latex?p"> values.</p>
<p>Generalised additive model (GAM) <a href="https://diagnprognres.biomedcentral.com/articles/10.1186/s41512-020-00074-3">State-of-the-art</a></p>
<p><a href="https://www.stat.berkeley.edu/~aldous/157/Papers/shmueli.pdf">To explain or to predict?</a></p>
<p>Clssic guide to the generalized linear mixed model is <a href="https://www.cell.com/trends/ecology-evolution/abstract/S0169-5347(09)00019-6?mobileUi\u003d0\u0026code\u003dcell-site=">Bolker et al.</a></p>
<p><a href="https://www.frontiersin.org/journals/psychology/articles/10.3389/fpsyg.2021.666182/full">Reporting guidelines for the GLIMM</a></p>
<section id="data-fields" class="level3">
<h3 class="anchored" data-anchor-id="data-fields">Data Fields</h3>
<p>age: Age of the subject age_grp: sex: household size: Number of people living together excluding oneself school/occupation</p>


</section>

 ]]></description>
  <category>R</category>
  <category>variable selection</category>
  <category>generalized linear model</category>
  <guid>https://www.jonghoonk.com/blog/posts/variable_selection/index.html</guid>
  <pubDate>Fri, 17 May 2024 15:00:00 GMT</pubDate>
  <media:content url="https://www.jonghoonk.com/blog/posts/variable_selection/chatgpt.png" medium="image" type="image/png"/>
</item>
</channel>
</rss>
